# 业务类别字段迁移指南

## 概述

本指南说明如何为收费明细表添加 `business_type` 字段，并更新相关的测试数据生成脚本。

## 涉及的文件

### 1. 数据库迁移脚本

- **add_business_type_to_charge_details.sql**: 为收费明细表添加字段
- **update_historical_business_type.sql**: 更新历史数据的业务类别

### 2. 测试数据生成脚本

- **backend/standard_workflow_templates/generate_test_data.py**: 已更新，生成数据时包含业务类别

### 3. 计算流程SQL

- **backend/standard_workflow_templates/step1_dimension_catalog.sql**: 已更新，支持业务类别区分

## 迁移步骤

### 步骤1: 备份数据

在执行任何迁移操作前，务必备份外部数据源数据库：

```bash
# PostgreSQL 备份示例
pg_dump -h <host> -U <user> -d <database> -F c -f backup_$(date +%Y%m%d_%H%M%S).dump
```

### 步骤2: 添加字段

执行迁移脚本，为 `charge_details` 表添加 `business_type` 字段：

```bash
# 连接到外部数据源数据库
psql -h <host> -U <user> -d <database> -P pager=off -f add_business_type_to_charge_details.sql
```

**预期输出**：
```
NOTICE:  表 charge_details 存在，开始检查字段...
NOTICE:  ✅ 已添加字段 business_type
NOTICE:  ✅ 已创建索引 idx_charge_details_business_type
NOTICE:  ✅ 已添加字段注释
NOTICE:  ✅ 验证成功: 字段 business_type 存在
NOTICE:  ✅ 验证成功: 索引 idx_charge_details_business_type 存在
```

### 步骤3: 更新历史数据（可选）

如果有历史数据需要填充业务类别，根据实际业务规则修改并执行更新脚本：

```bash
# 1. 编辑 update_historical_business_type.sql
# 2. 根据实际业务规则取消注释相应的UPDATE语句
# 3. 执行更新
psql -h <host> -U <user> -d <database> -P pager=off -f update_historical_business_type.sql
```

**更新策略建议**：

#### 方案1: 根据就诊类型（推荐）

如果收费明细表有 `visit_type` 字段：

```sql
UPDATE charge_details 
SET business_type = '门诊'
WHERE business_type IS NULL
AND visit_type IN ('门诊', '急诊', '体检');

UPDATE charge_details 
SET business_type = '住院'
WHERE business_type IS NULL
AND visit_type IN ('住院', '留观');
```

#### 方案2: 根据收费项目

根据收费项目名称判断：

```sql
UPDATE charge_details 
SET business_type = '门诊'
WHERE business_type IS NULL
AND (
    item_name LIKE '%门诊%'
    OR item_name LIKE '%挂号%'
    OR item_name LIKE '%诊察%'
);

UPDATE charge_details 
SET business_type = '住院'
WHERE business_type IS NULL
AND (
    item_name LIKE '%床位%'
    OR item_name LIKE '%住院%'
);
```

#### 方案3: 根据科室

根据科室类型判断：

```sql
UPDATE charge_details 
SET business_type = '门诊'
WHERE business_type IS NULL
AND prescribing_dept_code IN ('门诊部', '急诊科', '体检中心');

UPDATE charge_details 
SET business_type = '住院'
WHERE business_type IS NULL
AND prescribing_dept_code IN ('内科病区', '外科病区', 'ICU');
```

### 步骤4: 验证迁移结果

执行验证查询：

```sql
-- 查看业务类别分布
SELECT 
    business_type,
    COUNT(*) as record_count,
    SUM(amount) as total_amount,
    ROUND(COUNT(*)::NUMERIC / SUM(COUNT(*)) OVER () * 100, 2) as percentage
FROM charge_details
GROUP BY business_type
ORDER BY business_type NULLS FIRST;

-- 检查是否有空值
SELECT COUNT(*) as null_count
FROM charge_details
WHERE business_type IS NULL;
```

### 步骤5: 生成新的测试数据

使用更新后的脚本生成包含业务类别的测试数据：

```bash
# 激活 conda 环境
& 'C:\software\anaconda3\shell\condabin\conda-hook.ps1'
conda activate hospital-backend

# 生成测试数据
cd backend
python standard_workflow_templates/generate_test_data.py \
    --hospital-id 1 \
    --period 2025-11 \
    --record-count 1000 \
    --patient-count 100
```

**新功能**：
- 自动为每条记录生成业务类别（70%门诊，30%住院）
- 验证时按业务类别分组显示统计信息

### 步骤6: 测试计算流程

运行计算任务，验证业务类别区分是否正常工作：

```bash
# 1. 在前端创建计算任务
# 2. 选择医疗机构和周期
# 3. 运行标准计算流程
# 4. 查看报表，验证门诊和住院数据是否正确分离
```

## 验证清单

- [ ] 字段添加成功（`business_type` 字段存在）
- [ ] 索引创建成功（`idx_charge_details_business_type` 存在）
- [ ] 历史数据已更新（如有需要）
- [ ] 新测试数据包含业务类别
- [ ] 计算流程正确区分门诊和住院
- [ ] 报表显示正确

## 常见问题

### Q1: 迁移脚本执行失败

**A**: 检查以下几点：
1. 数据库连接是否正常
2. 用户是否有 ALTER TABLE 权限
3. 表名是否正确（区分大小写）

### Q2: 历史数据无法准确判断业务类别

**A**: 建议：
1. 咨询业务人员，了解实际业务规则
2. 导出部分数据样本，人工标注后总结规则
3. 如果无法准确判断，可以保持为空，在报表中单独处理

### Q3: 测试数据生成失败

**A**: 检查：
1. Python 环境是否正确激活
2. 数据库连接配置是否正确
3. 是否有足够的科室和收费项目数据

### Q4: 计算结果不符合预期

**A**: 排查步骤：
1. 使用 `test-business-type-logic.sql` 验证维度层级结构
2. 检查收费明细数据的业务类别分布
3. 查看计算日志，确认SQL执行是否正常
4. 验证维度-收费项目映射是否正确

## 回滚方案

如果迁移出现问题，可以回滚：

```sql
-- 删除字段
ALTER TABLE charge_details DROP COLUMN IF EXISTS business_type;

-- 删除索引
DROP INDEX IF EXISTS idx_charge_details_business_type;

-- 恢复备份（如果需要）
pg_restore -h <host> -U <user> -d <database> -c backup_YYYYMMDD_HHMMSS.dump
```

## 后续维护

1. **新数据录入**：确保新插入的收费明细数据包含 `business_type` 字段
2. **数据质量监控**：定期检查业务类别为空的记录数量
3. **业务规则更新**：如果业务规则变化，及时更新判断逻辑

## 相关文档

- [业务类别区分方案.md](业务类别区分方案.md) - 技术方案说明
- [业务类别区分实施总结.md](业务类别区分实施总结.md) - 实施总结
- [科室业务价值评估数据集.md](科室业务价值评估数据集.md) - 数据集规范
