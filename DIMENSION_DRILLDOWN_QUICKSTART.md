# 维度下钻功能快速指南

## 功能说明

在业务价值明细报表中，用户可以点击末级维度查看组成该维度的收费项目明细（年月、科室代码、科室名称、项目编码、项目名称、金额、数量）。

**当前支持范围**：医生序列中按维度目录计算的末级维度（排除病例价值维度）

## 使用步骤

### 1. 查看报告详情

1. 登录系统
2. 进入"报告查看"页面
3. 点击某个报告的"查看详情"按钮

### 2. 下钻查看明细

1. 在"科室主业价值分布"表格中，找到想要下钻的维度
2. 点击该维度行的"下钻"按钮
3. 弹出对话框显示该维度的收费项目明细
4. 查看明细数据和汇总信息

### 3. 明细数据说明

下钻对话框显示以下信息：

**表格列**：
- 年月：计算周期
- 科室代码：开单科室代码
- 科室名称：开单科室名称
- 项目编码：收费项目编码
- 项目名称：收费项目名称
- 金额：该项目的总金额（元）
- 数量：该项目的总数量

**汇总信息**：
- 总金额：所有项目的金额合计
- 总数量：所有项目的数量合计

## 限制说明

### 支持的维度

✅ **支持**：
- 医生序列的末级维度
- 例如：普通诊察、检查化验、丁级手术等

❌ **不支持**：
- 病例价值维度（因为不是按收费项目计算）
- 护理序列维度（待扩展）
- 医技序列维度（待扩展）
- 非末级维度（有子维度的维度）

### 数据要求

下钻功能需要以下数据：
1. 该科室该月份有完成的计算任务
2. 存在维度与收费项目的映射关系
3. 存在该科室该月份的收费明细数据

## 错误提示

| 提示信息 | 原因 | 解决方法 |
|---------|------|---------|
| 仅支持医生序列中按维度目录计算的末级维度下钻 | 点击了非医生序列的维度 | 选择医生序列的维度 |
| 该维度不是末级维度，无法下钻 | 点击了有子维度的维度 | 选择叶子节点维度 |
| 未找到该维度与收费项目的映射关系 | 缺少映射配置 | 在维度项目映射中配置 |
| 未找到该科室该月份该维度的收费明细数据 | 无收费数据 | 检查数据源配置 |

## 测试验证

### 后端测试

运行测试脚本：
```bash
python test_dimension_drilldown.py
```

测试内容：
1. 登录认证
2. 创建/获取测试报告
3. 获取价值分布数据
4. 测试下钻前两个维度
5. 验证明细数据和汇总信息

### 前端测试

1. 启动前端开发服务器
2. 登录系统
3. 进入"报告查看"页面
4. 点击报告详情
5. 在价值分布表格中点击"下钻"按钮
6. 验证对话框显示正确

## API 接口

### 获取维度下钻明细

**请求**：
```
GET /api/v1/analysis-reports/{report_id}/dimension-drilldown/{node_id}
```

**请求头**：
```
Authorization: Bearer {token}
X-Hospital-ID: {hospital_id}
```

**响应**：
```json
{
  "dimension_name": "普通诊察",
  "items": [
    {
      "period": "2025-10",
      "department_code": "BNZ",
      "department_name": "白内障专科",
      "item_code": "128100329",
      "item_name": "门诊诊查费",
      "amount": 92242.0000,
      "quantity": 5426.0000
    }
  ],
  "total_amount": 144499.0000,
  "total_quantity": 10170.0000,
  "message": null
}
```

## 实现文件

### 后端
- `backend/app/schemas/analysis_report.py` - Schema 定义
- `backend/app/api/analysis_reports.py` - API 接口

### 前端
- `frontend/src/api/analysis-reports.ts` - API 调用
- `frontend/src/components/ReportDetailModal.vue` - 详情模态框

### 测试
- `test_dimension_drilldown.py` - 功能测试脚本
- `create_test_report.py` - 创建测试报告

## 扩展计划

### 短期（1-2周）
- [ ] 支持护理序列维度下钻
- [ ] 支持医技序列维度下钻
- [ ] 添加导出功能（Excel）

### 中期（1个月）
- [ ] 添加筛选和排序功能
- [ ] 支持多级下钻（非叶子节点）
- [ ] 添加可视化图表

### 长期（3个月）
- [ ] 对比分析（不同月份/科室）
- [ ] 趋势分析
- [ ] 异常检测和提醒

## 常见问题

### Q1: 为什么有些维度没有"下钻"按钮？

A: 只有医生序列的末级维度才显示下钻按钮。病例价值维度和非叶子节点不支持下钻。

### Q2: 下钻数据为空怎么办？

A: 检查以下几点：
1. 该科室该月份是否有计算任务完成
2. 维度与收费项目是否有映射关系
3. 是否有该科室该月份的收费明细数据

### Q3: 下钻数据与价值分布数据不一致？

A: 这是正常的。价值分布数据来自 calculation_results 表（经过权重计算），下钻数据来自 charge_details 表（原始收费数据）。

### Q4: 如何添加护理序列的下钻支持？

A: 修改后端 API 的维度类型判断逻辑，将 `dim-nur-` 开头的维度也纳入支持范围。

## 技术支持

如有问题，请查看：
- 详细实现文档：`DIMENSION_DRILLDOWN_IMPLEMENTATION.md`
- 测试脚本：`test_dimension_drilldown.py`
- API 文档：后端 Swagger UI (`/docs`)
