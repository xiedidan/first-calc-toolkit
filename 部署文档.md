# 医院科室业务价值评估工具 - 部署文档

> **文档版本**: 1.0
> **创建日期**: 2025-10-21
> **适用环境**: Windows 10/11 + WSL2 + Docker Desktop + Anaconda

---

## 1. 文档说明

本文档提供两种部署方案：

- **开发环境部署**（方案A）：适用于日常开发调试，前后端在Windows本地运行，数据库和Redis在Docker容器中运行
- **生产环境部署**（方案B）：适用于生产环境或集成测试，所有服务都在Docker容器中运行

---

## 2. 环境要求

### 2.1. 已安装的环境

- ✅ Windows 10/11
- ✅ WSL2 + Ubuntu
- ✅ Docker Desktop（已启用WSL2集成）
- ✅ Anaconda（用于Python环境管理）

### 2.2. 验证环境

在PowerShell中执行：

```powershell
# 验证WSL2
wsl --list --verbose

# 验证Docker
docker --version
docker-compose --version

# 验证Anaconda
conda --version
```

---

## 3. 开发环境部署（方案A）

### 3.1. 部署架构

**服务分布**：
- **数据库（PostgreSQL）**：Docker容器
- **缓存（Redis）**：Docker容器
- **后端（FastAPI）**：Windows本地（Anaconda环境）
- **任务队列（Celery）**：Windows本地（Anaconda环境）
- **前端（Vue.js）**：Windows本地（Node.js）

**优点**：
- 代码修改即时生效，无需重启容器
- 可以直接使用Windows的IDE进行调试
- 支持断点调试
- 性能好，无虚拟化开销

### 3.2. 部署步骤

详见下文的具体配置文件和启动脚本。

---

## 4. 生产环境部署（方案B）

### 4.1. 部署架构

**服务分布**：
- **数据库（PostgreSQL）**：Docker容器
- **缓存（Redis）**：Docker容器
- **后端（FastAPI）**：Docker容器
- **任务队列（Celery）**：Docker容器
- **前端（Nginx + Vue.js）**：Docker容器

**优点**：
- 环境一致性好
- 接近生产环境
- 便于团队协作和部署
- 一键启动所有服务

### 4.2. 部署步骤

详见下文的具体配置文件。

---

## 5. 项目目录结构

```
first-calc-toolkit/
├── backend/                    # 后端代码
│   ├── app/                   # 应用代码
│   │   ├── __init__.py
│   │   ├── main.py           # FastAPI主入口
│   │   ├── config.py         # 配置文件
│   │   ├── database.py       # 数据库连接
│   │   ├── celery_app.py     # Celery配置
│   │   ├── models/           # 数据模型
│   │   ├── schemas/          # Pydantic模型
│   │   ├── api/              # API路由
│   │   ├── services/         # 业务逻辑
│   │   └── utils/            # 工具函数
│   ├── alembic/              # 数据库迁移
│   ├── tests/                # 测试代码
│   ├── requirements.txt      # Python依赖
│   ├── .env.dev             # 开发环境配置
│   ├── .env.prod            # 生产环境配置
│   └── Dockerfile           # 生产环境Docker镜像
├── frontend/                  # 前端代码
│   ├── src/                  # 源代码
│   ├── public/               # 静态资源
│   ├── package.json          # Node依赖
│   ├── vite.config.ts        # Vite配置
│   ├── nginx.conf            # Nginx配置（生产环境）
│   └── Dockerfile            # 生产环境Docker镜像
├── scripts/                   # 启动脚本
│   ├── dev-start-backend.ps1     # 启动后端（开发）
│   ├── dev-start-celery.ps1      # 启动Celery（开发）
│   ├── dev-start-frontend.ps1    # 启动前端（开发）
│   ├── dev-start-all.ps1         # 启动所有服务（开发）
│   └── dev-stop-all.ps1          # 停止所有服务（开发）
├── docker-compose.dev.yml     # 开发环境Docker配置
├── docker-compose.prod.yml    # 生产环境Docker配置
├── .gitignore
├── README.md
├── 需求文档.md
├── 系统设计文档.md
├── API设计文档.md
└── 部署文档.md
```

---

## 6. 开发环境配置文件

### 6.1. Docker Compose配置（开发环境）

**文件路径**: `docker-compose.dev.yml`

**说明**: 仅启动数据库和Redis，后端和前端在Windows本地运行。

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: hospital_postgres
    environment:
      POSTGRES_DB: hospital_value
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - hospital_network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: hospital_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - hospital_network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  hospital_network:
    driver: bridge
```

### 6.2. 后端依赖配置

**文件路径**: `backend/requirements.txt`

```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
alembic==1.12.1
pydantic==2.5.0
pydantic-settings==2.1.0
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
celery==5.3.4
redis==5.0.1
openpyxl==3.1.2
pandas==2.1.3
```

### 6.3. 后端环境配置

**文件路径**: `backend/.env.dev`

```env
# 数据库配置
DATABASE_URL=postgresql://admin:admin123@localhost:5432/hospital_value

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT配置
SECRET_KEY=your-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# 应用配置
APP_NAME=医院科室业务价值评估工具
APP_VERSION=1.0.0
DEBUG=True

# Celery配置
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

### 6.4. 前端Vite配置

**文件路径**: `frontend/vite.config.ts`

```typescript
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

---

## 7. 生产环境配置文件

### 7.1. Docker Compose配置（生产环境）

**文件路径**: `docker-compose.prod.yml`

**说明**: 所有服务都在Docker容器中运行。

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: hospital_postgres
    environment:
      POSTGRES_DB: hospital_value
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - hospital_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: hospital_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - hospital_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hospital_backend
    environment:
      DATABASE_URL: postgresql://admin:admin123@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: your-secret-key-change-in-production
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    networks:
      - hospital_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hospital_celery
    environment:
      DATABASE_URL: postgresql://admin:admin123@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    volumes:
      - ./backend:/app
    networks:
      - hospital_network
    depends_on:
      - postgres
      - redis
    command: celery -A app.celery worker --loglevel=info

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: hospital_frontend
    ports:
      - "80:80"
    networks:
      - hospital_network
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:

networks:
  hospital_network:
    driver: bridge
```

### 7.2. 后端Dockerfile

**文件路径**: `backend/Dockerfile`

```dockerfile
FROM python:3.12-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令（由docker-compose覆盖）
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 7.3. 前端Dockerfile

**文件路径**: `frontend/Dockerfile`

```dockerfile
# 构建阶段
FROM node:18-alpine as build

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=build /app/dist /usr/share/nginx/html

# 复制nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 7.4. Nginx配置

**文件路径**: `frontend/nginx.conf`

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7.5. 后端环境配置（生产）

**文件路径**: `backend/.env.prod`

```env
# 数据库配置
DATABASE_URL=postgresql://admin:admin123@postgres:5432/hospital_value

# Redis配置
REDIS_URL=redis://redis:6379/0

# JWT配置
SECRET_KEY=your-production-secret-key-change-this
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# 应用配置
APP_NAME=医院科室业务价值评估工具
APP_VERSION=1.0.0
DEBUG=False

# Celery配置
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0
```

---

## 8. 启动脚本

### 8.1. 开发环境启动脚本

详见下文创建的PowerShell脚本文件。

### 8.2. 生产环境启动

```powershell
# 启动所有服务
docker-compose -f docker-compose.prod.yml up -d --build

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f

# 停止服务
docker-compose -f docker-compose.prod.yml down
```

---

## 9. VS Code配置建议

### 9.1. 安装推荐扩展

- Python
- Pylance
- Vue Language Features (Volar)
- TypeScript Vue Plugin (Volar)
- ESLint
- Prettier
- Docker
- Remote - WSL

### 9.2. 配置WSL集成

1. 安装"Remote - WSL"扩展
2. 按F1，输入"WSL: Connect to WSL"
3. 在WSL中打开项目文件夹

### 9.3. 工作区配置

**文件路径**: `.vscode/settings.json`

```json
{
  "python.defaultInterpreterPath": "${workspaceFolder}/backend/venv/bin/python",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": true,
  "python.formatting.provider": "black",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  },
  "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter"
  },
  "[vue]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

**文件路径**: `.vscode/launch.json`

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: FastAPI",
      "type": "python",
      "request": "launch",
      "module": "uvicorn",
      "args": [
        "app.main:app",
        "--reload",
        "--host",
        "0.0.0.0",
        "--port",
        "8000"
      ],
      "jinja": true,
      "justMyCode": true,
      "cwd": "${workspaceFolder}/backend"
    },
    {
      "name": "Python: Celery Worker",
      "type": "python",
      "request": "launch",
      "module": "celery",
      "args": [
        "-A",
        "app.celery",
        "worker",
        "--loglevel=info",
        "--pool=solo"
      ],
      "cwd": "${workspaceFolder}/backend"
    }
  ]
}
```

---

## 10. 常用命令速查

### Docker相关

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器日志
docker logs -f <container_name>

# 进入容器
docker exec -it <container_name> bash

# 重启容器
docker restart <container_name>

# 停止所有容器
docker stop $(docker ps -q)

# 删除所有停止的容器
docker container prune
```

### PostgreSQL相关

```bash
# 连接数据库
docker exec -it hospital_postgres psql -U admin -d hospital_value

# 备份数据库
docker exec hospital_postgres pg_dump -U admin hospital_value > backup.sql

# 恢复数据库
docker exec -i hospital_postgres psql -U admin hospital_value < backup.sql
```

### Redis相关

```bash
# 连接Redis
docker exec -it hospital_redis redis-cli

# 查看所有键
docker exec hospital_redis redis-cli KEYS '*'

# 清空数据库
docker exec hospital_redis redis-cli FLUSHDB
```

---

## 11. 故障排查

### 11.1. Docker Desktop无法启动

**问题**：Docker Desktop启动失败

**解决方案**：
1. 确保WSL2已正确安装
2. 以管理员身份运行PowerShell，执行：
```powershell
wsl --update
wsl --set-default-version 2
```
3. 重启Docker Desktop

### 11.2. 端口被占用

**问题**：端口5432或6379已被占用

**解决方案**：
```powershell
# 查看端口占用
netstat -ano | findstr :5432

# 结束进程
taskkill /PID <PID> /F
```

### 11.3. Celery在Windows上无法启动

**问题**：Celery worker启动报错

**解决方案**：
使用 `--pool=solo` 参数：
```bash
celery -A app.celery worker --loglevel=info --pool=solo
```

### 11.4. 数据库连接失败

**问题**：后端无法连接数据库

**解决方案**：
1. 检查PostgreSQL容器是否运行：`docker ps`
2. 检查连接字符串是否正确
3. 在Windows上使用 `localhost`，在容器中使用服务名 `postgres`

---

## 12. 快速开始

### 12.1. 开发环境快速启动

```powershell
# 1. 启动数据库和Redis
docker-compose -f docker-compose.dev.yml up -d

# 2. 使用启动脚本启动所有服务
.\scripts\dev-start-all.ps1

# 3. 访问应用
# 前端：http://localhost:3000
# 后端API文档：http://localhost:8000/docs
```

### 12.2. 生产环境快速启动

```powershell
# 一键启动所有服务
docker-compose -f docker-compose.prod.yml up -d --build

# 访问应用
# 前端：http://localhost:80
```

---

## 13. 下一步

部署完成后，你可以：

1. 初始化数据库表结构（使用Alembic迁移）
2. 创建初始管理员用户
3. 开始开发具体功能模块
