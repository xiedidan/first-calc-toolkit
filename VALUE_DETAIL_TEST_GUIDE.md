# 业务价值明细表测试指南

## 测试前准备

1. 确保后端服务正在运行
2. 确保前端服务正在运行
3. 确保数据库中有计算任务和结果数据

## 测试步骤

### 1. 测试数据结构（后端）

运行测试脚本验证数据结构是否正确：

```bash
python backend/test_new_detail_structure.py
```

**预期结果**：
- 医生序列显示18行数据（包含所有节点）
- 医技序列显示7行数据（包含所有节点）
- 末级维度显示完整信息（工作量、全院业务价值、业务导向等）
- 非末级维度只显示汇总信息（工作量、金额、占比），其他列显示"-"

### 2. 测试API接口

使用以下命令测试API接口：

```bash
# 查看汇总数据
curl -X GET "http://localhost:8000/api/calculation/results/summary?period=2024-10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 查看明细数据
curl -X GET "http://localhost:8000/api/calculation/results/detail?dept_id=1&task_id=TASK_ID" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期结果**：
- 返回JSON格式的数据
- 包含 `doctor`、`nurse`、`tech` 三个数组
- 每个数组包含对应序列的所有节点数据

### 3. 测试前端页面

1. 访问业务价值报表页面：`http://localhost:5173/results`
2. 选择评估月份
3. 点击某个科室的"查看明细"按钮

**预期结果**：
- 弹出明细对话框
- 显示三个Tab：医生序列、护理序列、医技序列
- 每个Tab显示对应序列的维度结构
- 表格列包括：维度层级、工作量、全院业务价值、业务导向、科室业务价值、金额、占比

### 4. 验证数据正确性

检查以下内容：

#### 末级维度
- ✅ 工作量有值
- ✅ 全院业务价值有数值（权重/单价）
- ✅ 业务导向有文字说明
- ✅ 科室业务价值有数值
- ✅ 金额有值
- ✅ 占比有值

#### 非末级维度
- ✅ 工作量有值（子维度之和）
- ✅ 全院业务价值显示"-"
- ✅ 业务导向显示"-"
- ✅ 科室业务价值显示"-"
- ✅ 金额有值（子维度之和）
- ✅ 占比有值

### 5. 验证维度层级

#### 医生序列（3级结构）
- 一级维度：门诊、住院
- 二级维度：门诊诊察、门诊诊断、门诊治疗、住院诊察等
- 三级维度：普通诊察、会诊、MDT多方总绩效等

#### 护理序列（3级结构）
- 一级维度：护理工作量、护理质量
- 二级维度：基础护理、专科护理等
- 三级维度：具体护理项目

#### 医技序列（2级结构）
- 一级维度：检验、影像
- 二级维度：常规检验、特殊检验、X光、CT、MRI等

## 常见问题

### 问题1：数据为空

**原因**：没有计算任务或计算结果
**解决**：先创建计算任务并等待完成

### 问题2：维度层级不对

**原因**：模型结构与实际数据不匹配
**解决**：检查模型版本管理中的模型结构

### 问题3：非末级维度显示了业务价值

**原因**：后端逻辑判断错误
**解决**：检查 `is_leaf` 判断逻辑

### 问题4：占比计算不正确

**原因**：占比计算逻辑错误
**解决**：检查计算任务中的占比计算逻辑

## 性能测试

测试大数据量情况：
- 科室数量：50+
- 维度数量：100+
- 计算结果数量：5000+

**预期结果**：
- 页面加载时间 < 3秒
- 明细对话框打开时间 < 1秒
- 表格渲染流畅，无卡顿

## 回归测试

确保以下功能仍然正常：
- ✅ 汇总表显示正常
- ✅ 筛选条件工作正常
- ✅ 导出功能正常（待实现）
- ✅ 分页功能正常
- ✅ 排序功能正常

## 测试完成标准

- [ ] 所有测试步骤通过
- [ ] 数据正确性验证通过
- [ ] 维度层级验证通过
- [ ] 性能测试通过
- [ ] 回归测试通过
- [ ] 无明显bug或错误
