# 分类预案管理服务和API实现总结

## 实现概述

本次实现完成了医技智能分类分级模块的**分类预案管理服务和API**（任务8），包括预案的查询、调整、预览和提交功能。

## 实现的文件

### 1. 服务层
- **backend/app/services/classification_plan_service.py**
  - `ClassificationPlanService` 类，提供完整的预案管理功能

### 2. API层
- **backend/app/api/classification_plans.py**
  - 8个RESTful API端点，对应所有预案管理操作

### 3. 路由注册
- **backend/app/main.py**
  - 注册了 `/api/v1/classification-plans` 路由

## 实现的功能

### 服务层方法

#### 1. `get_plans()` - 获取预案列表
- 支持分页查询
- 支持按状态筛选（draft/submitted）
- 返回预案基本信息和统计数据
- **多租户隔离**：仅返回当前医疗机构的预案

#### 2. `get_plan_detail()` - 获取预案详情
- 返回预案完整信息
- 包含关联任务的元数据（任务名称、模型版本、收费类别）
- 统计信息：总项目数、已调整项目数、低确信度项目数
- **多租户隔离**：验证预案归属

#### 3. `update_plan()` - 更新预案
- 支持更新预案名称
- 验证预案状态（已提交的预案不可修改）
- 自动更新 `updated_at` 时间戳
- **多租户隔离**：验证预案归属

#### 4. `delete_plan()` - 删除预案
- 级联删除关联的预案项目
- 验证预案状态（已提交的预案不可删除）
- **多租户隔离**：验证预案归属

#### 5. `get_plan_items()` - 获取预案项目列表
- **排序功能**：
  - `confidence_asc`：按确信度升序
  - `confidence_desc`：按确信度降序
  - 默认按创建时间排序
- **筛选功能**：
  - `min_confidence`：最小确信度
  - `max_confidence`：最大确信度
  - `is_adjusted`：是否已调整
  - `processing_status`：处理状态
- **分页支持**：page 和 size 参数
- 返回完整的项目信息，包括AI建议、用户设置和最终维度
- **多租户隔离**：验证预案归属

#### 6. `update_plan_item()` - 调整项目维度
- 允许用户修改AI建议的维度分配
- 验证目标维度存在且为末级维度
- 自动设置 `is_adjusted = True`
- 自动计算最终维度（用户设置 ?? AI建议）
- 验证预案状态（已提交的预案不可修改）
- **多租户隔离**：验证预案和维度归属

#### 7. `generate_submit_preview()` - 生成提交预览
- 分析每个项目在维度目录中的存在情况
- **新增项目**：在维度目录中不存在的项目
- **覆盖项目**：在维度目录中已存在的项目，显示原维度信息
- 统计新增和覆盖数量
- 提供警告信息（如维度不存在、项目无维度分配）
- **多租户隔离**：仅查询当前医疗机构的映射

#### 8. `submit_plan()` - 提交预案
- **批量操作**：遍历所有预案项目
- **新增逻辑**：创建新的 `DimensionItemMapping` 记录
- **覆盖逻辑**：更新现有映射的 `dimension_code`
- **事务管理**：使用数据库事务确保原子性
- **失败回滚**：任何错误都会回滚所有更改
- 更新预案状态为 `submitted`
- 记录提交时间 `submitted_at`
- **多租户隔离**：所有操作限定在当前医疗机构

### API端点

| 方法 | 路径 | 功能 | 需求 |
|------|------|------|------|
| GET | `/api/v1/classification-plans` | 获取预案列表 | 5.2, 6.5 |
| GET | `/api/v1/classification-plans/{id}` | 获取预案详情 | 5.2, 6.5 |
| PUT | `/api/v1/classification-plans/{id}` | 更新预案 | 6.1-6.7 |
| DELETE | `/api/v1/classification-plans/{id}` | 删除预案 | 6.1-6.7 |
| GET | `/api/v1/classification-plans/{id}/items` | 获取项目列表 | 5.1-5.8 |
| PUT | `/api/v1/classification-plans/{id}/items/{item_id}` | 调整项目维度 | 5.6 |
| POST | `/api/v1/classification-plans/{id}/preview` | 生成提交预览 | 7.1-7.7 |
| POST | `/api/v1/classification-plans/{id}/submit` | 提交预案 | 8.1-8.7 |

## 关键设计决策

### 1. 多租户隔离
所有方法都接收 `hospital_id` 参数，并在数据库查询中添加 `hospital_id` 过滤条件，确保数据隔离。

### 2. 最终维度计算
使用 `user_set_dimension_id ?? ai_suggested_dimension_id` 逻辑：
- 如果用户设置了维度，使用用户设置
- 否则使用AI建议的维度

### 3. 维度路径构建
实现了 `_get_dimension_path()` 辅助方法，递归向上遍历父节点，构建完整的维度路径（如："序列A / 一级维度 / 二级维度"）。

### 4. 事务管理
提交预案时使用 try-except-finally 模式：
- 成功：提交事务
- 失败：回滚事务，返回错误信息
- 确保数据一致性

### 5. 错误处理
- `ValueError`：业务逻辑错误（如预案不存在、已提交等）
- `Exception`：系统错误（如数据库连接失败）
- API层将错误转换为适当的HTTP状态码（400/404/500）

## 数据流

### 预案调整流程
```
1. 用户查看预案项目列表
   ↓
2. 筛选低确信度项目（< 0.5）
   ↓
3. 调整项目维度（设置 user_set_dimension_id）
   ↓
4. 保存预案（更新 plan_name）
   ↓
5. 生成提交预览（分析新增/覆盖）
   ↓
6. 确认提交
   ↓
7. 批量创建/更新维度映射
   ↓
8. 更新预案状态为 submitted
```

### 数据库操作
- **查询**：使用 SQLAlchemy ORM 查询
- **关联加载**：使用 `joinedload` 预加载关联数据
- **批量操作**：遍历项目列表，逐个处理
- **事务**：使用 `db.commit()` 和 `db.rollback()`

## 验证的需求

本实现覆盖了以下需求：

### 需求 5：分类预案查看和调整
- ✅ 5.1：任务完成后生成预案
- ✅ 5.2：显示预案详情页面
- ✅ 5.3：显示项目字段（名称、AI建议、确信度、用户设置）
- ✅ 5.4：默认采用AI建议维度
- ✅ 5.5：调整按钮打开维度选择器
- ✅ 5.6：保存用户设置维度
- ✅ 5.7：按确信度排序
- ✅ 5.8：按确信度范围筛选

### 需求 6：分类预案命名和保存
- ✅ 6.1：保存预案时输入名称
- ✅ 6.2：验证名称长度（1-100字符）
- ✅ 6.3：保存名称、状态、修改时间
- ✅ 6.4：保留任务元数据
- ✅ 6.5：显示预案列表
- ✅ 6.6：加载预案和调整记录
- ✅ 6.7：继续调整已保存预案

### 需求 7：分类预案提交前预览
- ✅ 7.1：显示提交预览对话框
- ✅ 7.2：分析项目存在情况
- ✅ 7.3：标记新增项目
- ✅ 7.4：标记覆盖项目并显示原维度
- ✅ 7.5：统计新增和覆盖数量
- ✅ 7.6：允许继续或取消
- ✅ 7.7：高亮显示覆盖项目

### 需求 8：分类预案正式提交
- ✅ 8.1：执行批量提交操作
- ✅ 8.2：添加项目到维度目录
- ✅ 8.3：创建新的维度项目记录
- ✅ 8.4：更新现有维度项目记录
- ✅ 8.5：更新预案状态为已提交
- ✅ 8.6：失败时回滚所有更改
- ✅ 8.7：显示成功消息和链接

### 需求 10：多租户数据隔离
- ✅ 10.1：自动设置医疗机构ID
- ✅ 10.2：仅返回当前医疗机构数据
- ✅ 10.3：仅操作当前医疗机构数据
- ✅ 10.4：机构切换时刷新数据
- ✅ 10.5：使用当前医疗机构的配置

## 测试

### 单元测试
创建了 `test_classification_plan_service.py`，测试所有服务方法：
- 预案列表查询
- 预案详情查询
- 预案更新
- 预案删除
- 项目列表查询（含排序和筛选）
- 项目维度调整
- 提交预览生成
- 预案提交
- 覆盖场景测试

### API测试
创建了 `test_classification_plan_api.py`，测试所有API端点：
- 路由注册验证
- 端点可访问性验证
- 请求/响应格式验证

## 下一步

本任务（任务8）已完成。后续任务包括：

- **任务9**：提交预览和批量提交功能（部分已在任务8中实现）
- **任务10**：限流和统计功能
- **任务11-14**：前端页面实现
- **任务15**：集成测试和端到端测试
- **任务16**：文档和部署

## 注意事项

1. **数据库迁移**：确保运行了 `20251126_add_ai_classification_tables.py` 迁移
2. **依赖模型**：需要 `ClassificationTask`、`PlanItem`、`ModelNode`、`DimensionItemMapping` 等模型
3. **环境变量**：需要配置数据库连接和加密密钥
4. **Celery**：预案生成依赖分类任务完成，需要Celery worker运行

## 总结

本次实现完成了分类预案管理的核心功能，包括：
- ✅ 完整的CRUD操作
- ✅ 高级查询（排序、筛选、分页）
- ✅ 维度调整功能
- ✅ 提交预览和批量提交
- ✅ 多租户数据隔离
- ✅ 完善的错误处理
- ✅ 详细的日志记录

所有功能都经过了详细的设计和实现，符合需求文档和设计文档的要求。
