# 收费项目管理功能设计

## 设计概述

收费项目管理（费用目录管理）是系统的基础数据管理模块，用于管理HIS系统的收费项目目录。这些收费项目将被用于维度目录配置，是模型计算的基础数据。

## 功能定位

收费项目管理服务作为独立的模块，位于模型管理和维度目录管理之间：

```
收费项目管理 → 维度目录管理 → 模型计算
```

- **收费项目管理**: 维护HIS系统的收费项目基础数据
- **维度目录管理**: 将收费项目关联到模型的维度节点
- **模型计算**: 基于维度目录进行业务价值计算

## 核心功能

### 1. 收费项目CRUD
- **列表查询**: 支持分页、搜索、排序
- **创建项目**: 添加新的收费项目
- **更新项目**: 修改项目信息（编码不可修改）
- **删除项目**: 删除未被引用的项目

### 2. 搜索与筛选
- **关键词搜索**: 按项目编码、名称、分类搜索
- **分类筛选**: 按项目分类筛选
- **排序功能**: 支持按多个字段排序

### 3. 批量操作
- **批量导入**: 从Excel批量导入收费项目
- **批量导出**: 导出收费项目为Excel文件

## 数据模型

### charge_items 表结构

| 字段名 | 类型 | 约束 | 说明 |
|---|---|---|---|
| id | SERIAL | PRIMARY KEY | 主键 |
| item_code | VARCHAR(100) | UNIQUE, NOT NULL | 收费项目编码 |
| item_name | VARCHAR(255) | NOT NULL | 收费项目名称 |
| item_category | VARCHAR(100) | NULL | 收费项目分类 |
| unit_price | VARCHAR(50) | NULL | 单价 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 索引设计
- `PRIMARY KEY (id)`
- `UNIQUE INDEX (item_code)`
- `INDEX (item_category)` - 用于分类筛选

## API设计

### 基础路径
`/api/v1/charge-items`

### 接口列表

#### 1. GET /charge-items
获取收费项目列表

**查询参数**:
- `page`: 页码（默认1）
- `size`: 每页数量（默认10）
- `keyword`: 搜索关键词
- `item_category`: 分类筛选
- `sort_by`: 排序字段（默认item_code）
- `sort_order`: 排序方向（asc/desc）

**响应**:
```json
{
  "total": 100,
  "items": [
    {
      "id": 1,
      "item_code": "CK001",
      "item_name": "血常规",
      "item_category": "检验",
      "unit_price": "25.00",
      "created_at": "2025-10-22T10:00:00",
      "updated_at": "2025-10-22T10:00:00"
    }
  ]
}
```

#### 2. POST /charge-items
创建收费项目

**请求体**:
```json
{
  "item_code": "CK001",
  "item_name": "血常规",
  "item_category": "检验",
  "unit_price": "25.00"
}
```

#### 3. GET /charge-items/{id}
获取收费项目详情

#### 4. PUT /charge-items/{id}
更新收费项目信息

**请求体**:
```json
{
  "item_name": "血常规检查",
  "item_category": "检验",
  "unit_price": "28.00"
}
```

**注意**: item_code 不可修改

#### 5. DELETE /charge-items/{id}
删除收费项目

**限制**: 如果项目已被维度目录引用，将无法删除

#### 6. POST /charge-items/import
批量导入收费项目

**请求**: multipart/form-data
- `file`: Excel文件

**Excel格式**:
| 项目编码 | 项目名称 | 项目分类 | 单价 |
|---|---|---|---|
| CK001 | 血常规 | 检验 | 25.00 |
| CK002 | 尿常规 | 检验 | 15.00 |

**响应**:
```json
{
  "success_count": 18,
  "failed_count": 2,
  "failed_items": [
    {
      "row": 5,
      "item_code": "CK005",
      "reason": "项目编码已存在"
    }
  ]
}
```

#### 7. POST /charge-items/export
导出收费项目

**请求体**:
```json
{
  "keyword": "血",
  "item_category": "检验"
}
```

**响应**: Excel文件流

## 前端页面设计

### 页面布局

```
┌─────────────────────────────────────────────────┐
│ 收费项目管理                    [新建] [导入] [导出] │
├─────────────────────────────────────────────────┤
│ 搜索: [_______] 分类: [____▼] [查询] [重置]      │
├─────────────────────────────────────────────────┤
│ 项目编码 │ 项目名称 │ 分类 │ 单价 │ 创建时间 │ 操作 │
│ CK001   │ 血常规   │ 检验 │ 25.00│ 2025-... │ 编辑 删除│
│ CK002   │ 尿常规   │ 检验 │ 15.00│ 2025-... │ 编辑 删除│
├─────────────────────────────────────────────────┤
│ 共 100 条  [<] [1] [2] [3] [>]                  │
└─────────────────────────────────────────────────┘
```

### 功能组件

#### 1. 搜索栏
- 关键词输入框（支持项目编码、名称搜索）
- 分类下拉选择框
- 查询按钮
- 重置按钮

#### 2. 操作按钮
- 新建项目：打开创建对话框
- 批量导入：上传Excel文件
- 导出：下载Excel文件

#### 3. 数据表格
- 显示收费项目列表
- 支持列排序
- 行操作：编辑、删除

#### 4. 分页组件
- 显示总数
- 页码切换
- 每页数量选择

### 对话框设计

#### 新建/编辑对话框
```
┌─────────────────────────────┐
│ 新建收费项目          [×]    │
├─────────────────────────────┤
│ 项目编码: [_____________]   │
│ 项目名称: [_____________]   │
│ 项目分类: [_____________]   │
│ 单价:     [_____________]   │
├─────────────────────────────┤
│           [取消]  [确定]     │
└─────────────────────────────┘
```

#### 导入对话框
```
┌─────────────────────────────┐
│ 批量导入收费项目      [×]    │
├─────────────────────────────┤
│ 选择文件: [选择文件]         │
│                             │
│ 格式说明:                   │
│ - Excel文件(.xlsx)          │
│ - 第一行为表头              │
│ - 必填: 项目编码、项目名称   │
├─────────────────────────────┤
│ [下载模板]    [取消] [导入]  │
└─────────────────────────────┘
```

## 业务规则

### 1. 数据验证
- **项目编码**: 必填，唯一，最长100字符
- **项目名称**: 必填，最长255字符
- **项目分类**: 可选，最长100字符
- **单价**: 可选，字符串格式（支持小数）

### 2. 删除限制
- 检查是否被维度目录引用
- 如果被引用，提示"该项目已被维度目录引用，无法删除"
- 建议先删除维度目录中的关联，再删除项目

### 3. 导入规则
- 项目编码重复：跳过该行，记录失败原因
- 必填字段缺失：跳过该行，记录失败原因
- 格式错误：跳过该行，记录失败原因
- 导入完成后显示成功和失败统计

### 4. 编码不可修改
- 创建后项目编码不可修改
- 编辑对话框中项目编码字段禁用
- 如需修改编码，需删除后重新创建

## 数据来源

### 理想方案：HIS系统同步
- 定期从HIS系统同步收费项目数据
- 保持与HIS系统的数据一致性
- 支持增量同步和全量同步

### 当前方案：手动维护
- 通过界面手动创建和维护
- 支持Excel批量导入
- 适用于初期或小规模使用

## 与其他模块的关系

### 1. 维度目录管理
- 维度目录管理依赖收费项目数据
- 在配置维度目录时，从收费项目表中选择
- 删除收费项目时需检查维度目录引用

### 2. 模型计算
- 模型计算通过维度目录间接使用收费项目
- 收费项目的分类可能影响计算逻辑
- 单价信息可用于成本分析

## 实现优先级

### P0 - 核心功能（必须）
- ✅ 数据模型已创建
- ⬜ 基础CRUD API
- ⬜ 列表查询（分页、搜索、排序）
- ⬜ 前端页面和表单

### P1 - 增强功能（重要）
- ⬜ 批量导入（Excel）
- ⬜ 批量导出（Excel）
- ⬜ 删除前引用检查

### P2 - 优化功能（可选）
- ⬜ 分类管理（独立的分类维护）
- ⬜ 导入模板下载
- ⬜ 导入预览功能
- ⬜ 数据统计（按分类统计数量）

## 测试要点

### 功能测试
1. 创建收费项目（正常、异常）
2. 编辑收费项目（正常、编码不可改）
3. 删除收费项目（正常、被引用）
4. 搜索功能（关键词、分类）
5. 排序功能（各字段升降序）
6. 分页功能（翻页、改变每页数量）
7. 批量导入（正常、格式错误、重复）
8. 批量导出（全部、筛选后）

### 性能测试
1. 大数据量列表查询（10000+条）
2. 批量导入性能（1000+条）
3. 搜索响应时间

### 安全测试
1. 权限控制（只有管理员可操作）
2. SQL注入防护
3. XSS防护
4. 文件上传安全（类型、大小限制）

## 后续优化方向

1. **HIS系统集成**: 自动同步收费项目数据
2. **版本管理**: 记录收费项目的历史变更
3. **审计日志**: 记录所有操作日志
4. **数据校验**: 更严格的数据格式校验
5. **智能分类**: 基于项目名称自动推荐分类
6. **使用统计**: 统计收费项目在维度目录中的使用情况

## 相关文档

- **API设计文档**: 第4章 - 收费项目管理服务 API
- **系统设计文档**: 3.3节 - 收费项目管理服务
- **数据库设计**: charge_items 表结构
