# 维度目录导入 - 配置变更自动刷新优化

## 📋 问题描述

用户修改"跳过前N行"配置后，虽然会重新解析文件，但字段映射选项没有正确更新，仍然显示旧的表头（可能是空列）。

## ✅ 解决方案

### 1. 优化解析逻辑

修改 `handleParse` 方法，在每次解析后自动更新字段映射：

```typescript
const handleParse = async (showMessage = true) => {
  // ... 解析文件 ...
  
  // 自动更新字段映射为建议的映射
  fieldMapping.value = {
    item_code: result.suggested_mapping.item_code || '',
    dimension_plan: result.suggested_mapping.dimension_plan || '',
    expert_opinion: result.suggested_mapping.expert_opinion || ''
  }
  
  // 只在初次上传时显示成功消息
  if (showMessage) {
    ElMessage.success('文件解析成功')
  }
}
```

### 2. 配置变更处理

```typescript
const handleSheetChange = () => {
  // Sheet改变时重新解析（不显示消息）
  handleParse(false)
}

const handleSkipRowsChange = () => {
  // 跳过行数改变时重新解析（不显示消息）
  handleParse(false)
}
```

### 3. 移除冗余的Watch

之前使用 watch 监听 `suggested_mapping` 的变化，现在直接在 `handleParse` 中处理，避免重复更新。

## 🔄 工作流程

### 场景1：初次上传文件

```
1. 用户上传文件
   ↓
2. 调用 handleParse(true)
   ↓
3. 解析文件（跳过0行）
   ↓
4. 更新 parseResult
   ↓
5. 更新 fieldMapping（使用建议的映射）
   ↓
6. 显示"文件解析成功"消息
   ↓
7. 用户看到表头和字段映射选项
```

### 场景2：修改跳过行数

```
1. 用户修改"跳过前N行"为 3
   ↓
2. 触发 @change 事件
   ↓
3. 调用 handleSkipRowsChange()
   ↓
4. 调用 handleParse(false)
   ↓
5. 重新解析文件（跳过3行）
   ↓
6. 更新 parseResult（新的表头）
   ↓
7. 更新 fieldMapping（新的建议映射）
   ↓
8. 不显示消息（避免干扰）
   ↓
9. 用户看到更新后的表头和字段映射选项
```

### 场景3：切换Sheet

```
1. 用户选择不同的Sheet
   ↓
2. 触发 @change 事件
   ↓
3. 调用 handleSheetChange()
   ↓
4. 调用 handleParse(false)
   ↓
5. 重新解析文件（新的Sheet）
   ↓
6. 更新 parseResult（新的表头）
   ↓
7. 更新 fieldMapping（新的建议映射）
   ↓
8. 不显示消息
   ↓
9. 用户看到新Sheet的表头和字段映射选项
```

## 📊 效果展示

### 示例：修改跳过行数

**初始状态（跳过0行）**：
```
Excel文件：
第1行: (空) | (空) | (空) | (空)  ← 表头
第2行: CK001 | 血常规 | 检验项目 | 4D

字段映射选项：
- (空列-A)
- (空列-B)
- (空列-C)
- (空列-D)
```

**修改为跳过3行后**：
```
Excel文件：
第1行: 医院名称                    ← 跳过
第2行: 报表标题                    ← 跳过
第3行: 生成日期                    ← 跳过
第4行: 收费编码 | 收费名称 | 维度预案 | 专家意见  ← 表头
第5行: CK001 | 血常规 | 检验项目 | 4D

字段映射选项（自动更新）：
- 收费编码 (A)  ← 自动选中为"收费编码"
- 收费名称 (B)
- 维度预案 (C)  ← 自动选中为"维度预案"
- 专家意见 (D)  ← 自动选中为"专家意见"
```

## 💡 用户体验提升

1. **自动刷新**：修改配置后立即看到效果
2. **智能映射**：自动识别并填充字段映射
3. **减少干扰**：配置变更时不显示重复的成功消息
4. **即时反馈**：表头和预览数据同步更新
5. **减少操作**：不需要手动重新选择字段映射

## ⚠️ 注意事项

1. **字段映射重置**：
   - 每次重新解析都会重置字段映射
   - 使用智能建议自动填充
   - 用户可以手动调整

2. **消息提示**：
   - 初次上传：显示"文件解析成功"
   - 配置变更：不显示消息（避免干扰）
   - 错误情况：始终显示错误消息

3. **性能考虑**：
   - 每次配置变更都会重新解析文件
   - 对于大文件可能需要几秒钟
   - 已实现loading状态提示

## 🧪 测试建议

### 测试用例1：初次上传
- 上传文件
- 验证表头显示正确
- 验证字段映射自动填充

### 测试用例2：修改跳过行数
- 上传文件
- 修改跳过行数
- 验证表头自动更新
- 验证字段映射自动更新
- 验证不显示重复消息

### 测试用例3：切换Sheet
- 上传多Sheet文件
- 切换Sheet
- 验证表头自动更新
- 验证字段映射自动更新

### 测试用例4：多次修改
- 连续修改跳过行数
- 验证每次都正确更新
- 验证loading状态正常

## ✨ 总结

本次优化解决了配置变更后表头不刷新的问题：
- ✅ 自动刷新表头和字段映射
- ✅ 智能填充建议的映射
- ✅ 减少重复的消息提示
- ✅ 提升用户体验
- ✅ 保持数据一致性

用户现在可以自由调整配置，系统会自动刷新所有相关内容，无需手动操作！
