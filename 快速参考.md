# 业务类别区分 - 快速参考

## 一键迁移（推荐）

### Windows
```powershell
.\migrate_business_type.ps1 -Host localhost -User admin -Database hospital_external_data
```

### Linux/Mac
```bash
./migrate_business_type.sh localhost admin hospital_external_data
```

## 手动迁移

### 1. 添加字段
```bash
psql -h localhost -U admin -d hospital_external_data -P pager=off -f add_business_type_to_charge_details.sql
```

### 2. 更新历史数据（可选）
```bash
# 先编辑 update_historical_business_type.sql，根据业务规则取消注释相应的UPDATE语句
psql -h localhost -U admin -d hospital_external_data -P pager=off -f update_historical_business_type.sql
```

### 3. 生成测试数据
```bash
# 激活环境
& 'C:\software\anaconda3\shell\condabin\conda-hook.ps1'
conda activate hospital-backend

# 生成数据
cd backend
python standard_workflow_templates/generate_test_data.py --hospital-id 1 --period 2025-11 --record-count 1000
```

### 4. 验证维度结构
```bash
& "C:\software\PostgreSQL\18\bin\psql.exe" -h localhost -U admin -d hospital_value -P pager=off -f test-business-type-logic.sql
```

## 业务类别判断规则

| 维度路径 | 业务类别 |
|---------|---------|
| 医生序列/门诊/... | 门诊 |
| 医生序列/住院/... | 住院 |
| 医生序列/手术/门诊/... | 门诊 |
| 医生序列/手术/住院/... | 住院 |
| 护理序列/病区/... | 住院 |
| 护理序列/非病区/... | 门诊 |
| 医技序列/... | 不区分 |

## 验证查询

### 查看业务类别分布
```sql
SELECT 
    business_type,
    COUNT(*) as record_count,
    SUM(amount) as total_amount
FROM charge_details
GROUP BY business_type;
```

### 查看维度业务类别
```sql
-- 使用 test-business-type-logic.sql 中的查询
```

### 查看计算结果
```sql
SELECT 
    mn.name as dimension_name,
    d.his_name as department_name,
    cr.workload,
    cr.value
FROM calculation_results cr
INNER JOIN model_nodes mn ON cr.node_id = mn.id
INNER JOIN departments d ON cr.department_id = d.id
WHERE cr.task_id = 'your_task_id'
ORDER BY mn.name, d.his_name;
```

## 常用命令

### 备份数据库
```bash
pg_dump -h localhost -U admin -d hospital_external_data -F c -f backup_$(date +%Y%m%d_%H%M%S).dump
```

### 恢复数据库
```bash
pg_restore -h localhost -U admin -d hospital_external_data -c backup_YYYYMMDD_HHMMSS.dump
```

### 删除字段（回滚）
```sql
ALTER TABLE charge_details DROP COLUMN IF EXISTS business_type;
DROP INDEX IF EXISTS idx_charge_details_business_type;
```

## 文档索引

- **方案说明**: `业务类别区分方案.md`
- **实施总结**: `业务类别区分实施总结.md`
- **迁移指南**: `业务类别字段迁移指南.md`
- **完成清单**: `业务类别迁移完成清单.md`
- **数据集规范**: `科室业务价值评估数据集.md`

## 故障排查

### 问题1: 字段添加失败
- 检查数据库连接
- 检查用户权限
- 查看错误日志

### 问题2: 计算结果不正确
- 验证维度层级结构（test-business-type-logic.sql）
- 检查收费明细的 business_type 分布
- 查看计算任务日志

### 问题3: 测试数据生成失败
- 检查 Python 环境
- 检查数据库连接配置
- 确认有足够的科室和收费项目数据

## 联系支持

如有问题，请查阅详细文档或联系技术支持。
