# 医生业务价值计算流程 - 映射修复总结

## 问题描述

任务 `1e0a6392-e0d7-4932-96f3-c1f1cb00b620` (2025-10) 执行后结果"全0"，只有少量手术类数据。

## 问题根因

**dimension_item_mappings表中缺少门诊项目的映射关系**

### 映射覆盖率（修复前）

| 业务类型 | 记录覆盖率 | 金额覆盖率 | 说明 |
|---------|-----------|-----------|------|
| 门诊 | 0.71% | 50.83% | 几乎所有门诊项目都未映射 |
| 住院 | 40.00% | 83.45% | 部分住院项目已映射 |

### 未映射的高价值项目（TOP 10）

| 项目名称 | 使用次数 | 总金额 | 应映射维度 |
|---------|---------|--------|-----------|
| 门诊诊查费 | 47,321 | 773,143元 | 普通诊察 |
| OCT检查(右眼) | 4,702 | 272,100元 | 检查化验 |
| OCT检查(左眼) | 4,701 | 271,620元 | 检查化验 |
| 双眼视功能训练 | 259 | 227,000元 | 检查化验 |
| 脑力影像训练 | 240 | 225,000元 | 检查化验 |
| 彩色照片 | 21,587 | 195,832元 | 检查化验 |
| 思然(药品) | 3,965 | 162,574元 | 中草药 |
| 图文报告 | 23,073 | 161,720元 | 检查化验 |
| 专家门诊(正高) | 12,907 | 100,632元 | 普通诊察 |
| 施图伦(药品) | 1,832 | 93,677元 | 中草药 |

**未映射总金额**：355万元（占门诊总额的23%）

## 解决方案

### 1. 创建映射规则

基于项目名称关键词自动创建映射：

#### 普通诊察 (dim-doc-out-diag-norm)
- 关键词：门诊诊查费、挂号、专家门诊、特需门诊、名医门诊
- 创建映射：10个项目

#### 检查化验 (dim-doc-out-eval-exam)
- 关键词：OCT、视网膜厚度检查、图文报告、照片、影像、检查、化验、训练系统
- 创建映射：46个项目

#### 中草药/药品 (dim-doc-out-eval-drug)
- 关键词：滴眼液、眼膏、眼药、片、胶囊
- 创建映射：196个项目

### 2. 执行映射创建

```bash
python create_doctor_dimension_mappings.py
```

**结果**：
- ✓ 总计创建了 252 个映射
- ✓ 门诊记录覆盖率：0.71% → 79.51%
- ✓ 门诊金额覆盖率：50.83% → 89.20%

### 映射覆盖率（修复后）

| 业务类型 | 记录覆盖率 | 金额覆盖率 | 已映射记录 | 已映射金额 |
|---------|-----------|-----------|-----------|-----------|
| 门诊 | 79.51% | 89.20% | 370,957 / 466,580 | 1,397万 / 1,567万 |

## 验证步骤

### 1. 清理旧数据并重置任务

```sql
DELETE FROM calculation_results WHERE task_id = '1e0a6392-e0d7-4932-96f3-c1f1cb00b620';
DELETE FROM calculation_step_logs WHERE task_id = '1e0a6392-e0d7-4932-96f3-c1f1cb00b620';
UPDATE calculation_tasks 
SET status = 'pending', progress = 0, started_at = NULL, completed_at = NULL, error_message = NULL 
WHERE task_id = '1e0a6392-e0d7-4932-96f3-c1f1cb00b620';
```

### 2. 重新执行任务

在前端「计算任务管理」中找到任务 `1e0a6392-e0d7-4932-96f3-c1f1cb00b620`，点击「重新执行」。

### 3. 查看结果

```sql
-- 查看各维度的统计结果
SELECT 
    node_code,
    node_name,
    COUNT(DISTINCT department_id) as dept_count,
    SUM(workload) as total_workload,
    SUM(value) as total_value
FROM calculation_results
WHERE task_id = '1e0a6392-e0d7-4932-96f3-c1f1cb00b620'
GROUP BY node_code, node_name
ORDER BY total_value DESC;

-- 查看各科室的统计结果
SELECT 
    d.his_name,
    COUNT(*) as dimension_count,
    SUM(cr.value) as total_value
FROM calculation_results cr
JOIN departments d ON cr.department_id = d.id
WHERE cr.task_id = '1e0a6392-e0d7-4932-96f3-c1f1cb00b620'
GROUP BY d.his_name
ORDER BY total_value DESC;
```

## 预期效果

修复后应该能看到：

1. **门诊-诊察类维度**有数据（门诊诊查费等）
2. **门诊-检查化验类维度**有数据（OCT、图文报告等）
3. **门诊-药品类维度**有数据（各种滴眼液、眼膏等）
4. **总价值**应该从92万提升到约1000万以上

## 相关文件

- `analyze_doctor_mapping_gap.py` - 映射缺口分析脚本
- `create_doctor_dimension_mappings.py` - 批量创建映射脚本
- `DOCTOR_WORKFLOW_IMPLEMENTATION.md` - 流程实现文档

## 后续优化建议

### 1. 完善映射规则

剩余10.8%的金额未映射，可以继续优化：
- 分析未映射项目的特征
- 添加更多关键词规则
- 或在前端手动添加映射

### 2. 住院项目映射

住院项目的映射也需要完善：
- 住院诊察类项目
- 住院诊断类项目（检查、药品）
- 住院治疗类项目

### 3. 治疗类维度映射

目前只映射了诊察和诊断类，还需要添加：
- 门诊治疗类项目（甲乙丙级治疗）
- 住院治疗类项目

### 4. 自动化映射

考虑开发自动映射功能：
- 基于项目名称的智能分类
- 机器学习模型预测维度
- 批量导入映射模板

## 时间线

- **2025-12-05 23:12** - 发现问题（任务结果全0）
- **2025-12-05 23:30** - 分析根因（映射缺失）
- **2025-12-05 23:45** - 创建252个映射
- **2025-12-05 23:50** - 重置任务，等待重新执行

## 总结

问题的根本原因是**数据准备不足**，而非计算流程本身的问题。医生业务价值计算流程的SQL逻辑是正确的，但需要完整的dimension_item_mappings映射数据作为基础。

通过批量创建映射，门诊数据的覆盖率从不到1%提升到近80%，预计任务重新执行后将产生完整的计算结果。
