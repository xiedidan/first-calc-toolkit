# 报表显示全0问题 - 已解决

## 问题原因

报表查询逻辑从 `calculation_results` 表中查找 `node_type = 'sequence'` 的记录来计算汇总数据，但是：

1. **Step1 和 Step2** 只插入了维度（dimension）节点的数据
2. **Step3 原来的设计** 是将汇总数据插入到 `calculation_summaries` 表
3. **报表查询** 却从 `calculation_results` 表读取序列节点

导致报表找不到序列数据，所有价值显示为 0。

## 解决方案

修改 Step3 的 SQL，让它将序列节点的汇总数据插入到 `calculation_results` 表，而不是 `calculation_summaries` 表。

### 修改内容

**原来的 Step3（错误）：**
```sql
-- 插入到 calculation_summaries 表
INSERT INTO calculation_summaries (
    task_id, department_id, doctor_value, nurse_value, tech_value, ...
)
SELECT ...
```

**修改后的 Step3（正确）：**
```sql
-- 插入到 calculation_results 表
INSERT INTO calculation_results (
    task_id, node_id, department_id, node_type, node_name, 
    node_code, parent_id, workload, weight, value, created_at
)
SELECT 
    '{task_id}' as task_id,
    agg.node_id,
    agg.department_id,
    ms.node_type,
    agg.node_name,
    ms.code as node_code,
    ms.parent_id,
    0 as workload,
    ms.weight,
    agg.score as value,
    NOW() as created_at
FROM aggregated_scores agg
INNER JOIN model_structure ms ON agg.node_id = ms.node_id
WHERE ms.node_type = 'sequence'
  AND agg.score > 0;
```

## 已执行的操作

1. ✅ 修改了 `backend/standard_workflow_templates/step3_value_aggregation.sql`
2. ✅ 更新了数据库中 workflow_id=20 的 Step3
3. ✅ 为现有任务 `124694a7-3f17-4ff3-831e-5e7efb6febe2` 补充了序列数据

## 验证结果

```
node_type | count
------------------------------
dimension | 846
sequence  | 66
```

序列数据示例：
```
node_id | dept_id | node_name | value
------------------------------------------------------------
1       | 3       | 医生      | 13400.0000
29      | 3       | 护理      | 793203.6000
1       | 4       | 医生      | 5000.0000
29      | 4       | 护理      | 868959.0000
```

## 数据流程

```
Step1: 维度目录统计
  └─> 插入维度节点到 calculation_results
       (node_type = 'dimension')

Step2: 指标计算
  └─> 插入更多维度节点到 calculation_results
       (node_type = 'dimension')

Step3: 业务价值汇总
  └─> 从 calculation_results 读取维度数据
  └─> 递归汇总到序列节点
  └─> 插入序列节点到 calculation_results
       (node_type = 'sequence')

报表查询:
  └─> 从 calculation_results 读取序列节点
  └─> 递归汇总子维度
  └─> 按科室和序列类型（医生/护理/医技）分类显示
```

## 后续任务

对于新的计算任务，只需要正常执行 Step1 → Step2 → Step3，报表就能正常显示数据。

对于已有的旧任务（只执行了 Step1 和 Step2），可以运行 `补充序列数据.py` 脚本来补充序列数据。
