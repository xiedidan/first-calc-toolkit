# 模型管理优化更新

> **更新日期**: 2025-10-22  
> **版本**: v1.1

---

## 🎯 优化内容

### 1. 增加节点排序功能

**新增字段**: `sort_order` (排序序号)

**功能说明**:
- 用于控制同级节点的显示顺序
- 支持小数，方便插入排序
- 自动按排序序号升序显示
- 创建节点时自动设置为最大值+1

**使用方式**:
- 在节点编辑表单中设置"排序序号"
- 数值越小，显示越靠前
- 支持手动调整顺序

### 2. 增加末级维度标识

**新增字段**: `is_leaf` (是否为末级维度)

**功能说明**:
- 明确标识哪些节点是末级维度（叶子节点）
- 只有末级维度才需要配置权重、业务导向、计算脚本
- 非末级节点只是容器，用于组织结构

**业务规则**:
1. **末级维度不能添加子节点**
   - 如果节点被标记为末级，"添加子节点"按钮禁用
   - 尝试添加时会提示错误

2. **有子节点的不能设为末级**
   - 如果节点已有子节点，不能勾选"是否末级维度"
   - 开关会被禁用，并显示提示信息

3. **只有末级维度显示配置项**
   - 计算类型
   - 权重/单价
   - 业务导向
   - 计算脚本

---

## 📊 数据库变更

### 新增字段

```sql
-- model_nodes 表
ALTER TABLE model_nodes 
ADD COLUMN sort_order NUMERIC(10,2) DEFAULT 0 NOT NULL;

ALTER TABLE model_nodes 
ADD COLUMN is_leaf BOOLEAN DEFAULT FALSE NOT NULL;

-- 创建索引
CREATE INDEX ix_model_nodes_sort_order ON model_nodes(sort_order);
```

---

## 🔄 执行迁移

### 步骤1: 执行数据库迁移

```bash
cd backend
python -m alembic upgrade head
```

或双击 `fix-and-migrate.bat`

### 步骤2: 重启后端服务

在后端窗口按 `Ctrl+C`，然后重新运行：
```bash
.\scripts\dev-start-backend.ps1
```

### 步骤3: 刷新前端

刷新浏览器页面

---

## 🎨 界面变化

### 节点列表

新增列：
- **排序** - 显示排序序号
- **末级维度** - 显示是否为末级

### 节点编辑表单

新增字段：
- **排序序号** - 数字输入框
- **是否末级维度** - 开关控件

条件显示：
- 只有勾选"是否末级维度"后，才显示：
  - 计算类型
  - 权重/单价
  - 业务导向
  - 计算脚本

### 操作按钮

- 末级维度的"添加子节点"按钮禁用
- 鼠标悬停显示提示："末级维度不能添加子节点"

---

## 📝 使用示例

### 示例1: 创建序列节点

```
节点名称: 医生序列
节点编码: DOCTOR
节点类型: 序列
排序序号: 1
是否末级维度: 否 (不勾选)
```

### 示例2: 创建末级维度

```
节点名称: 门诊诊察
节点编码: OUTPATIENT
节点类型: 维度
排序序号: 1
是否末级维度: 是 (勾选)
计算类型: 统计型
权重/单价: 0.3
业务导向: 门诊工作量统计
计算脚本: SELECT ...
```

### 示例3: 创建中间层维度

```
节点名称: 诊疗活动
节点编码: DIAGNOSIS
节点类型: 维度
排序序号: 1
是否末级维度: 否 (不勾选)
```

然后在"诊疗活动"下添加子节点：
- 门诊诊察 (末级)
- 住院诊察 (末级)

---

## ⚠️ 注意事项

### 1. 排序规则

- 排序序号支持小数（如 1.5）
- 相同排序序号按创建时间排序
- 建议使用整数（1, 2, 3...）

### 2. 末级维度规则

- 末级维度 = 叶子节点 = 需要配置权重和脚本的节点
- 非末级维度 = 容器节点 = 只用于组织结构
- 一旦标记为末级，不能再添加子节点
- 有子节点的不能标记为末级

### 3. 数据迁移

- 现有节点的 `sort_order` 默认为 0
- 现有节点的 `is_leaf` 默认为 false
- 需要手动调整现有节点的配置

---

## 🐛 常见问题

### Q1: 为什么不能勾选"是否末级维度"？

**A**: 该节点已有子节点，不能设为末级。需要先删除所有子节点。

### Q2: 为什么不能添加子节点？

**A**: 该节点已被标记为末级维度，不能添加子节点。需要先取消"是否末级维度"。

### Q3: 排序序号如何设置？

**A**: 
- 数值越小，显示越靠前
- 建议使用整数：1, 2, 3...
- 如需插入，可使用小数：1, 1.5, 2

### Q4: 非末级维度需要配置权重吗？

**A**: 不需要。非末级维度只是容器，不参与计算。只有末级维度才需要配置权重、业务导向和脚本。

---

## 🎉 优化效果

### 1. 更清晰的结构

- 明确区分容器节点和计算节点
- 减少不必要的配置项
- 提高数据准确性

### 2. 更灵活的排序

- 支持自定义显示顺序
- 方便调整节点位置
- 提升用户体验

### 3. 更严格的验证

- 防止错误配置
- 保证数据一致性
- 减少使用错误

---

## 📚 相关文档

- [模型管理完整文档](./MODEL_VERSION_COMPLETED.md)
- [前端实现文档](./MODEL_FRONTEND_COMPLETED.md)
- [迁移指南](./MIGRATION_GUIDE.md)

---

**更新时间**: 2025-10-22  
**状态**: ✅ 已完成
