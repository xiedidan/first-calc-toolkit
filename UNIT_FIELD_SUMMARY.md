# 模型节点单位字段 - 功能总结

## 📌 需求
为模型结构添加一个单位字段，默认是 `%`，但允许用户自己填入，如 `元/例`。

## ✅ 实现状态
**已完成** - 所有功能已实现并可以使用

## 🎯 功能说明

### 1. 字段定义
- **字段名**: `unit`
- **数据类型**: `String(20)`
- **默认值**: `%`
- **是否必填**: 否（可选）
- **适用范围**: 末级维度节点

### 2. 使用场景
不同类型的绩效指标可以使用不同的单位：

| 指标类型 | 单位示例 | 说明 |
|---------|---------|------|
| 比率指标 | `%` | 默认值，如门诊人次占比 |
| 成本指标 | `元/例`、`元/人天` | 如平均住院费用 |
| 计数指标 | `次`、`人`、`例` | 如门诊人次 |
| 时间指标 | `天`、`小时` | 如平均住院天数 |

### 3. 界面展示

#### 列表显示
在"权重/单价"列中显示：
```
100.00 元/例
65.5 %
7.5 天
```

#### 编辑表单
- 仅在节点为"末级维度"时显示单位输入框
- 输入框占位符：`如: %, 元/例, 元/人天`
- 如果不填写，自动使用默认值 `%`

## 📁 涉及的文件

### 后端文件
```
backend/
├── app/
│   ├── models/
│   │   └── model_node.py          # ✅ 已添加 unit 字段
│   ├── schemas/
│   │   └── model_node.py          # ✅ 已添加 unit 字段
│   └── api/
│       └── model_nodes.py         # ✅ 自动支持（通过 Schema）
└── alembic/versions/
    └── i3j4k5l6m7n8_add_unit_to_model_nodes.py  # ✅ 迁移文件
```

### 前端文件
```
frontend/
├── src/
│   ├── api/
│   │   └── model.ts               # ✅ 已添加 unit 类型定义
│   └── views/
│       └── ModelNodes.vue         # ✅ 已添加显示和编辑功能
```

### 文档和测试
```
├── MODEL_UNIT_FIELD.md            # ✅ 详细功能文档
├── UNIT_FIELD_CHECKLIST.md        # ✅ 验证清单
├── UNIT_FIELD_SUMMARY.md          # ✅ 功能总结（本文件）
└── backend/test_unit_field.py     # ✅ 测试脚本
```

## 🚀 如何使用

### 1. 执行数据库迁移
```bash
# 方式1: 使用批处理脚本
.\migrate-simple.bat

# 方式2: 手动执行
cd backend
alembic upgrade head
```

### 2. 在界面中使用
1. 登录系统
2. 进入"模型管理" -> "模型版本"
3. 选择版本，进入节点管理
4. 创建或编辑末级维度节点
5. 在"单位"字段输入自定义单位（如：`元/例`）
6. 保存后在列表中查看效果

### 3. 通过 API 使用

#### 创建节点
```bash
POST /api/model-nodes
Content-Type: application/json

{
  "version_id": 1,
  "name": "平均住院费用",
  "code": "AVG_COST",
  "node_type": "dimension",
  "is_leaf": true,
  "calc_type": "statistical",
  "weight": 5000.00,
  "unit": "元/例"
}
```

#### 更新单位
```bash
PUT /api/model-nodes/1
Content-Type: application/json

{
  "unit": "元/人天"
}
```

## 🔍 验证测试

运行测试脚本：
```bash
cd backend
python test_unit_field.py
```

测试内容：
- ✅ 创建带自定义单位的节点
- ✅ 更新节点单位
- ✅ 验证默认单位 `%`
- ✅ 查询节点列表显示

## 💡 注意事项

1. **仅末级维度需要单位**
   - 序列节点和非末级维度不需要设置单位
   - 界面会自动根据节点类型显示/隐藏单位字段

2. **单位长度限制**
   - 最大 20 个字符
   - 建议使用简洁的表示方式

3. **常用单位推荐**
   - 百分比: `%`
   - 金额: `元`、`元/例`、`元/人`、`元/人天`
   - 计数: `次`、`人`、`例`
   - 时间: `天`、`小时`、`分钟`

4. **向后兼容**
   - 已存在的节点会自动使用默认单位 `%`
   - 不影响现有功能和数据

## 📊 代码示例

### 后端模型定义
```python
class ModelNode(Base):
    # ... 其他字段
    weight = Column(Numeric(10, 4), comment="权重/单价")
    unit = Column(String(20), default='%', comment="单位")
```

### 前端类型定义
```typescript
export interface ModelNode {
  // ... 其他字段
  weight?: number
  unit?: string
}
```

### 前端显示
```vue
<template>
  <span v-if="row.is_leaf && row.weight">
    {{ row.weight }} {{ row.unit || '%' }}
  </span>
</template>
```

## ✨ 总结

单位字段功能已完整实现：
- ✅ 后端：模型、Schema、API、数据库迁移
- ✅ 前端：类型定义、界面显示、表单编辑
- ✅ 百分比处理：前端自动转换，后端存储小数值
- ✅ 文档：功能说明、使用指南、验证清单、百分比处理说明
- ✅ 测试：自动化测试脚本（包括百分比单位测试）

**可以直接使用，无需额外开发工作！**

## 🔄 百分比单位特殊处理

### 数据转换规则
- **后端存储**: 百分比以小数形式存储（如 0.655 表示 65.5%）
- **前端显示**: 自动乘以100显示（如 0.655 → 65.50%）
- **前端编辑**: 用户输入百分比数值（如 65.5），保存时自动除以100
- **其他单位**: 不做转换，直接存储和显示

### 示例
| 用户输入 | 单位 | 后端存储 | 前端显示 |
|---------|------|---------|---------|
| 65.5 | % | 0.655 | 65.50 % |
| 5000 | 元/例 | 5000 | 5000.00 元/例 |
| 7.5 | 天 | 7.5 | 7.50 天 |

详细说明请查看: `PERCENTAGE_UNIT_HANDLING.md`
