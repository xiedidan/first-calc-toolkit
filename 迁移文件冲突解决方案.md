# Alembic 迁移文件冲突解决方案

## 问题描述

在离线部署时，执行 `alembic upgrade head` 报错：
```
FAILED: Multiple head revisions are present for given argument 'head'
```

这表示 Alembic 检测到多个迁移分支（heads），无法确定应该升级到哪个版本。

## 原因分析

1. **旧的迁移文件残留**：服务器上可能有之前部署留下的旧迁移文件
2. **迁移文件不一致**：打包时的迁移文件和服务器上的不一致
3. **迁移链分叉**：某些迁移文件的 `down_revision` 指向了不同的父版本

## 自动修复机制

**最新版本的 `init-database.sh` 已经内置了完全自动化的修复机制，无需任何手动干预！**

### 自动修复流程

1. **检测多个 heads**：自动检测迁移文件中是否存在多个分支
2. **尝试直接升级**：使用 `alembic upgrade heads` 升级所有分支
3. **自动创建合并迁移**：如果直接升级失败，自动创建合并迁移文件
4. **执行合并迁移**：应用合并迁移，统一所有分支
5. **逐个升级兜底**：如果以上都失败，逐个升级每个 head

### 使用方法

直接运行初始化脚本即可，脚本会自动处理所有情况：

```bash
bash scripts/init-database.sh
```

脚本会：
1. 检测是否有多个 head
2. 如果有，自动使用 `alembic upgrade heads` 升级所有分支
3. 如果失败，输出详细的调试信息

### 方案 2：手动诊断和修复

#### 步骤 1：诊断问题

运行诊断脚本：
```bash
bash scripts/diagnose-migrations.sh
```

或手动检查：
```bash
# 进入容器
docker exec -it hospital_backend_offline bash

# 查看所有 heads
alembic heads

# 查看迁移历史
alembic history

# 查看当前版本
alembic current
```

#### 步骤 2：清理并重建（最干净）

如果可以接受清空数据库：

```bash
# 1. 停止所有容器
docker-compose -f config/docker-compose.offline.yml down

# 2. 清理数据库
PGPASSWORD=your_password psql -h localhost -p 15433 -U admin -d hospital_value << 'EOF'
DO $ 
DECLARE
    r RECORD;
BEGIN
    FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
        EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
    END LOOP;
    
    FOR r IN (SELECT sequence_name FROM information_schema.sequences WHERE sequence_schema = 'public') LOOP
        EXECUTE 'DROP SEQUENCE IF EXISTS ' || quote_ident(r.sequence_name) || ' CASCADE';
    END LOOP;
    
    FOR r IN (SELECT typname FROM pg_type WHERE typtype = 'e' AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public')) LOOP
        EXECUTE 'DROP TYPE IF EXISTS ' || quote_ident(r.typname) || ' CASCADE';
    END LOOP;
END $;
EOF

# 3. 重新启动容器
docker-compose -f config/docker-compose.offline.yml up -d

# 4. 重新初始化
bash scripts/init-database.sh
```

#### 步骤 3：升级所有分支（保留数据）

如果需要保留数据：

```bash
# 进入容器
docker exec -it hospital_backend_offline bash

# 升级所有分支
alembic upgrade heads

# 验证
alembic current
```

### 方案 3：重新打包（开发环境）

如果是在开发环境重新打包：

```bash
# 1. 确认本地迁移文件正常
cd backend
python -c "
from alembic.config import Config
from alembic.script import ScriptDirectory
cfg = Config('alembic.ini')
script = ScriptDirectory.from_config(cfg)
heads = script.get_revisions('heads')
print(f'Local heads: {len(heads)}')
"

# 2. 如果本地有多个 heads，需要先修复
# 查看所有 heads
alembic heads

# 创建合并迁移
alembic merge -m "merge branches" head1 head2

# 3. 重新打包
cd ..
bash scripts/build-offline-package.sh
```

## 预防措施

### 1. 打包前检查

在打包前确保迁移文件链正常：

```bash
cd backend
python check_migrations.py
```

应该只看到 1 个 head。

### 2. 部署前清理

在新服务器上首次部署时，确保数据库是干净的：
- 使用 `init-database.sh` 的选项 1（清理整个数据库）
- 或者使用全新的数据库

### 3. 版本控制

- 确保所有迁移文件都在版本控制中
- 打包前确保代码是最新的
- 避免手动修改迁移文件

## 验证修复

修复后，验证迁移状态：

```bash
# 检查 heads 数量（应该是 1）
docker exec hospital_backend_offline alembic heads

# 检查当前版本
docker exec hospital_backend_offline alembic current

# 检查是否有待执行的迁移
docker exec hospital_backend_offline alembic history
```

## 常见问题

### Q: 为什么会出现多个 heads？

A: 通常是因为：
- 多个开发者并行创建了迁移文件
- 迁移文件的 `down_revision` 指向了相同的父版本
- 服务器上有旧的迁移文件残留

### Q: `alembic upgrade heads` 和 `alembic upgrade head` 的区别？

A: 
- `head`（单数）：升级到单一的最新版本，如果有多个 heads 会报错
- `heads`（复数）：升级所有分支到各自的最新版本

### Q: 可以删除旧的迁移文件吗？

A: **不建议**。删除迁移文件会导致：
- 已部署的数据库无法追踪历史
- 无法回滚到之前的版本
- 可能导致数据不一致

正确做法是创建合并迁移（merge migration）。

## 技术支持

如果以上方案都无法解决问题，请提供以下信息：

1. 诊断脚本的完整输出
2. `alembic heads` 的输出
3. `alembic history` 的输出（最近 20 条）
4. 数据库中 `alembic_version` 表的内容
