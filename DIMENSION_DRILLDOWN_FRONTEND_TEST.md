# 维度下钻功能前端测试指南

## 问题诊断

如果前端没有显示"下钻"按钮，可能的原因：

### 1. 前端代码未重新编译
**症状**：修改了代码但界面没有变化

**解决方法**：
```bash
cd frontend
npm run dev
# 或者如果已经在运行，重启开发服务器
```

### 2. 浏览器缓存
**症状**：代码已更新但浏览器显示旧版本

**解决方法**：
- 按 `Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac) 强制刷新
- 或者打开开发者工具，右键刷新按钮选择"清空缓存并硬性重新加载"

### 3. 数据问题
**症状**：按钮显示但点击后报错

**解决方法**：
- 检查是否有价值分布数据
- 检查 `node_id` 字段是否存在
- 查看浏览器控制台的错误信息

## 测试步骤

### 步骤 1: 启动前端开发服务器

```bash
cd frontend
npm run dev
```

等待编译完成，看到类似输出：
```
VITE v4.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

### 步骤 2: 登录系统

1. 打开浏览器访问 `http://localhost:5173`
2. 使用管理员账号登录：
   - 用户名：`admin`
   - 密码：`admin123`

### 步骤 3: 进入报告查看页面

1. 点击左侧菜单"报告查看"
2. 应该能看到报告列表

### 步骤 4: 查看报告详情

1. 点击某个报告的"查看详情"按钮
2. 弹出对话框显示报告详情

### 步骤 5: 检查下钻按钮

在"科室主业价值分布"表格中：
- ✅ 应该看到"操作"列
- ✅ 每一行都应该有"下钻"按钮（蓝色链接样式）

**如果没有看到下钻按钮**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 查看是否有错误信息
4. 切换到 Network 标签页
5. 刷新页面，查看 API 请求是否成功

### 步骤 6: 测试下钻功能

1. 点击任意维度的"下钻"按钮
2. 应该弹出新的对话框
3. 对话框标题显示：`{维度名称} - 收费项目明细`
4. 表格显示收费项目明细（7列）
5. 底部显示汇总信息

**预期结果**：
- 医生序列的维度：显示收费项目明细
- 其他序列的维度：显示错误提示"仅支持医生序列中按维度目录计算的末级维度下钻"

## 调试技巧

### 1. 检查 API 响应

打开浏览器开发者工具 → Network 标签页：

1. 查找 `value-distribution` 请求
2. 查看响应数据，确认每个 item 都有 `node_id` 字段
3. 示例响应：
```json
{
  "items": [
    {
      "rank": 1,
      "node_id": 1281,
      "dimension_name": "普通诊察",
      "value": 72249.5000,
      "ratio": 89.57
    }
  ],
  "total_value": 80663.6834,
  "message": null
}
```

### 2. 检查 Vue 组件状态

在浏览器开发者工具中：

1. 安装 Vue DevTools 扩展（如果还没有）
2. 打开 Vue 标签页
3. 选择 `ReportDetailModal` 组件
4. 查看 `valueDistribution` 数据
5. 确认每个 item 都有 `node_id` 属性

### 3. 检查按钮渲染逻辑

在浏览器控制台执行：

```javascript
// 查看价值分布数据
console.log('valueDistribution:', window.$vm?.valueDistribution)

// 查看第一个维度是否可以下钻
const firstItem = window.$vm?.valueDistribution?.[0]
console.log('First item:', firstItem)
console.log('Can drill down:', firstItem?.node_id && firstItem?.dimension_name)
```

### 4. 测试下钻 API

在浏览器控制台执行：

```javascript
// 假设 report_id = 3, node_id = 1281
fetch('/api/v1/analysis-reports/3/dimension-drilldown/1281', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token'),
    'X-Hospital-ID': '1'
  }
})
.then(res => res.json())
.then(data => console.log('Drill down data:', data))
.catch(err => console.error('Error:', err))
```

## 常见问题

### Q1: 按钮不显示

**检查清单**：
- [ ] 前端代码已更新
- [ ] 开发服务器已重启
- [ ] 浏览器已强制刷新
- [ ] API 返回的数据包含 `node_id` 字段
- [ ] `canDrillDown` 函数返回 true

**解决方法**：
```javascript
// 在浏览器控制台检查
const items = document.querySelectorAll('.el-table__row')
console.log('Table rows:', items.length)

// 检查操作列是否存在
const actionCols = document.querySelectorAll('td:last-child')
console.log('Action columns:', actionCols.length)
```

### Q2: 点击下钻后报错

**常见错误**：
- `node_id is undefined` → 后端没有返回 node_id
- `404 Not Found` → API 路由配置错误
- `400 Bad Request` → 维度类型不支持下钻

**解决方法**：
1. 查看浏览器控制台的完整错误信息
2. 查看 Network 标签页的请求详情
3. 检查后端日志

### Q3: 下钻数据为空

**可能原因**：
- 该维度没有收费项目映射
- 该科室该月份没有收费明细数据
- 数据源配置错误

**解决方法**：
1. 查看对话框底部的提示信息
2. 运行后端测试脚本验证数据
3. 检查数据库中的映射关系和收费明细

## 验证清单

测试完成后，确认以下功能正常：

- [ ] 报告列表正常显示
- [ ] 点击"查看详情"打开对话框
- [ ] 价值分布表格显示数据
- [ ] 每行都有"下钻"按钮
- [ ] 点击下钻按钮打开新对话框
- [ ] 下钻对话框显示维度名称
- [ ] 明细表格显示收费项目数据
- [ ] 金额和数量格式正确（千分位）
- [ ] 汇总信息计算正确
- [ ] 关闭对话框功能正常
- [ ] 错误提示友好清晰

## 截图示例

### 1. 价值分布表格（带下钻按钮）
```
┌────┬──────────┬────────────┬────────┬────────┐
│排名│维度名称  │业务价值    │占比    │操作    │
├────┼──────────┼────────────┼────────┼────────┤
│ 1  │普通诊察  │72,249.50   │89.57%  │[下钻]  │
│ 2  │检查化验  │7,590.93    │9.41%   │[下钻]  │
│ 3  │丁级手术  │688.50      │0.85%   │[下钻]  │
└────┴──────────┴────────────┴────────┴────────┘
```

### 2. 下钻对话框
```
┌─────────────────────────────────────────────────┐
│ 普通诊察 - 收费项目明细                    [×] │
├─────────────────────────────────────────────────┤
│ ┌────┬──────┬──────┬────────┬──────────┬──────┬──────┐
│ │年月│科室  │科室  │项目编码│项目名称  │金额  │数量  │
│ │    │代码  │名称  │        │          │      │      │
│ ├────┼──────┼──────┼────────┼──────────┼──────┼──────┤
│ │2025│BNZ   │白内障│12810032│门诊诊查费│92,242│5,426 │
│ │-10 │      │专科  │9       │          │.00   │.00   │
│ └────┴──────┴──────┴────────┴──────────┴──────┴──────┘
│
│ 总金额: 144,499.00    总数量: 10,170.00
│
├─────────────────────────────────────────────────┤
│                                          [关闭] │
└─────────────────────────────────────────────────┘
```

## 下一步

如果所有测试都通过：
1. 提交代码到版本控制
2. 部署到测试环境
3. 通知用户测试
4. 收集反馈并优化

如果测试失败：
1. 记录错误信息
2. 查看相关日志
3. 参考本文档的调试技巧
4. 必要时联系开发团队
