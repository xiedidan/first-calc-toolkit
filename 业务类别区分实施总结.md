# 业务类别区分实施总结

## 修改内容

### 1. 数据集文档更新

**文件**: `科室业务价值评估数据集.md`

- 修正收费明细表中业务类别字段名：`bussiness_type` → `business_type`
- 明确字段说明：医疗业务类别：门诊、住院

### 2. 计算流程SQL更新

**文件**: `backend/standard_workflow_templates/step1_dimension_catalog.sql`

#### 主要变更：

1. **新增维度层级结构构建**
   - 使用递归CTE从序列节点开始，向下递归获取所有维度节点
   - 构建完整的路径字符串（格式：序列名称/一级维度/二级维度/...）

2. **新增业务类别判断逻辑**
   - 根据维度路径自动判断业务类别
   - 支持的判断规则：
     - 医生序列/门诊 → 门诊
     - 医生序列/住院 → 住院
     - 医生序列/手术/门诊 → 门诊
     - 医生序列/手术/住院 → 住院
     - 护理序列/病区 → 住院
     - 护理序列/非病区 → 门诊
     - 医技序列 → NULL（不区分）

3. **修改收费明细查询**
   - 增加 `business_type` 字段到 GROUP BY
   - 按业务类别分组统计

4. **修改关联条件**
   - 在JOIN时增加业务类别匹配条件
   - 支持维度不区分业务类别的情况（医技序列）

#### 关键SQL片段：

```sql
-- 业务类别匹配条件
LEFT JOIN charge_data cd ON dm.item_code = cd.item_code
    AND (
        dm.business_type IS NULL  -- 维度不区分业务类别(如医技)
        OR dm.business_type = cd.business_type  -- 业务类别匹配
    )
```

### 3. 测试脚本

**文件**: `test-business-type-logic.sql`

- 用于验证维度层级结构和业务类别判断逻辑
- 可以查看所有维度及其对应的业务类别

## 实施效果

### 预期效果

1. **医生序列**
   - 门诊维度：只统计门诊收费明细
   - 住院维度：只统计住院收费明细
   - 手术-门诊维度：只统计门诊手术收费明细
   - 手术-住院维度：只统计住院手术收费明细

2. **护理序列**
   - 病区维度：只统计住院收费明细
   - 非病区维度：只统计门诊收费明细

3. **医技序列**
   - 所有维度：统计全部收费明细（门诊+住院）

### 数据隔离

- 同一个收费项目如果映射到多个维度，会根据维度的业务类别分别统计
- 例如：CT检查
  - 映射到医生序列-门诊-检查费：只统计门诊CT
  - 映射到医生序列-住院-检查费：只统计住院CT
  - 映射到医技序列-影像-CT：统计全部CT（门诊+住院）

## 验证步骤

### 1. 验证维度层级结构

```bash
psql -h localhost -U admin -d hospital_value -P pager=off -f test-business-type-logic.sql
```

检查输出：
- 每个维度的路径是否正确
- 业务类别判断是否符合预期

### 2. 验证计算结果

运行一次完整的计算任务，检查：
- 医生序列-门诊维度的工作量是否只包含门诊业务
- 医生序列-住院维度的工作量是否只包含住院业务
- 医技序列维度的工作量是否包含全部业务

### 3. 对比验证

可以通过以下SQL验证数据正确性：

```sql
-- 查看某个维度的工作量明细
SELECT 
    mn.name as dimension_name,
    d.his_name as department_name,
    cr.workload,
    cr.value
FROM calculation_results cr
INNER JOIN model_nodes mn ON cr.node_id = mn.id
INNER JOIN departments d ON cr.department_id = d.id
WHERE cr.task_id = 'your_task_id'
  AND mn.name LIKE '%门诊%'
ORDER BY d.his_name, mn.name;
```

## 注意事项

1. **模型结构要求**
   - 序列节点必须命名为：医生序列、护理序列、医技序列
   - 一级维度必须包含：门诊、住院、手术、病区、非病区等关键词
   - 如果实际命名不同，需要调整SQL中的LIKE匹配规则

2. **收费明细数据要求**
   - `business_type` 字段必须存在
   - 字段值必须为 '门诊' 或 '住院'
   - 如果有其他业务类别（如急诊、体检），需要扩展判断逻辑

3. **占位符替换**
   - 确保 `{version_id}` 占位符在执行时正确替换
   - 这是新增的占位符，需要在任务执行代码中添加

## 后续优化建议

1. **灵活的匹配规则**
   - 考虑将路径匹配规则配置化，而不是硬编码在SQL中
   - 可以在模型节点表中增加 `business_type` 字段，由用户配置

2. **支持更多业务类别**
   - 扩展支持急诊、体检、健康管理等业务类别
   - 在判断逻辑中增加相应的CASE分支

3. **性能优化**
   - 如果维度层级很深，递归CTE可能影响性能
   - 可以考虑在模型节点表中预计算路径字段

4. **错误处理**
   - 增加数据验证，检查是否有维度无法判断业务类别
   - 提供诊断SQL，帮助用户发现配置问题
