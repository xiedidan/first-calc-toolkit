# 医院科室业务价值评估工具 - 需求规格说明书 V1.3

> **文档状态**: 草稿 (根据问卷更新)
> **创建日期**: 2025-10-20
> **版本**: 1.3

---

## 1. 简介

### 1.1. 项目目的与范围

本项目旨在开发一个“医院科室业务价值评估工具”。该工具旨在提供一个灵活、可配置的在线平台，用于定义和计算医院各科室的业务价值（即绩效）。通过该平台，医院管理者可以动态定义和调整业务价值的评估模型，模型以多层级结构组织，涵盖医生、护理、医技等多个业务序列及其下的细分维度。

系统通过执行与各维度关联的SQL（或Python代码），从医院现有的PostgreSQL业务数据库中提取量化的工作量数据，结合可配置的权重体系，自动计算出各科室每月的业务价值。计算结果将存回PostgreSQL数据库，并提供界面进行查询、分析和导出为标准格式的Excel报表。

**核心范围包括**：
-   评估模型的在线设计与管理功能（支持版本控制）。
-   数据抽取与计算引擎的后端实现（支持SQL和Python）。
-   手动触发计算任务的功能。
-   评估结果的存储、多维度展示与Excel导出功能。
-   基于角色的数据权限隔离。

### 1.2. 术语定义

| 术语 | 定义 |
|---|---|
| **序列** | 评估模型的第一级分类，代表一个大的业务条线。例如：医生序列、护理序列、医技序列。 |
| **维度** | 评估模型中的具体指标项，是树状结构中的叶子节点。每个维度关联一段SQL或Python代码，用于计算原始工作量。例如：门诊诊察、住院手术、床日护理。 |
| **评估模型** | 由序列和维度构成的完整多层级结构，包括结构本身、各叶子节点的权重以及各维度关联的SQL/Python代码。 |
| **模型版本** | 评估模型在某个时间点的快照。系统支持保存多个版本，以适应评估标准的变化和历史数据回溯的需求。 |
| **工作量** | 通过执行维度SQL/Python得到的原始数值。 |
| **业务价值** | 指科室在特定周期内（按月计算）的最终评估得分，由其下所有维度的工作量经过加权计算后汇总得出。 |
| **当期年月** | 系统全局设置的一个计算周期（年月），所有计算和展示都围绕此周期进行。 |

### 1.3. 目标用户
-   **系统管理员**：负责系统配置、用户管理、数据源连接管理。
-   **模型设计师/管理员**：负责设计和维护评估模型（结构、权重、SQL/Python代码），系统相关配置。
-   **数据分析师/操作员**：负责触发计算、查看和导出结果、调整权重、确认数据口径。
-   **业务专家**：查看和调整模型、权重、触发计算、导出结果，不涉及SQL/Python实现。
-   **科室管理者/院领导**：只读访问，查看本科室或全院的评估结果。

---

## 2. 总体描述

### 2.1. 系统架构
系统采用前后端分离的B/S架构。
-   **前端**：基于现代Web框架（如Vue.js, React）实现，提供基于表格的模型编辑器和数据展示界面。
-   **后端**：使用Python语言开发，提供RESTful API接口。负责业务逻辑、模型管理、计算引擎调度、数据库交互、Excel报表生成等。
-   **数据库**：使用PostgreSQL。上游业务数据存储在单个数据库的特定Schema中，系统对上游数据表具有读写权限。系统自身的配置数据和计算结果存储在新的表中。
-   **任务队列**：引入任务队列（如Celery），用于异步处理耗时的计算任务和报表生成，避免接口长时间阻塞。

### 2.2. 主要限制与假设
-   上游业务数据源为PostgreSQL，数据存储在单个Schema内的多张表中。
-   系统运行所需的数据库账户对上游数据表具有读写权限。
-   科室、人员等基础信息的编码（拼音首字母）与上游系统保持一致。
-   计算按月进行，系统内设置一个全局的“当期年月”参数。
-   初期项目不考虑与医院其他系统（如HIS、LIS）的深度集成，数据交互均通过数据库层完成。
-   权重仅应用于叶子节点（维度）。

---

## 3. 功能性需求

### 3.1. 系统全局设置 (FR-GLOBAL)

#### 3.1.1. 当期年月设置 (FR-GLOBAL-01)
-   系统应提供一个全局设置项，用于配置“当期年月”。
-   此设置将作为所有计算任务的默认计算周期，并在界面中多处显示以保持上下文一致。
-   修改“当期年月”应需要相应权限。

-   修改"当期年月"应需要相应权限。

#### 3.1.2. SQL数据源配置 (FR-GLOBAL-02) - 新增功能
-   **功能概述**：系统应提供SQL数据源配置管理功能，用于建立与外部数据库的连接，并在计算流程中执行SQL代码。
-   **核心需求**：
    -   支持配置多个数据源连接
    -   支持主流数据库类型（PostgreSQL、MySQL、SQL Server、Oracle等）
    -   提供数据源连接测试功能
    -   支持在计算步骤中选择数据源执行SQL
    -   提供数据源连接池管理
    -   支持数据源的启用/禁用状态管理
-   **数据源配置项**：
    -   数据源名称（必填）：用于标识数据源的唯一名称
    -   数据源类型（必填）：数据库类型（PostgreSQL/MySQL/SQL Server/Oracle）
    -   主机地址（必填）：数据库服务器地址
    -   端口号（必填）：数据库服务端口
    -   数据库名称（必填）：要连接的数据库名
    -   用户名（必填）：数据库登录用户名
    -   密码（必填）：数据库登录密码（加密存储）
    -   Schema名称（可选）：默认Schema（PostgreSQL/Oracle）
    -   连接参数（可选）：额外的连接参数（JSON格式）
    -   是否默认（可选）：标记为默认数据源
    -   是否启用（可选）：数据源启用状态
    -   描述（可选）：数据源用途说明
-   **连接测试**：
    -   用户在保存数据源配置前，应能测试连接是否成功
    -   测试应验证：网络连通性、认证信息正确性、数据库访问权限
    -   测试结果应显示详细的错误信息（如连接超时、认证失败等）
-   **安全性要求**：
    -   数据库密码必须加密存储，不得明文保存
    -   数据源配置的查看和修改需要系统管理员权限
    -   密码字段在前端显示时应脱敏（显示为***）
    -   连接字符串不应在日志中明文记录
-   **连接池管理**：
    -   系统应为每个数据源维护连接池
    -   支持配置连接池参数：最小连接数、最大连接数、连接超时时间
    -   自动回收空闲连接
    -   监控连接池状态（活跃连接数、空闲连接数）
-   **与计算流程集成**：
    -   计算步骤创建时，如果代码类型为SQL，需要选择目标数据源
    -   如果未指定数据源，使用标记为"默认"的数据源
    -   计算步骤执行时，使用指定的数据源执行SQL代码
    -   支持在SQL代码中使用占位符（如{current_year_month}）
-   **数据源管理界面**：
    -   提供数据源列表页面，显示所有已配置的数据源
    -   支持数据源的增删改查操作
    -   支持快速启用/禁用数据源
    -   显示数据源连接状态（在线/离线/错误）
    -   提供"测试连接"按钮，实时验证数据源可用性

### 3.2. 评估模型管理 (FR-MODEL)
#### 3.2.1. 模型版本管理 (FR-MODEL-01)
-   系统应支持创建、保存和管理多个评估模型版本。
-   每个版本应有唯一的版本号和可选的名称/描述（如“2025年标准版-v1”）。
-   用户可以设置一个“默认”或“活动”版本，用于未来的计算任务。
-   用户可以复制现有版本以创建新版本。
-   计算结果保留所有版本，用户可以选择其中一个版本标记为“最终版”。

#### 3.2.2. 模型结构编辑器 (FR-MODEL-02)
-   系统应提供一个基于表格的界面来展示和编辑评估模型，结构参考Excel模板。
-   模型应支持多层级结构，包括工作量/成本类型、一级维度、二级维度、三级维度。
-   支持在表格中直接进行增加、删除、修改行等操作。
-   选中某一行时，下方或右侧表单区域应显示并可编辑该行的详细属性。

#### 3.2.3. 节点属性配置 (FR-MODEL-03)
-   **所有节点**：应可配置节点名称、编码、业务导向。
-   **叶子节点（维度）**：除上述属性外，还需配置：
    -   **权重/单价**：可以是百分比（如`18.00%`）或固定值（如`200.0元/人天`）。
    -   **计算类型**：提供一个选项，用于标记维度的计算方式（如“统计型”或“计算型”），此标记仅为说明，不影响具体逻辑。
    -   **计算逻辑**：
        -   对于“目录统计型”维度，通过关联的“维度-收费项目”目录进行统计（由用户自己提供SQL查询代码或Python脚本）。
        -   对于“指标计算型”维度，关联自定义的SQL查询代码或Python脚本。
    -   **全院学科业务价值**：用于参考的基准值。
-   权重/单价仅应用于叶子节点，用于计算其得分。

#### 3.2.4. 维度目录管理 (FR-MODEL-04)
-   **目录界面**：系统应提供一个独立的列表界面，用于为每个“目录统计型”维度配置其关联的收费项目。
-   **收费项目来源**：收费项目列表来源于 `dim_sfxmb` 表，使用 `sfxmbm` (收费项目编码) 作为唯一识别符，并显示 `sfxmmc` (收费项目名称)。
-   **配置功能**：
    -   用户可以为选定维度添加或移除多个收费项目。
    -   界面应支持通过收费项目编码或名称进行模糊搜索，以快速定位和添加项目。
    -   每个维度的收费项目目录是独立的，不与其他维度共享。
-   **目录导入导出**：
    -   支持将一个或多个维度的收费项目目录导出为Excel文件。
    -   支持从Excel文件批量导入收费项目目录。导入文件可以包含多个维度的目录配置（例如，将所有手术相关的维度目录放在一个文件中导入）。
    -   系统应提供导入模板，并能在导入时显示预览和错误报告。

#### 3.2.5. 维度目录智能导入 (FR-MODEL-05) - 重要且紧急
-   **导入场景**：将现有的手工制作的维度目录Excel文件导入系统，并自动转换为系统可用的维度-收费项目映射关系。
-   **手工目录特征**：
    -   手工目录通常包含：收费项目编码、维度预案（自然语言描述的维度名称，如"甲级手术D"）、专家意见（缩写形式，如"4D"表示甲级手术D）。
    -   手工目录不区分门诊、手术、病区、非病区等场景，需要系统进行智能映射。
    -   维度预案和专家意见可能同时存在，专家意见优先级高于维度预案。
-   **导入流程**：
    -   **第一步：字段映射**
        -   用户上传Excel文件后，系统解析文件并展示所有列名。
        -   用户指定Excel列与系统字段的对应关系：
            -   收费编码（必填）：对应收费项目编码
            -   维度预案（可选）：对应维度预案列
            -   专家意见（可选）：对应专家意见列
        -   系统应支持智能识别和建议映射关系（如自动识别包含"编码"、"代码"等关键词的列）。
    -   **第二步：维度值映射**
        -   系统提取"维度预案"和"专家意见"两列的所有唯一值。
        -   用户为每个唯一值指定其对应的系统维度（支持一对多映射）。
        -   例如："4D" 可以同时映射到"门诊-甲级手术D"和"住院-甲级手术D"两个维度。
        -   系统应提供智能匹配建议（基于维度名称的模糊匹配）。
        -   用户可以选择忽略某些值（不进行映射）。
    -   **第三步：预览与确认**
        -   系统根据前两步的映射规则，生成准备导入的维度目录数据。
        -   以表格形式展示：收费项目编码、收费项目名称、目标维度、来源（维度预案/专家意见）。
        -   用户可以在此步骤进行最后的调整（删除、修改目标维度）。
        -   系统应标记异常情况：
            -   收费项目编码在系统中不存在（警告，但允许继续）
            -   收费项目已存在于目标维度中（提示，但不强制纠正，因为一个项目可能存在于多个维度）
            -   目标维度不存在（错误，必须修正）
        -   用户确认后，系统执行批量导入，将数据写入 `dimension_item_mappings` 表。
-   **导入策略**：
    -   专家意见优先：如果同一收费项目同时存在维度预案和专家意见，优先采用专家意见的映射结果。
    -   增量导入：导入操作不会删除已有的维度目录数据，只会新增映射关系。
    -   去重处理：如果导入的映射关系已存在（相同的维度ID和收费项目编码），则跳过该条记录。
-   **错误处理**：
    -   导入过程中如果遇到错误（如数据库写入失败），应回滚整个导入操作，保持数据一致性。
    -   导入完成后，系统应生成导入报告，包括：成功导入数量、跳过数量、错误数量及详细错误信息。

#### 3.2.6. SQL/Python编辑器与测试 (FR-MODEL-06)
-   系统应为所有维度提供一个代码编辑区域，支持SQL和Python。
-   编辑器应支持语法高亮（优先级不高）。
-   代码中可使用预设的占位符（如 `{current_year_month}`），计算时由系统自动替换为“当期年月”。
-   提供“测试运行”功能。用户可执行代码并预览返回的结果（通常为按科室聚合的数值列表）。

### 3.3. 科室管理 (FR-DEPT)

#### 3.3.1. 科室对照关系管理 (FR-DEPT-01)
-   **数据源**：科室信息来源于 `dim_ksdmdzb` (科室代码对照表)。
-   **对照管理界面**：系统应提供一个表格界面，用于管理和展示各科室的对照关系。表格应至少包含以下列：
    -   `hisksdm` (HIS科室代码)
    -   `hisksmc` (HIS科室名称)
    -   `cbzxdm` (成本中心代码)
    -   `cbzxmc` (成本中心名称)
    -   `hsdydm` (核算单元代码)
    -   `hsdymc` (核算单元名称)
-   **编辑功能**：系统管理员应能在此界面编辑HIS科室、成本中心和核算单元的对照关系，确保数据的一致性。

#### 3.3.2. 评估范围管理 (FR-DEPT-02)
-   **启用/禁用评估**：在科室管理界面中，应为每个核算单元提供一个“是否参与评估”的勾选框（或开关）。
-   **控制计算范围**：只有被标记为“参与评估”的核算单元，才会被包含在手动触发的计算任务范围内。
-   **默认状态**：新同步或新增的核算单元默认状态可设为“不参与评估”，由管理员手动启用。

### 3.4. 计算引擎 (FR-CALC)

#### 3.4.1. 计算任务创建与触发 (FR-CALC-01)
-   用户应能手动创建计算任务。
-   创建任务时需指定：
    -   要计算的科室范围（单个、多个或全部科室）。当选择“全部科室”时，系统将仅计算在【科室管理】中标记为“参与评估”的核算单元。
    -   要使用的评估模型版本。
    -   计算周期默认使用系统设置的“当期年月”。
-   系统不支持自动定时计算。

#### 3.4.2. 计算过程 (FR-CALC-02)
-   任务启动后，后端应将其加入异步任务队列执行。
-   对每个待计算的科室，引擎遍历所选模型版本的所有叶子节点。
-   对每个叶子节点，引擎擎执行其关联的SQL或Python代码，获取该科室的工作量原始数值。
-   根据叶子节点的权重/单价类型（百分比或固定值），计算维度得分。
-   系统根据模型结构，自下而上逐级汇总得分，最终得到科室各序列（医生、护理、医技）的总价值和科室总价值。

#### 3.4.3. 任务监控与日志 (FR-CALC-03)
-   系统应提供一个任务列表，显示所有历史和正在运行的计算任务的状态（排队中、运行中、已完成、失败）。
-   对于失败的任务，应能查看详细的错误日志（如哪个科室、哪个维度的代码执行失败及其原因）。
-   支持对失败的任务进行重试。

### 3.4. 结果管理与展示 (FR-RESULT)

#### 3.4.1. 结果数据存储 (FR-RESULT-01)
-   每次计算任务的详细结果都应被持久化到结果数据库中。
-   应存储：任务ID、模型版本、科室ID、评估周期、各层级节点的名称/ID、原始工作量、权重/单价、各级得分、科室总价值。
-   历史结果应被完整保留，不被新计算覆盖，以供追溯和对比。

#### 3.4.2. 结果查询与展示 (FR-RESULT-02)
-   提供结果查询界面，用户可按时间周期、模型版本、科室等条件筛选查看评估结果。
-   **核心展示1：绩效结构表**
    -   为每个科室生成结构化的绩效表，格式严格遵循《绩效结构表（模板）-标准版-20251017-v1.xlsx》，具体结构根据实际模型而定。
    -   表格应包含工作量/成本、各级维度、全院学科业务价值、业务导向、科室综合价值、各级占比、各级金额等列。
    -   支持在线查看和交互。
-   **核心展示2：科室业务价值汇总表**
    -   提供一张全院科室汇总表，包含：科室、医生价值、医生占比、护理价值、护理占比、医技价值、医技占比、科室总价值、诊断收入、执行收入、门急诊数量、占用床日数。
    -   此表应包含全院的汇总行。
    -   支持在线查看和交互。

#### 3.4.3. 结果导出 (FR-RESULT-03)
-   **绩效结构表导出**：用户可以选择一个或多个科室，导出其绩效结构表为Excel文件，格式与模板一致。
-   **汇总表导出**：用户可以导出科室业务价值汇总表为Excel文件。
-   导出功能应为异步任务，完成后提供文件下载链接。

### 3.5. 系统与用户管理 (FR-SYS)

#### 3.5.1. 用户与角色管理 (FR-SYS-01)
-   系统管理员可以创建、修改、禁用用户。
-   系统应支持角色管理，管理员可以创建角色并为角色分配权限。
-   **关键权限控制**：
    -   **模型设计师/管理员**：模型编辑、系统配置。
    -   **数据分析师/操作员**：触发计算、查看/导出所有结果、调整权重。
    -   **业务专家**：查看/调整模型和权重、触发计算、导出结果，但不能修改代码。
    -   **科室管理者/院领导**：只能查看其所在科室或授权范围内的结果。
-   用户可以被分配一个或多个角色。

#### 3.5.2. 数据权限隔离 (FR-SYS-02)
-   系统必须实现严格的数据权限隔离。
-   科室级别的用户（如科室主任）登录后，只能查看与自己科室相关的数据，不能查看其他科室的详细得分构成。
-   院领导或具有全院权限的用户可以查看所有科室的数据。

---

## 4. 非功能性需求

### 4.1. 性能
-   **UI响应**：所有页面操作的响应时间应在2秒以内。
-   **计算效率**：
    -   **中型医院**（10-20个科室，每月100万条收费明细）：单次完整计算（全院所有科室）应在1小时内完成。
    -   **大型医院**（每月1000万条收费明细）：计算时间可接受更长，但应提供明确的进度反馈。
-   **数据查询**：结果查询和展示操作的响应时间应在3秒以内。
-   **报表导出**：Excel报表生成任务应在后台异步执行，对于大型报表，生成时间应在5分钟内完成。

### 4.2. 安全性
-   用户需要通过用户名和密码登录系统。
-   密码在数据库中必须加密存储。
-   系统需实现基于角色的访问控制（RBAC），确保用户只能访问其权限范围内的功能和数据。
-   **数据隔离**：必须严格实现科室间的数据权限隔离，确保用户无法访问未授权科室的数据。
-   不需要与医院现有的统一认证系统（如LDAP/AD）集成。

### 4.3. 可用性与可靠性
-   系统应提供清晰、一致、简洁的用户界面，优先考虑实用性而非炫酷的交互效果。
-   核心计算过程应有详细的日志记录和错误处理机制，确保数据计算的准确性和可追溯性。
-   系统应能7x24小时稳定运行。
-   对于耗时的操作（如计算、导出），应提供明确的进度指示。

### 4.4. 可维护性
-   前后端代码应遵循统一的编码规范，有清晰的模块划分和必要的注释。
-   评估模型的导入导出功能（推荐），便于备份和迁移。
-   系统应具备良好的扩展性，以支持未来可能增加的计算逻辑（如AI辅助SQL检查）。

---

## 4.5. 计算流程管理 (FR-CALC-FLOW) - 新增功能

### 4.5.1. 功能概述
-   **重大架构调整**：将代码逻辑从模型结构中分离，引入独立的计算流程管理功能。
-   **核心变更**：
    -   模型结构（model_nodes）不再包含代码字段（script字段保留但不再使用）。
    -   新增计算流程（calculation_workflows）和计算步骤（calculation_steps）两个核心实体。
    -   计算任务执行时，不再从模型节点读取代码，而是执行计算流程中的步骤。

### 4.5.2. 计算流程管理 (FR-CALC-FLOW-01)
-   系统应支持创建、编辑、删除和复制计算流程。
-   每个计算流程应关联到特定的模型版本。
-   计算流程应包含以下属性：
    -   流程名称（必填）
    -   流程描述（可选）
    -   关联的模型版本ID（必填）
    -   创建时间和更新时间
-   用户可以为一个模型版本创建多个计算流程。
-   删除计算流程时，应级联删除该流程下的所有计算步骤。
-   复制计算流程时，应同时复制所有计算步骤。

### 4.5.3. 计算步骤管理 (FR-CALC-FLOW-02)
-   系统应支持在计算流程中创建、编辑、删除计算步骤。
-   计算步骤应包含以下属性：
    -   步骤名称（必填）
    -   步骤描述（可选）
    -   代码类型（必填，可选值：Python、SQL）
    -   代码内容（必填）
    -   执行顺序（sort_order，必填）
    -   是否启用（可选，默认启用）
    -   创建时间和更新时间
-   系统应提供步骤顺序调整功能：
    -   支持上移/下移操作
    -   支持拖拽排序（前端实现）
    -   自动维护sort_order字段的连续性
-   系统应支持批量启用/禁用步骤。

### 4.5.4. 代码编辑器 (FR-CALC-FLOW-03)
-   系统应为计算步骤提供代码编辑器界面。
-   编辑器应支持以下功能：
    -   语法高亮（Python和SQL）
    -   代码自动补全（可选）
    -   代码格式化（可选）
    -   全屏编辑模式
-   代码中可使用预定义的占位符：
    -   `{current_year_month}`：当期年月
    -   `{department_id}`：科室ID
    -   `{department_code}`：科室代码
    -   `{start_date}`：开始日期
    -   `{end_date}`：结束日期
-   系统应在代码执行时自动替换占位符为实际值。

### 4.5.5. 代码测试功能 (FR-CALC-FLOW-04)
-   系统应提供代码测试功能，允许用户在保存前测试代码。
-   测试功能应支持：
    -   指定测试参数（如科室ID、年月等）
    -   执行代码并返回结果
    -   显示执行时间和资源消耗
    -   显示详细的错误信息（如果执行失败）
-   测试执行应有超时限制（如30秒）。
-   测试执行应在隔离环境中进行，不影响生产数据。

### 4.5.6. 计算任务执行调整 (FR-CALC-FLOW-05)
-   **重要变更**：计算任务执行逻辑需要调整。
-   创建计算任务时，需要指定：
    -   模型版本ID（必填）
    -   计算流程ID（必填）
    -   科室范围（必填）
    -   计算周期（必填）
-   任务执行流程：
    1. 加载指定的计算流程和所有启用的计算步骤
    2. 按sort_order顺序执行每个步骤
    3. 对每个步骤，替换代码中的占位符
    4. 执行代码并记录结果
    5. 如果步骤执行失败，记录错误并停止后续步骤
    6. 所有步骤执行完成后，根据模型结构计算最终得分
-   任务执行日志应记录每个步骤的：
    -   开始时间和结束时间
    -   执行状态（成功/失败）
    -   返回结果或错误信息
    -   执行耗时

### 4.5.7. 数据迁移 (FR-CALC-FLOW-06)
-   系统应提供数据迁移工具，将现有模型节点中的代码迁移到计算流程中。
-   迁移策略：
    -   为每个模型版本创建一个默认计算流程（名称："{版本名称} - 默认计算流程"）
    -   遍历该版本的所有节点（包括非末级节点）
    -   对每个包含代码的节点，创建一个计算步骤
    -   步骤名称：节点的完整路径（如"医生序列 > 门诊 > 甲级手术D"）
    -   步骤代码：节点的script字段内容
    -   步骤顺序：按节点的sort_order排序
-   迁移工具应提供：
    -   预览功能：显示将要迁移的数据
    -   执行迁移：实际执行数据迁移
    -   回滚功能：如果迁移失败，回滚所有更改
    -   迁移报告：显示成功和失败的记录
-   迁移完成后，模型节点的script字段保留但不再使用。

### 4.5.8. 向后兼容 (FR-CALC-FLOW-07)
-   在过渡期间，系统应保持向后兼容：
    -   API接口继续支持读取模型节点的script字段（标记为已弃用）
    -   如果计算任务未指定计算流程ID，系统尝试使用节点中的代码执行（兼容模式）
    -   前端界面应提示用户迁移到新的计算流程管理
-   系统应提供配置选项，允许管理员：
    -   启用/禁用兼容模式
    -   设置兼容模式的过期时间
-   完全迁移到新架构后，可以通过配置禁用兼容模式。

---

## 5. 附录

### 5.1. 参考文件
-   《绩效结构表（模板）-标准版-20251017-v1.xlsx》：定义了最终输出的核心报表格式。
-   《需求调研问卷.md》：包含了本次需求分析的详细用户输入。

### 5.2. 数据库表示例
#### 5.2.1. 上游业务表示例
-   `dwd_sfmxb` (收费明细表)：包含收费明细，关键字段包括 `sj` (时间), `kdksid` (开单科室ID), `fy` (费用), `sfbm` (收费编码) 等。
-   `dim_ksdmdzb` (科室代码对照表)：包含科室信息，关键字段包括 `hisksdm` (HIS科室代码), `hisksmc` (HIS科室名称) 等。
-   `dim_sfxmb` (收费项目表)：作为维度目录管理的来源，关键字段包括 `sfxmbm` (收费项目编码), `sfxmmc` (收费项目名称), `sflb` (收费类别) 等。

#### 5.2.2. 系统结果表示例（待设计）
-   `calc_tasks` (计算任务表)：存储计算任务信息。
-   `model_versions` (模型版本表)：存储评估模型的版本信息。
-   `model_nodes` (模型节点表)：存储模型的结构节点。
-   `dimension_item_mapping` (维度-收费项目映射表)：存储“统计型”维度与收费项目的关联关系。
-   `calc_results_detail` (计算结果明细表)：存储各科室、各维度的详细计算结果。
-   `calc_results_summary` (计算结果汇总表)：存储科室级别的汇总结果。

--
-

## 6. 离线部署需求 (FR-DEPLOY) - 新增

### 6.1. 部署场景说明
-   **目标环境**：无互联网连接的Linux服务器（内网环境）
-   **环境限制**：
    -   服务器仅有Python 2.7，无法直接运行Python 3.12应用
    -   无法通过pip、npm等包管理器在线安装依赖
    -   已安装Docker和Docker Compose
    -   已有PostgreSQL数据库实例（可复用）
-   **迁移需求**：
    -   完整的应用代码和配置
    -   所有运行时依赖（Python包、Node.js包、系统库等）
    -   现有数据库的数据（模型、配置、历史计算结果等）
    -   快速部署，最小化手动配置

### 6.2. 离线部署包需求 (FR-DEPLOY-01)

#### 6.2.1. 部署包内容
离线部署包应包含以下内容：
-   **Docker镜像文件**（.tar格式）：
    -   后端服务镜像（包含Python 3.12 + FastAPI + 所有依赖）
    -   Celery Worker镜像（与后端服务相同的镜像）
    -   前端服务镜像（包含Nginx + 构建后的Vue.js应用）
    -   Redis镜像（官方镜像）
    -   PostgreSQL镜像（可选，如果目标环境没有）
-   **Docker Compose配置文件**：
    -   `docker-compose.offline.yml`：离线部署专用配置
    -   支持连接外部PostgreSQL数据库
    -   支持使用容器内PostgreSQL数据库
-   **数据库迁移文件**：
    -   Alembic迁移脚本
    -   数据库初始化SQL脚本
    -   数据库数据导出文件（.sql或.dump格式）
-   **部署脚本**：
    -   `deploy.sh`：一键部署脚本（Linux）
    -   `load-images.sh`：镜像导入脚本
    -   `init-database.sh`：数据库初始化脚本
-   **配置文件模板**：
    -   `.env.offline.template`：环境变量配置模板
    -   包含数据库连接、Redis连接、加密密钥等配置项
-   **部署文档**：
    -   `OFFLINE_DEPLOYMENT_GUIDE.md`：详细的离线部署指南
    -   包含前置条件检查、部署步骤、故障排查等内容

#### 6.2.2. 部署包生成工具 (FR-DEPLOY-02)
系统应提供部署包生成工具，用于在有网络的环境中生成离线部署包：
-   **工具名称**：`build-offline-package.sh`
-   **功能**：
    -   构建所有Docker镜像（后端、前端、Celery）
    -   拉取依赖镜像（Redis、PostgreSQL）
    -   导出所有镜像为.tar文件
    -   导出数据库数据（可选）
    -   打包所有配置文件和脚本
    -   生成部署包压缩文件（.tar.gz）
-   **输出**：
    -   `hospital-value-toolkit-offline-v{version}.tar.gz`
    -   包含所有必需文件，可直接传输到目标服务器

#### 6.2.3. 数据库连接模式 (FR-DEPLOY-03)
离线部署应支持两种数据库连接模式：

**模式1：使用外部PostgreSQL数据库**
-   目标服务器已有PostgreSQL实例
-   Docker Compose配置中不启动PostgreSQL容器
-   后端服务连接到外部数据库（通过host.docker.internal或IP地址）
-   需要在部署前配置数据库连接信息

**模式2：使用容器内PostgreSQL数据库**
-   目标服务器没有PostgreSQL或需要独立数据库
-   Docker Compose启动PostgreSQL容器
-   后端服务连接到容器内数据库
-   数据持久化到Docker Volume

#### 6.2.4. 数据迁移需求 (FR-DEPLOY-04)
-   **数据导出**：
    -   在源环境导出完整数据库数据（包含表结构和数据）
    -   支持导出为SQL脚本或PostgreSQL dump文件
    -   导出文件应包含在离线部署包中
-   **数据导入**：
    -   部署脚本应支持自动导入数据库数据
    -   支持增量导入（仅导入新数据，不覆盖现有数据）
    -   支持全量导入（清空数据库后导入）
    -   导入前应进行数据验证和备份

#### 6.2.5. 环境配置需求 (FR-DEPLOY-05)
-   **配置文件**：
    -   提供`.env.offline.template`模板文件
    -   部署时复制为`.env`并填写实际配置
-   **必需配置项**：
    -   数据库连接信息（主机、端口、用户名、密码、数据库名）
    -   Redis连接信息（如果使用外部Redis）
    -   JWT密钥（SECRET_KEY）
    -   数据源密码加密密钥（ENCRYPTION_KEY）
    -   应用端口配置
-   **配置验证**：
    -   部署脚本应验证配置文件的完整性
    -   检查必需配置项是否已填写
    -   测试数据库和Redis连接是否正常

#### 6.2.6. 部署流程需求 (FR-DEPLOY-06)
离线部署流程应尽可能自动化，减少手动操作：

**第一步：环境准备**
-   检查Docker和Docker Compose是否已安装
-   检查目标服务器的系统资源（CPU、内存、磁盘空间）
-   检查必需的端口是否可用（80、8000、6379、5432等）

**第二步：解压部署包**
-   将部署包传输到目标服务器
-   解压部署包到指定目录

**第三步：导入Docker镜像**
-   执行`load-images.sh`脚本
-   导入所有Docker镜像到本地Docker仓库
-   验证镜像导入是否成功

**第四步：配置环境**
-   复制`.env.offline.template`为`.env`
-   编辑`.env`文件，填写数据库连接等配置
-   验证配置文件的正确性

**第五步：初始化数据库**
-   如果使用外部数据库，执行数据库迁移脚本
-   如果需要导入数据，执行数据导入脚本
-   验证数据库表结构和数据

**第六步：启动服务**
-   执行`docker-compose -f docker-compose.offline.yml up -d`
-   等待所有容器启动完成
-   检查容器运行状态

**第七步：验证部署**
-   访问前端页面，验证界面是否正常
-   访问后端API文档，验证接口是否可用
-   执行健康检查接口，验证服务状态
-   测试登录功能，验证数据库连接

#### 6.2.7. 故障排查需求 (FR-DEPLOY-07)
部署文档应包含常见问题的排查方法：
-   **镜像导入失败**：检查磁盘空间、Docker版本兼容性
-   **容器启动失败**：检查端口占用、配置文件错误、日志输出
-   **数据库连接失败**：检查网络连通性、认证信息、防火墙规则
-   **前端无法访问**：检查Nginx配置、端口映射、反向代理设置
-   **计算任务失败**：检查Celery Worker状态、Redis连接、数据源配置

#### 6.2.8. 更新和维护需求 (FR-DEPLOY-08)
-   **版本更新**：
    -   提供版本更新脚本，支持从旧版本升级到新版本
    -   更新时应保留现有数据和配置
    -   支持回滚到旧版本
-   **数据备份**：
    -   提供数据库备份脚本
    -   支持定期自动备份
    -   备份文件应包含时间戳
-   **日志管理**：
    -   所有容器的日志应持久化到宿主机
    -   提供日志查看和清理脚本
    -   支持日志轮转，避免磁盘占满

### 6.3. 性能和资源需求 (FR-DEPLOY-09)

#### 6.3.1. 最低硬件要求
-   **CPU**：4核心
-   **内存**：8GB
-   **磁盘空间**：50GB（包含镜像、数据、日志）
-   **网络**：内网环境，支持容器间通信

#### 6.3.2. 推荐硬件配置
-   **CPU**：8核心或更多
-   **内存**：16GB或更多
-   **磁盘空间**：100GB或更多（SSD优先）
-   **网络**：千兆网络

#### 6.3.3. 部署包大小估算
-   **Docker镜像**：约2-3GB（压缩后）
-   **数据库数据**：根据实际数据量，预估100MB-1GB
-   **配置和脚本**：约10MB
-   **总计**：约2.5-4GB

---

## 7. 重要变更说明 (V1.4)

### 7.1. 架构调整概述
本版本对系统进行了重大架构调整，主要变更如下：

1. **代码与模型分离**：将代码逻辑从模型结构中分离，引入独立的计算流程管理功能
2. **新增计算流程管理**：新增计算流程（calculation_workflows）和计算步骤（calculation_steps）两个核心实体
3. **模型结构简化**：模型节点（model_nodes）不再包含代码字段，专注于业务价值的组织结构
4. **计算任务调整**：计算任务执行时，从计算流程中读取步骤并执行，而不是从模型节点读取代码
5. **新增离线部署支持**：支持在无互联网环境的Linux服务器上快速部署系统

### 7.2. 受影响的功能模块

#### 7.2.1. 模型管理 (FR-MODEL)
-   **FR-MODEL-03 节点属性配置**：移除"计算逻辑"配置项，节点不再包含SQL/Python代码
-   **FR-MODEL-06 SQL/Python编辑器**：此功能已废弃，迁移到计算流程管理中

#### 7.2.2. 计算引擎 (FR-CALC)
-   **FR-CALC-02 计算过程**：不再从模型节点读取代码，改为执行计算流程中的步骤
-   **FR-CALC-01 计算任务创建**：需要额外指定计算流程ID

### 7.3. 数据迁移要求
-   系统升级时，必须执行数据迁移工具，将现有模型节点中的代码迁移到计算流程中
-   迁移完成前，系统将运行在兼容模式下，继续支持从节点读取代码
-   建议在测试环境完成迁移和验证后，再在生产环境执行

### 7.4. API变更
-   模型节点相关API的script字段标记为已弃用（deprecated）
-   新增计算流程管理相关API（详见API设计文档）
-   计算任务创建API新增workflow_id参数（可选，用于兼容）

### 7.5. 前端界面变更
-   模型结构编辑页面移除代码编辑器
-   新增计算流程管理页面
-   新增计算步骤编辑页面（包含代码编辑器）
-   计算任务创建页面新增计算流程选择

### 7.6. 向后兼容性
-   过渡期间，系统保持向后兼容，支持从节点读取代码（兼容模式）
-   兼容模式可通过系统配置启用/禁用
-   建议在完成数据迁移后，禁用兼容模式以提高性能


---

## 8. 模型版本导入功能 (V1.5) - 新增

### 8.1. 功能概述

为提高模型复用性和快速复制现有知识，系统新增模型版本导入功能。用户可以从系统中其他医疗机构的模型版本中导入结构和配置到当前医疗机构。

### 8.2. 核心功能

#### 8.2.1. 可导入版本列表 (FR-MODEL-IMPORT-01)
-   系统应在模型版本管理页面提供"导入版本"按钮
-   点击后显示可导入的模型版本列表，仅显示其他医疗机构的版本（不包括当前医疗机构）
-   列表应显示：版本号、版本名称、所属医疗机构名称、创建时间
-   支持按版本号、名称、医疗机构名称进行模糊搜索
-   支持分页显示（每页10条记录）

#### 8.2.2. 版本预览 (FR-MODEL-IMPORT-02)
-   用户选择某个版本后，可以预览该版本的详细信息
-   预览信息包括：
    -   版本基本信息（版本号、名称、描述、所属医疗机构）
    -   模型节点数量统计
    -   计算流程数量统计
    -   计算步骤数量统计

#### 8.2.3. 导入配置 (FR-MODEL-IMPORT-03)
-   用户需要配置导入选项：
    -   **导入类型**：
        -   仅导入模型结构（节点树）
        -   导入模型结构和计算流程
    -   **新版本信息**：
        -   版本号（必填，不能与当前医疗机构已有版本重复）
        -   版本名称（必填）
        -   版本描述（可选）
-   系统应实时验证版本号的唯一性（仅在当前医疗机构内）
-   如果选择导入计算流程，系统应显示警告："计算流程中的SQL代码可能需要根据您的数据库结构进行调整"

#### 8.2.4. 导入执行 (FR-MODEL-IMPORT-04)
-   系统应在后台异步执行导入操作
-   导入内容：
    -   创建新的模型版本记录（hospital_id为当前医疗机构）
    -   递归复制所有模型节点，保持层级关系和排序
    -   如果选择导入计算流程，复制所有计算流程和计算步骤
    -   处理数据冲突：
        -   如果计算步骤引用的数据源在当前医疗机构不存在，将data_source_id设为NULL（使用默认数据源）
        -   记录警告信息
-   系统应记录导入历史到model_version_imports表：
    -   源版本ID
    -   源医疗机构ID
    -   导入时间
    -   导入用户ID
    -   导入类型
    -   导入统计信息（JSON格式）
-   导入操作应具有原子性，失败时完全回滚

#### 8.2.5. 导入结果 (FR-MODEL-IMPORT-05)
-   导入完成后，显示导入结果摘要：
    -   新版本的版本号和名称
    -   导入的节点数量
    -   导入的流程数量
    -   导入的步骤数量
    -   警告信息列表（如数据源引用冲突）
-   提供"查看新版本"按钮，跳转到新版本的详情页面
-   新导入的版本默认为"未激活"状态

### 8.3. 权限控制

-   仅"模型设计师"和"系统管理员"角色可以执行导入操作
-   用户只能导入到自己所属的医疗机构
-   系统应记录导入操作的审计日志

### 8.4. 技术实现

#### 8.4.1. 数据模型
-   新增model_version_imports表记录导入历史
-   字段：id, target_version_id, source_version_id, source_hospital_id, import_type, imported_by, import_time, statistics

#### 8.4.2. API接口
-   GET /api/v1/model-versions/importable - 获取可导入版本列表
-   GET /api/v1/model-versions/{id}/preview - 预览版本详情
-   POST /api/v1/model-versions/import - 执行导入操作
-   GET /api/v1/model-versions/{id}/import-info - 获取版本导入信息

#### 8.4.3. 前端组件
-   ModelVersionImportDialog - 4步导入向导组件
-   步骤1：选择版本（列表 + 搜索 + 分页）
-   步骤2：预览详情（统计信息展示）
-   步骤3：配置导入（导入类型 + 新版本信息）
-   步骤4：显示结果（统计 + 警告信息）

### 8.5. 注意事项

-   **不支持导入维度目录映射**：因为收费项目与医疗机构相关，不同医疗机构的收费项目编码可能不同
-   **导入后的版本完全独立**：与源版本完全独立，后续修改互不影响
-   **导入后的版本与本地创建的版本功能相同**：不做特殊区分，用户可以正常编辑、激活、删除
-   **数据源引用处理**：如果计算步骤引用的数据源在目标医疗机构不存在，自动设为NULL并记录警告

### 8.6. 使用场景

1. **跨机构知识共享**：医疗集团内部不同医院可以共享评估模型
2. **快速启动**：新医院可以导入成熟医院的模型版本，快速开始使用
3. **模型优化参考**：可以导入其他医院的优秀模型作为参考，进行本地化调整
4. **版本迁移**：在系统升级或重构时，可以通过导入功能迁移历史版本

### 8.7. 性能要求

-   可导入版本列表加载时间应在5秒内
-   中等规模模型版本（50个节点）的导入应在30秒内完成
-   大规模模型版本（200个节点，10个流程，100个步骤）的导入应在2分钟内完成
