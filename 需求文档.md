# 医院科室业务价值评估工具 - 需求规格说明书 V1.3

> **文档状态**: 草稿 (根据问卷更新)
> **创建日期**: 2025-10-20
> **版本**: 1.3

---

## 1. 简介

### 1.1. 项目目的与范围

本项目旨在开发一个“医院科室业务价值评估工具”。该工具旨在提供一个灵活、可配置的在线平台，用于定义和计算医院各科室的业务价值（即绩效）。通过该平台，医院管理者可以动态定义和调整业务价值的评估模型，模型以多层级结构组织，涵盖医生、护理、医技等多个业务序列及其下的细分维度。

系统通过执行与各维度关联的SQL（或Python代码），从医院现有的PostgreSQL业务数据库中提取量化的工作量数据，结合可配置的权重体系，自动计算出各科室每月的业务价值。计算结果将存回PostgreSQL数据库，并提供界面进行查询、分析和导出为标准格式的Excel报表。

**核心范围包括**：
-   评估模型的在线设计与管理功能（支持版本控制）。
-   数据抽取与计算引擎的后端实现（支持SQL和Python）。
-   手动触发计算任务的功能。
-   评估结果的存储、多维度展示与Excel导出功能。
-   基于角色的数据权限隔离。

### 1.2. 术语定义

| 术语 | 定义 |
|---|---|
| **序列** | 评估模型的第一级分类，代表一个大的业务条线。例如：医生序列、护理序列、医技序列。 |
| **维度** | 评估模型中的具体指标项，是树状结构中的叶子节点。每个维度关联一段SQL或Python代码，用于计算原始工作量。例如：门诊诊察、住院手术、床日护理。 |
| **评估模型** | 由序列和维度构成的完整多层级结构，包括结构本身、各叶子节点的权重以及各维度关联的SQL/Python代码。 |
| **模型版本** | 评估模型在某个时间点的快照。系统支持保存多个版本，以适应评估标准的变化和历史数据回溯的需求。 |
| **工作量** | 通过执行维度SQL/Python得到的原始数值。 |
| **业务价值** | 指科室在特定周期内（按月计算）的最终评估得分，由其下所有维度的工作量经过加权计算后汇总得出。 |
| **当期年月** | 系统全局设置的一个计算周期（年月），所有计算和展示都围绕此周期进行。 |

### 1.3. 目标用户
-   **系统管理员**：负责系统配置、用户管理、数据源连接管理。
-   **模型设计师/管理员**：负责设计和维护评估模型（结构、权重、SQL/Python代码），系统相关配置。
-   **数据分析师/操作员**：负责触发计算、查看和导出结果、调整权重、确认数据口径。
-   **业务专家**：查看和调整模型、权重、触发计算、导出结果，不涉及SQL/Python实现。
-   **科室管理者/院领导**：只读访问，查看本科室或全院的评估结果。

---

## 2. 总体描述

### 2.1. 系统架构
系统采用前后端分离的B/S架构。
-   **前端**：基于现代Web框架（如Vue.js, React）实现，提供基于表格的模型编辑器和数据展示界面。
-   **后端**：使用Python语言开发，提供RESTful API接口。负责业务逻辑、模型管理、计算引擎调度、数据库交互、Excel报表生成等。
-   **数据库**：使用PostgreSQL。上游业务数据存储在单个数据库的特定Schema中，系统对上游数据表具有读写权限。系统自身的配置数据和计算结果存储在新的表中。
-   **任务队列**：引入任务队列（如Celery），用于异步处理耗时的计算任务和报表生成，避免接口长时间阻塞。

### 2.2. 主要限制与假设
-   上游业务数据源为PostgreSQL，数据存储在单个Schema内的多张表中。
-   系统运行所需的数据库账户对上游数据表具有读写权限。
-   科室、人员等基础信息的编码（拼音首字母）与上游系统保持一致。
-   计算按月进行，系统内设置一个全局的“当期年月”参数。
-   初期项目不考虑与医院其他系统（如HIS、LIS）的深度集成，数据交互均通过数据库层完成。
-   权重仅应用于叶子节点（维度）。

---

## 3. 功能性需求

### 3.1. 系统全局设置 (FR-GLOBAL)

#### 3.1.1. 当期年月设置 (FR-GLOBAL-01)
-   系统应提供一个全局设置项，用于配置“当期年月”。
-   此设置将作为所有计算任务的默认计算周期，并在界面中多处显示以保持上下文一致。
-   修改“当期年月”应需要相应权限。

### 3.2. 评估模型管理 (FR-MODEL)

#### 3.2.1. 模型版本管理 (FR-MODEL-01)
-   系统应支持创建、保存和管理多个评估模型版本。
-   每个版本应有唯一的版本号和可选的名称/描述（如“2025年标准版-v1”）。
-   用户可以设置一个“默认”或“活动”版本，用于未来的计算任务。
-   用户可以复制现有版本以创建新版本。
-   计算结果保留所有版本，用户可以选择其中一个版本标记为“最终版”。

#### 3.2.2. 模型结构编辑器 (FR-MODEL-02)
-   系统应提供一个基于表格的界面来展示和编辑评估模型，结构参考Excel模板。
-   模型应支持多层级结构，包括工作量/成本类型、一级维度、二级维度、三级维度。
-   支持在表格中直接进行增加、删除、修改行等操作。
-   选中某一行时，下方或右侧表单区域应显示并可编辑该行的详细属性。

#### 3.2.3. 节点属性配置 (FR-MODEL-03)
-   **所有节点**：应可配置节点名称、编码、业务导向。
-   **叶子节点（维度）**：除上述属性外，还需配置：
    -   **权重/单价**：可以是百分比（如`18.00%`）或固定值（如`200.0元/人天`）。
    -   **计算类型**：提供一个选项，用于标记维度的计算方式（如“统计型”或“计算型”），此标记仅为说明，不影响具体逻辑。
    -   **计算逻辑**：
        -   对于“目录统计型”维度，通过关联的“维度-收费项目”目录进行统计（由用户自己提供SQL查询代码或Python脚本）。
        -   对于“指标计算型”维度，关联自定义的SQL查询代码或Python脚本。
    -   **全院学科业务价值**：用于参考的基准值。
-   权重/单价仅应用于叶子节点，用于计算其得分。

#### 3.2.4. 维度目录管理 (FR-MODEL-04)
-   **目录界面**：系统应提供一个独立的列表界面，用于为每个“目录统计型”维度配置其关联的收费项目。
-   **收费项目来源**：收费项目列表来源于 `dim_sfxmb` 表，使用 `sfxmbm` (收费项目编码) 作为唯一识别符，并显示 `sfxmmc` (收费项目名称)。
-   **配置功能**：
    -   用户可以为选定维度添加或移除多个收费项目。
    -   界面应支持通过收费项目编码或名称进行模糊搜索，以快速定位和添加项目。
    -   每个维度的收费项目目录是独立的，不与其他维度共享。
-   **目录导入导出**：
    -   支持将一个或多个维度的收费项目目录导出为Excel文件。
    -   支持从Excel文件批量导入收费项目目录。导入文件可以包含多个维度的目录配置（例如，将所有手术相关的维度目录放在一个文件中导入）。
    -   系统应提供导入模板，并能在导入时显示预览和错误报告。

#### 3.2.5. 维度目录智能导入 (FR-MODEL-05) - 重要且紧急
-   **导入场景**：将现有的手工制作的维度目录Excel文件导入系统，并自动转换为系统可用的维度-收费项目映射关系。
-   **手工目录特征**：
    -   手工目录通常包含：收费项目编码、维度预案（自然语言描述的维度名称，如"甲级手术D"）、专家意见（缩写形式，如"4D"表示甲级手术D）。
    -   手工目录不区分门诊、手术、病区、非病区等场景，需要系统进行智能映射。
    -   维度预案和专家意见可能同时存在，专家意见优先级高于维度预案。
-   **导入流程**：
    -   **第一步：字段映射**
        -   用户上传Excel文件后，系统解析文件并展示所有列名。
        -   用户指定Excel列与系统字段的对应关系：
            -   收费编码（必填）：对应收费项目编码
            -   维度预案（可选）：对应维度预案列
            -   专家意见（可选）：对应专家意见列
        -   系统应支持智能识别和建议映射关系（如自动识别包含"编码"、"代码"等关键词的列）。
    -   **第二步：维度值映射**
        -   系统提取"维度预案"和"专家意见"两列的所有唯一值。
        -   用户为每个唯一值指定其对应的系统维度（支持一对多映射）。
        -   例如："4D" 可以同时映射到"门诊-甲级手术D"和"住院-甲级手术D"两个维度。
        -   系统应提供智能匹配建议（基于维度名称的模糊匹配）。
        -   用户可以选择忽略某些值（不进行映射）。
    -   **第三步：预览与确认**
        -   系统根据前两步的映射规则，生成准备导入的维度目录数据。
        -   以表格形式展示：收费项目编码、收费项目名称、目标维度、来源（维度预案/专家意见）。
        -   用户可以在此步骤进行最后的调整（删除、修改目标维度）。
        -   系统应标记异常情况：
            -   收费项目编码在系统中不存在（警告，但允许继续）
            -   收费项目已存在于目标维度中（提示，但不强制纠正，因为一个项目可能存在于多个维度）
            -   目标维度不存在（错误，必须修正）
        -   用户确认后，系统执行批量导入，将数据写入 `dimension_item_mappings` 表。
-   **导入策略**：
    -   专家意见优先：如果同一收费项目同时存在维度预案和专家意见，优先采用专家意见的映射结果。
    -   增量导入：导入操作不会删除已有的维度目录数据，只会新增映射关系。
    -   去重处理：如果导入的映射关系已存在（相同的维度ID和收费项目编码），则跳过该条记录。
-   **错误处理**：
    -   导入过程中如果遇到错误（如数据库写入失败），应回滚整个导入操作，保持数据一致性。
    -   导入完成后，系统应生成导入报告，包括：成功导入数量、跳过数量、错误数量及详细错误信息。

#### 3.2.6. SQL/Python编辑器与测试 (FR-MODEL-06)
-   系统应为所有维度提供一个代码编辑区域，支持SQL和Python。
-   编辑器应支持语法高亮（优先级不高）。
-   代码中可使用预设的占位符（如 `{current_year_month}`），计算时由系统自动替换为“当期年月”。
-   提供“测试运行”功能。用户可执行代码并预览返回的结果（通常为按科室聚合的数值列表）。

### 3.3. 科室管理 (FR-DEPT)

#### 3.3.1. 科室对照关系管理 (FR-DEPT-01)
-   **数据源**：科室信息来源于 `dim_ksdmdzb` (科室代码对照表)。
-   **对照管理界面**：系统应提供一个表格界面，用于管理和展示各科室的对照关系。表格应至少包含以下列：
    -   `hisksdm` (HIS科室代码)
    -   `hisksmc` (HIS科室名称)
    -   `cbzxdm` (成本中心代码)
    -   `cbzxmc` (成本中心名称)
    -   `hsdydm` (核算单元代码)
    -   `hsdymc` (核算单元名称)
-   **编辑功能**：系统管理员应能在此界面编辑HIS科室、成本中心和核算单元的对照关系，确保数据的一致性。

#### 3.3.2. 评估范围管理 (FR-DEPT-02)
-   **启用/禁用评估**：在科室管理界面中，应为每个核算单元提供一个“是否参与评估”的勾选框（或开关）。
-   **控制计算范围**：只有被标记为“参与评估”的核算单元，才会被包含在手动触发的计算任务范围内。
-   **默认状态**：新同步或新增的核算单元默认状态可设为“不参与评估”，由管理员手动启用。

### 3.4. 计算引擎 (FR-CALC)

#### 3.4.1. 计算任务创建与触发 (FR-CALC-01)
-   用户应能手动创建计算任务。
-   创建任务时需指定：
    -   要计算的科室范围（单个、多个或全部科室）。当选择“全部科室”时，系统将仅计算在【科室管理】中标记为“参与评估”的核算单元。
    -   要使用的评估模型版本。
    -   计算周期默认使用系统设置的“当期年月”。
-   系统不支持自动定时计算。

#### 3.4.2. 计算过程 (FR-CALC-02)
-   任务启动后，后端应将其加入异步任务队列执行。
-   对每个待计算的科室，引擎遍历所选模型版本的所有叶子节点。
-   对每个叶子节点，引擎擎执行其关联的SQL或Python代码，获取该科室的工作量原始数值。
-   根据叶子节点的权重/单价类型（百分比或固定值），计算维度得分。
-   系统根据模型结构，自下而上逐级汇总得分，最终得到科室各序列（医生、护理、医技）的总价值和科室总价值。

#### 3.4.3. 任务监控与日志 (FR-CALC-03)
-   系统应提供一个任务列表，显示所有历史和正在运行的计算任务的状态（排队中、运行中、已完成、失败）。
-   对于失败的任务，应能查看详细的错误日志（如哪个科室、哪个维度的代码执行失败及其原因）。
-   支持对失败的任务进行重试。

### 3.4. 结果管理与展示 (FR-RESULT)

#### 3.4.1. 结果数据存储 (FR-RESULT-01)
-   每次计算任务的详细结果都应被持久化到结果数据库中。
-   应存储：任务ID、模型版本、科室ID、评估周期、各层级节点的名称/ID、原始工作量、权重/单价、各级得分、科室总价值。
-   历史结果应被完整保留，不被新计算覆盖，以供追溯和对比。

#### 3.4.2. 结果查询与展示 (FR-RESULT-02)
-   提供结果查询界面，用户可按时间周期、模型版本、科室等条件筛选查看评估结果。
-   **核心展示1：绩效结构表**
    -   为每个科室生成结构化的绩效表，格式严格遵循《绩效结构表（模板）-标准版-20251017-v1.xlsx》，具体结构根据实际模型而定。
    -   表格应包含工作量/成本、各级维度、全院学科业务价值、业务导向、科室综合价值、各级占比、各级金额等列。
    -   支持在线查看和交互。
-   **核心展示2：科室业务价值汇总表**
    -   提供一张全院科室汇总表，包含：科室、医生价值、医生占比、护理价值、护理占比、医技价值、医技占比、科室总价值、诊断收入、执行收入、门急诊数量、占用床日数。
    -   此表应包含全院的汇总行。
    -   支持在线查看和交互。

#### 3.4.3. 结果导出 (FR-RESULT-03)
-   **绩效结构表导出**：用户可以选择一个或多个科室，导出其绩效结构表为Excel文件，格式与模板一致。
-   **汇总表导出**：用户可以导出科室业务价值汇总表为Excel文件。
-   导出功能应为异步任务，完成后提供文件下载链接。

### 3.5. 系统与用户管理 (FR-SYS)

#### 3.5.1. 用户与角色管理 (FR-SYS-01)
-   系统管理员可以创建、修改、禁用用户。
-   系统应支持角色管理，管理员可以创建角色并为角色分配权限。
-   **关键权限控制**：
    -   **模型设计师/管理员**：模型编辑、系统配置。
    -   **数据分析师/操作员**：触发计算、查看/导出所有结果、调整权重。
    -   **业务专家**：查看/调整模型和权重、触发计算、导出结果，但不能修改代码。
    -   **科室管理者/院领导**：只能查看其所在科室或授权范围内的结果。
-   用户可以被分配一个或多个角色。

#### 3.5.2. 数据权限隔离 (FR-SYS-02)
-   系统必须实现严格的数据权限隔离。
-   科室级别的用户（如科室主任）登录后，只能查看与自己科室相关的数据，不能查看其他科室的详细得分构成。
-   院领导或具有全院权限的用户可以查看所有科室的数据。

---

## 4. 非功能性需求

### 4.1. 性能
-   **UI响应**：所有页面操作的响应时间应在2秒以内。
-   **计算效率**：
    -   **中型医院**（10-20个科室，每月100万条收费明细）：单次完整计算（全院所有科室）应在1小时内完成。
    -   **大型医院**（每月1000万条收费明细）：计算时间可接受更长，但应提供明确的进度反馈。
-   **数据查询**：结果查询和展示操作的响应时间应在3秒以内。
-   **报表导出**：Excel报表生成任务应在后台异步执行，对于大型报表，生成时间应在5分钟内完成。

### 4.2. 安全性
-   用户需要通过用户名和密码登录系统。
-   密码在数据库中必须加密存储。
-   系统需实现基于角色的访问控制（RBAC），确保用户只能访问其权限范围内的功能和数据。
-   **数据隔离**：必须严格实现科室间的数据权限隔离，确保用户无法访问未授权科室的数据。
-   不需要与医院现有的统一认证系统（如LDAP/AD）集成。

### 4.3. 可用性与可靠性
-   系统应提供清晰、一致、简洁的用户界面，优先考虑实用性而非炫酷的交互效果。
-   核心计算过程应有详细的日志记录和错误处理机制，确保数据计算的准确性和可追溯性。
-   系统应能7x24小时稳定运行。
-   对于耗时的操作（如计算、导出），应提供明确的进度指示。

### 4.4. 可维护性
-   前后端代码应遵循统一的编码规范，有清晰的模块划分和必要的注释。
-   评估模型的导入导出功能（推荐），便于备份和迁移。
-   系统应具备良好的扩展性，以支持未来可能增加的计算逻辑（如AI辅助SQL检查）。

---

## 5. 附录

### 5.1. 参考文件
-   《绩效结构表（模板）-标准版-20251017-v1.xlsx》：定义了最终输出的核心报表格式。
-   《需求调研问卷.md》：包含了本次需求分析的详细用户输入。

### 5.2. 数据库表示例
#### 5.2.1. 上游业务表示例
-   `dwd_sfmxb` (收费明细表)：包含收费明细，关键字段包括 `sj` (时间), `kdksid` (开单科室ID), `fy` (费用), `sfbm` (收费编码) 等。
-   `dim_ksdmdzb` (科室代码对照表)：包含科室信息，关键字段包括 `hisksdm` (HIS科室代码), `hisksmc` (HIS科室名称) 等。
-   `dim_sfxmb` (收费项目表)：作为维度目录管理的来源，关键字段包括 `sfxmbm` (收费项目编码), `sfxmmc` (收费项目名称), `sflb` (收费类别) 等。

#### 5.2.2. 系统结果表示例（待设计）
-   `calc_tasks` (计算任务表)：存储计算任务信息。
-   `model_versions` (模型版本表)：存储评估模型的版本信息。
-   `model_nodes` (模型节点表)：存储模型的结构节点。
-   `dimension_item_mapping` (维度-收费项目映射表)：存储“统计型”维度与收费项目的关联关系。
-   `calc_results_detail` (计算结果明细表)：存储各科室、各维度的详细计算结果。
-   `calc_results_summary` (计算结果汇总表)：存储科室级别的汇总结果。