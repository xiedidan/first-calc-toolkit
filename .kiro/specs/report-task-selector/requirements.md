# 需求文档

## 简介

本功能旨在改进业务价值报表的任务选择机制，允许用户在报表页面直接选择特定的计算任务查看结果，同时支持从计算任务管理页面直接跳转并自动带入任务ID。

## 术语表

- **报表系统 (Report System)**: 展示业务价值计算结果的前端模块，包括汇总表和明细表
- **计算任务 (Calculation Task)**: 后端执行的业务价值计算作业，每个任务有唯一的task_id
- **任务选择器 (Task Selector)**: 前端下拉选择组件，用于选择特定的计算任务
- **任务管理页面 (Task Management Page)**: 显示所有计算任务列表的页面（CalculationTasks.vue）
- **URL参数 (URL Parameter)**: 通过路由query传递的参数，用于页面间数据传递

## 需求

### 需求 1: 报表页面任务选择器

**用户故事:** 作为医院管理员，我希望在报表页面能够选择特定的计算任务查看结果，以便对比不同时间点或不同配置的计算结果

#### 验收标准

1. WHEN 用户访问报表页面，THE 报表系统 SHALL 在筛选条件区域显示任务ID选择器
2. WHEN 用户展开任务选择器，THE 报表系统 SHALL 显示当前评估月份和模型版本对应的所有已完成任务
3. WHEN 用户选择特定任务，THE 报表系统 SHALL 加载该任务的计算结果并更新汇总表
4. WHEN 用户未选择任务，THE 报表系统 SHALL 默认使用最新完成的任务
5. WHEN 用户更改评估月份或模型版本，THE 报表系统 SHALL 重新加载任务列表并清空当前选择

### 需求 2: 任务管理页面跳转集成

**用户故事:** 作为医院管理员，我希望在计算任务管理页面点击"查看结果"时能直接跳转到对应任务的报表，以便快速查看刚完成的计算结果

#### 验收标准

1. WHEN 用户在任务管理页面点击某个已完成任务的"查看结果"按钮，THE 任务管理页面 SHALL 跳转到报表页面并传递task_id参数
2. WHEN 报表页面接收到URL中的task_id参数，THE 报表系统 SHALL 自动选中该任务并加载对应结果
3. WHEN 报表页面接收到task_id参数，THE 报表系统 SHALL 从任务信息中提取评估月份和模型版本ID并设置筛选条件
4. WHEN 用户在报表页面手动更改筛选条件，THE 报表系统 SHALL 清除URL中的task_id参数

### 需求 3: 任务列表API支持

**用户故事:** 作为系统开发者，我需要后端API支持按评估月份和模型版本筛选任务列表，以便前端能够正确显示可选任务

#### 验收标准

1. WHEN 前端请求任务列表，THE 后端API SHALL 支持period和model_version_id作为查询参数
2. WHEN 前端请求任务列表，THE 后端API SHALL 仅返回状态为"completed"的任务
3. WHEN 前端请求任务列表，THE 后端API SHALL 按完成时间降序排列任务
4. WHEN 前端请求任务列表，THE 后端API SHALL 应用医疗机构隔离过滤

### 需求 4: 明细查看功能增强

**用户故事:** 作为医院管理员，我希望在查看科室明细时使用当前选中的任务ID，以确保汇总表和明细表数据一致

#### 验收标准

1. WHEN 用户在汇总表中点击"查看明细"，THE 报表系统 SHALL 使用当前选中的任务ID请求明细数据
2. WHEN 当前没有选中任务但存在默认任务，THE 报表系统 SHALL 使用默认任务ID请求明细数据
3. WHEN 没有可用的任务ID，THE 报表系统 SHALL 显示错误提示"缺少任务ID，无法查看明细"
4. WHEN 明细对话框打开，THE 报表系统 SHALL 在标题中显示任务ID和评估月份

### 需求 5: 导出功能任务关联

**用户故事:** 作为医院管理员，我希望导出的报表文件对应当前选中的任务，以便准确追溯数据来源

#### 验收标准

1. WHEN 用户点击"导出明细表"，THE 报表系统 SHALL 使用当前选中的任务ID作为导出参数
2. WHEN 用户点击"导出汇总表"，THE 报表系统 SHALL 使用当前的评估月份和模型版本作为导出参数
3. WHEN 导出明细表时没有可用任务ID，THE 报表系统 SHALL 显示警告"缺少任务ID，无法导出明细"
4. WHEN 导出成功，THE 报表系统 SHALL 在文件名中包含任务ID或评估月份信息
