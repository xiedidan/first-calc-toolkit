# 数据模型管理模块 - 需求文档

## 简介

本模块用于管理医院需要为系统提供的原始数据模板清单和详细信息。数据模板包括表定义文档、SQL示例建表代码、表说明以及是否为核心表的标志。

## 术语定义

| 术语 | 定义 |
|---|---|
| **数据模板** | 医院需要提供的原始数据表的完整定义,包括表名、中文名、表定义文档、SQL建表代码、说明和核心标志 |
| **表定义文档** | Markdown格式的文档,详细描述表的结构、字段说明等,命名格式为"中文名(表名).md" |
| **SQL建表代码** | SQL格式的示例建表脚本,命名格式为"表名.sql" |
| **核心表** | 系统运行必需的关键数据表 |
| **医疗机构隔离** | 不同医疗机构的数据模板相互独立,互不影响 |

## 需求

### 需求 1: 数据模板基本管理

**用户故事**: 作为系统管理员,我希望能够管理数据模板清单,以便明确医院需要提供哪些数据表。

#### 验收标准

1. WHEN 管理员访问数据模板管理页面, THE 系统 SHALL 显示当前医疗机构的所有数据模板列表
2. WHILE 查看数据模板列表, THE 系统 SHALL 按照排序序号(sort_order)升序展示数据模板
3. THE 系统 SHALL 为每个数据模板显示表名、中文名、是否核心、排序序号和操作按钮
4. WHEN 管理员点击"新建数据模板"按钮, THE 系统 SHALL 打开数据模板创建对话框
5. WHEN 管理员在创建对话框中填写表名、中文名、说明等信息并提交, THE 系统 SHALL 创建新的数据模板记录
6. WHEN 管理员点击"编辑"按钮, THE 系统 SHALL 打开数据模板编辑对话框并显示当前数据
7. WHEN 管理员在编辑对话框中修改信息并提交, THE 系统 SHALL 更新数据模板记录
8. WHEN 管理员点击"删除"按钮并确认, THE 系统 SHALL 删除该数据模板记录及其关联的文件

### 需求 2: 文件上传管理

**用户故事**: 作为系统管理员,我希望能够上传表定义文档和SQL建表代码,以便完善数据模板的详细信息。

#### 验收标准

1. WHEN 管理员在数据模板编辑对话框中点击"上传表定义文档"按钮, THE 系统 SHALL 打开文件选择对话框
2. WHEN 管理员选择Markdown文件(.md)并上传, THE 系统 SHALL 保存文件并关联到该数据模板
3. WHEN 管理员在数据模板编辑对话框中点击"上传SQL建表代码"按钮, THE 系统 SHALL 打开文件选择对话框
4. WHEN 管理员选择SQL文件(.sql)并上传, THE 系统 SHALL 保存文件并关联到该数据模板
5. WHEN 数据模板已有表定义文档, THE 系统 SHALL 在编辑对话框中显示文档名称和下载链接
6. WHEN 数据模板已有SQL建表代码, THE 系统 SHALL 在编辑对话框中显示文件名称和下载链接
7. WHEN 管理员点击文档或代码的下载链接, THE 系统 SHALL 下载对应的文件
8. WHEN 管理员上传新文件替换已有文件, THE 系统 SHALL 删除旧文件并保存新文件

### 需求 3: 批量上传功能

**用户故事**: 作为系统管理员,我希望能够批量上传多个表定义文档和SQL文件,以便快速导入大量数据模板。

#### 验收标准

1. WHEN 管理员点击"批量上传"按钮, THE 系统 SHALL 打开批量上传对话框
2. WHEN 管理员选择多个Markdown文件和SQL文件并上传, THE 系统 SHALL 解析文件名并提取表名和中文名
3. WHERE 表定义文档命名格式为"中文名(表名).md", THE 系统 SHALL 从文件名中提取中文名和表名
4. WHERE SQL文件命名格式为"表名.sql", THE 系统 SHALL 从文件名中提取表名
5. WHEN 系统解析完文件名, THE 系统 SHALL 根据表名匹配表定义文档和SQL文件
6. WHEN 系统完成文件匹配, THE 系统 SHALL 显示匹配结果预览表格
7. WHILE 显示匹配结果, THE 系统 SHALL 为每个匹配项显示表名、中文名、表定义文档、SQL文件和匹配状态
8. WHEN 管理员确认批量上传, THE 系统 SHALL 为每个匹配项创建或更新数据模板记录
9. IF 表名已存在, THEN THE 系统 SHALL 更新现有数据模板的文件
10. IF 表名不存在, THEN THE 系统 SHALL 创建新的数据模板记录
11. WHEN 批量上传完成, THE 系统 SHALL 显示导入结果报告(成功数量、失败数量、详细信息)

### 需求 4: 排序管理

**用户故事**: 作为系统管理员,我希望能够调整数据模板的显示顺序,以便按照重要性或逻辑关系组织数据模板清单。

#### 验收标准

1. WHEN 管理员点击数据模板的"上移"按钮, THE 系统 SHALL 将该数据模板的排序序号减小,并与上一条数据模板交换位置
2. WHEN 管理员点击数据模板的"下移"按钮, THE 系统 SHALL 将该数据模板的排序序号增大,并与下一条数据模板交换位置
3. WHEN 数据模板已经是第一条, THE 系统 SHALL 禁用"上移"按钮
4. WHEN 数据模板已经是最后一条, THE 系统 SHALL 禁用"下移"按钮
5. WHEN 管理员调整排序后, THE 系统 SHALL 立即保存新的排序序号到数据库
6. WHEN 管理员刷新页面, THE 系统 SHALL 按照最新的排序序号显示数据模板列表

### 需求 5: 核心表标记

**用户故事**: 作为系统管理员,我希望能够标记哪些数据表是核心表,以便区分必需表和可选表。

#### 验收标准

1. WHEN 管理员点击数据模板的"设置核心"按钮, THE 系统 SHALL 切换该数据模板的核心标志
2. WHEN 数据模板被标记为核心表, THE 系统 SHALL 在列表中显示核心标志图标或徽章
3. WHEN 数据模板被取消核心标记, THE 系统 SHALL 移除核心标志图标或徽章
4. WHEN 管理员切换核心标志, THE 系统 SHALL 立即保存到数据库
5. THE 系统 SHALL 支持按核心标志筛选数据模板列表

### 需求 6: 医疗机构隔离

**用户故事**: 作为系统管理员、普通用户,我希望数据模板在不同医疗机构之间相互隔离,以便每个医疗机构管理自己的数据模板。

#### 验收标准

1. WHEN 管理员、普通用户登录系统, THE 系统 SHALL 识别当前激活的医疗机构
2. WHEN 管理员、普通用户访问数据模板管理页面, THE 系统 SHALL 仅显示当前激活医疗机构的数据模板
3. WHEN 管理员、普通用户创建数据模板, THE 系统 SHALL 自动关联到当前激活的医疗机构
4. WHEN 管理员、普通用户查询、编辑或删除数据模板, THE 系统 SHALL 验证数据模板属于当前激活的医疗机构
5. IF 管理员、普通用户尝试访问其他医疗机构的数据模板, THEN THE 系统 SHALL 返回权限错误

### 需求 7: 跨医疗机构复制

**用户故事**: 作为系统管理员,我希望能够复制其他医疗机构的数据模板,以便快速建立本医疗机构的数据模板清单。

#### 验收标准

1. WHEN 管理员点击"复制数据模板"按钮, THE 系统 SHALL 打开医疗机构选择对话框
2. WHEN 管理员选择源医疗机构, THE 系统 SHALL 显示该医疗机构的数据模板列表
3. WHEN 管理员选择要复制的数据模板并确认, THE 系统 SHALL 复制选中的数据模板到当前医疗机构，可以全选或勾选
4. WHEN 系统复制数据模板, THE 系统 SHALL 同时复制表定义文档和SQL建表代码文件
5. WHEN 系统复制数据模板, THE 系统 SHALL 将hospital_id设置为当前医疗机构ID
6. IF 目标医疗机构已存在相同表名的数据模板, THEN THE 系统 SHALL 提示用户选择覆盖或跳过
7. WHEN 复制完成, THE 系统 SHALL 显示复制结果报告(成功数量、跳过数量、失败数量)

### 需求 8: 搜索和筛选

**用户故事**: 作为系统管理员、普通用户,我希望能够搜索和筛选数据模板,以便快速找到需要的数据表。

#### 验收标准

1. WHEN 管理员、普通用户,在搜索框中输入关键词, THE 系统 SHALL 实时搜索表名、中文名和说明字段
2. WHEN 管理员、普通用户,选择"仅显示核心表"筛选项, THE 系统 SHALL 仅显示核心标志为true的数据模板
5. WHEN 管理员、普通用户,清空搜索和筛选条件, THE 系统 SHALL 显示所有数据模板

### 需求 9: 数据验证

**用户故事**: 作为系统管理员,我希望系统能够验证数据模板的完整性,以便确保数据质量。

#### 验收标准

1. WHEN 管理员创建或编辑数据模板, THE 系统 SHALL 验证表名不为空且符合命名规范
2. WHEN 管理员创建或编辑数据模板, THE 系统 SHALL 验证表名在当前医疗机构内唯一
3. WHEN 管理员创建或编辑数据模板, THE 系统 SHALL 验证中文名不为空
4. WHEN 管理员上传表定义文档, THE 系统 SHALL 验证文件格式为.md
5. WHEN 管理员上传SQL建表代码, THE 系统 SHALL 验证文件格式为.sql
6. WHEN 管理员上传文件, THE 系统 SHALL 验证文件大小不超过10MB
7. IF 验证失败, THEN THE 系统 SHALL 显示详细的错误信息并阻止提交

### 需求 10: 文件存储

**用户故事**: 作为系统,我需要安全地存储上传的文件,以便管理员随时下载和查看。

#### 验收标准

1. WHEN 管理员上传文件, THE 系统 SHALL 将文件保存到服务器的指定目录
2. THE 系统 SHALL 为每个文件生成唯一的文件名以避免冲突
3. THE 系统 SHALL 在数据库中记录文件的原始文件名、存储路径和上传时间
4. WHEN 管理员下载文件, THE 系统 SHALL 使用原始文件名作为下载文件名
5. WHEN 数据模板被删除, THE 系统 SHALL 同时删除关联的文件
6. THE 系统 SHALL 定期清理孤立文件(数据库中无记录的文件)
