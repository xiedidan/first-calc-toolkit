# 实施计划 - 成本基准管理

## 任务列表

- [x] 1. 创建数据库模型和迁移




  - 创建 CostBenchmark 模型类
  - 定义字段、关系和约束
  - 创建 Alembic 迁移脚本
  - 执行迁移并验证表结构
  - _需求：1.1, 2.4, 6.1, 6.2_

- [ ]* 1.1 编写模型单元测试
  - **属性 8：唯一性约束**
  - **验证需求：2.5**

- [ ]* 1.2 编写属性测试：多租户数据创建
  - **属性 2：创建时自动关联医疗机构**
  - **验证需求：6.2**
-

- [x] 2. 创建 Pydantic Schemas



  - 创建 CostBenchmarkBase schema
  - 创建 CostBenchmarkCreate schema
  - 创建 CostBenchmarkUpdate schema
  - 创建 CostBenchmark schema（响应模型）
  - 创建 CostBenchmarkList schema
  - 添加字段验证规则（基准值>0等）
  - _需求：2.2, 2.3, 8.1, 8.2_

- [ ]* 2.1 编写 schema 验证测试
  - **属性 10：基准值范围验证**
  - **验证需求：2.3, 3.2, 8.2**

- [ ]* 2.2 编写属性测试：必填字段验证
  - **属性 14：必填字段验证**
  - **验证需求：8.1**
-

- [x] 3. 实现后端 API 端点




  - 创建 cost_benchmarks.py 路由文件
  - 实现 GET /cost-benchmarks（列表查询）
  - 实现 POST /cost-benchmarks（创建）
  - 实现 GET /cost-benchmarks/{id}（详情）
  - 实现 PUT /cost-benchmarks/{id}（更新）
  - 实现 DELETE /cost-benchmarks/{id}（删除）
  - 添加多租户过滤和验证
  - 添加错误处理
  - _需求：1.1, 2.1-2.5, 3.1-3.4, 4.1-4.3, 6.1-6.3_

- [ ]* 3.1 编写 API 端点单元测试
  - 测试每个端点的基本功能
  - 测试参数验证
  - 测试错误响应
  - _需求：所有API相关需求_

- [ ]* 3.2 编写属性测试：多租户查询隔离
  - **属性 1：多租户数据隔离**
  - **验证需求：6.1**

- [ ]* 3.3 编写属性测试：跨租户访问控制
  - **属性 3：跨租户访问控制**
  - **验证需求：6.3**

- [ ]* 3.4 编写属性测试：筛选功能
  - **属性 4：版本筛选正确性**
  - **属性 5：科室筛选正确性**
  - **属性 6：维度筛选正确性**
  - **验证需求：1.2, 1.3, 1.4**

- [ ]* 3.5 编写属性测试：搜索功能
  - **属性 7：关键词搜索正确性**
  - **验证需求：1.5**

- [ ]* 3.6 编写属性测试：唯一性约束
  - **属性 8：唯一性约束**
  - **属性 9：更新唯一性约束**
  - **验证需求：2.5, 3.4**

- [ ]* 3.7 编写属性测试：删除操作
  - **属性 11：删除操作正确性**
  - **验证需求：4.2**

- [ ]* 3.8 编写属性测试：外键验证
  - **属性 15：外键引用验证**
  - **验证需求：2.2**
-

- [x] 4. 实现 Excel 导出功能



  - 实现 GET /cost-benchmarks/export 端点
  - 使用 openpyxl 生成 Excel 文件
  - 设置列标题和数据格式
  - 设置中文文件名和时间戳
  - 处理空数据情况
  - 应用多租户过滤
  - _需求：5.1-5.4, 6.4_

- [ ]* 4.1 编写导出功能测试
  - **属性 12：导出数据一致性**
  - **属性 13：导出字段完整性**
  - **验证需求：5.1, 5.2**
-

- [x] 5. 注册 API 路由



  - 在 backend/app/main.py 中注册 cost_benchmarks 路由
  - 设置路由前缀为 /api/v1/cost-benchmarks
  - 添加路由标签
  - _需求：所有API需求_


- [x] 6. 创建前端 TypeScript 类型定义



  - 创建 CostBenchmark 接口
  - 创建 CostBenchmarkCreate 接口
  - 创建 CostBenchmarkList 接口
  - _需求：前端所有需求_
-

- [x] 7. 创建前端 API 服务




  - 创建 frontend/src/api/cost-benchmarks.ts
  - 实现 getCostBenchmarks 方法
  - 实现 createCostBenchmark 方法
  - 实现 updateCostBenchmark 方法
  - 实现 deleteCostBenchmark 方法
  - 实现 exportCostBenchmarks 方法
  - _需求：前端所有需求_


- [x] 8. 创建前端主页面组件



  - 创建 frontend/src/views/CostBenchmarks.vue
  - 实现页面布局（卡片、表头、搜索表单）
  - 实现数据表格（使用 border、stripe、v-loading）
  - 实现分页组件
  - 应用统一的样式类（card-header、search-form等）
  - _需求：1.1, 7.1-7.5_

- [x] 9. 实现搜索和筛选功能



- [ ] 9. 实现搜索和筛选功能
  - 添加模型版本选择器
  - 添加科室选择器
  - 添加维度选择器
  - 添加关键词搜索输入框
  - 实现查询按钮逻辑
  - 实现重置按钮逻辑
  - 实现筛选条件变化时的自动查询
  - _需求：1.2-1.5_

- [x] 10. 实现创建功能





  - 创建添加对话框（600px宽度，append-to-body）
  - 实现表单（label-width: 120px）
  - 添加科室选择器（带搜索）
  - 添加模型版本选择器
  - 添加维度选择器（带搜索）
  - 添加基准值输入框（数字输入，最小值0）
  - 实现表单验证
  - 实现提交逻辑
  - 处理成功和错误情况
  - _需求：2.1-2.5, 8.1-8.4_

- [x] 11. 实现编辑功能




  - 创建编辑对话框（复用创建对话框）
  - 实现数据预填充
  - 实现更新提交逻辑
  - 处理唯一性约束冲突
  - _需求：3.1-3.4_


- [x] 12. 实现删除功能


  - 实现删除确认对话框
  - 实现删除API调用
  - 刷新列表
  - 显示成功消息
  - _需求：4.1-4.3_

- [x] 13. 实现导出功能




  - 添加导出按钮
  - 实现导出API调用
  - 处理文件下载
  - 处理空数据情况
  - 显示加载状态
  - _需求：5.1-5.4_

- [x] 14. 添加前端路由





  - 在 frontend/src/router/index.ts 中添加路由配置
  - 设置路由路径为 /cost-benchmarks
  - 设置页面标题和权限要求
  - _需求：7.1_

-

- [x] 15. 添加菜单项


  - 在 frontend/src/views/Layout.vue 中添加菜单项
  - 设置菜单图标和文本
  - 设置菜单路由
  - 确保菜单位置在维度目录管理之后
  - _需求：7.1, 7.5_
- [x] 16. 实现错误处理




- [ ] 16. 实现错误处理

  - 添加 API 错误拦截器
  - 实现用户友好的错误消息显示
  - 处理网络超时
  - 处理表单验证错误
  - _需求：8.1-8.4_


- [x] 17. 添加加载状态



  - 为表格添加 v-loading
  - 为对话框提交按钮添加 loading 状态
  - 为导出按钮添加 loading 状态
  - _需求：7.2_

- [ ] 18. 优化用户体验





  - 实现搜索输入防抖
  - 实现下拉选项懒加载
  - 添加操作成功的提示消息
  - 优化表格列宽
  - 添加空数据提示
  - _需求：用户体验相关_

-

- [x] 19. Checkpoint - 确保所有测试通过



  - 运行所有单元测试
  - 运行所有属性测试
  - 修复任何失败的测试
  - 确认代码质量

- [ ]* 20. 编写集成测试
  - 测试完整的创建-查询-更新-删除流程
  - 测试多条件筛选和搜索
  - 测试导出功能
  - 测试多租户场景
  - _需求：所有需求_
-

- [x] 21. 文档和部署准备




  - 更新 API 文档
  - 创建用户使用指南
  - 准备数据库迁移脚本
  - 验证部署清单
  - _需求：部署相关_

## 注意事项

1. **多租户隔离**：所有数据库操作必须包含 hospital_id 过滤
2. **样式一致性**：严格遵循现有模块的样式规范
3. **错误处理**：提供清晰的用户反馈
4. **数据验证**：前后端双重验证
5. **测试覆盖**：确保核心功能有充分的测试覆盖

## 依赖关系

- 任务 2 依赖任务 1（模型定义）
- 任务 3 依赖任务 1 和 2（模型和 schema）
- 任务 4 依赖任务 1 和 2
- 任务 5 依赖任务 3 和 4
- 任务 6-7 可以与后端任务并行
- 任务 8-13 依赖任务 6 和 7
- 任务 14-15 依赖任务 8
- 任务 16-18 可以在主要功能完成后进行
- 任务 19 依赖所有前面的任务
- 任务 20 依赖任务 19
- 任务 21 依赖所有任务完成
