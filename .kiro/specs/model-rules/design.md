# 设计文档 - 模型规则展示功能

## 概述

本文档描述了模型规则展示功能的详细设计方案。该功能为模型节点添加规则字段，并提供独立的规则展示页面，以树形结构展示所有节点的规则说明。

## 架构设计

### 系统组件

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Vue.js)                       │
├─────────────────────────────────────────────────────────┤
│  ModelVersions.vue  │  ModelNodes.vue  │  ModelRules.vue│
│  (版本列表)         │  (结构编辑)      │  (规则展示)    │
└─────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    API层 (FastAPI)                       │
├─────────────────────────────────────────────────────────┤
│              /model-nodes (已存在)                       │
│              - GET /model-nodes?version_id={id}         │
│              - PUT /model-nodes/{id}                    │
└─────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  数据库层 (PostgreSQL)                   │
├─────────────────────────────────────────────────────────┤
│              model_nodes 表                              │
│              - rule 字段 (TEXT, 已存在)                  │
└─────────────────────────────────────────────────────────┘
```

## 详细设计

### 1. 数据模型

#### 1.1 数据库设计

`model_nodes` 表中的 `rule` 字段已存在，无需修改数据库结构：

```sql
-- 已存在的字段
rule TEXT COMMENT '规则说明'
```

#### 1.2 后端Schema

`ModelNodeBase` Schema 已包含 `rule` 字段，无需修改：

```python
class ModelNodeBase(BaseModel):
    # ... 其他字段
    rule: Optional[str] = Field(None, description="规则说明")
```

### 2. 后端设计

#### 2.1 API接口

**无需新增API接口**，使用现有的模型节点API：

1. **获取节点列表（含规则）**
   - 接口：`GET /model-nodes?version_id={id}`
   - 说明：已返回 `rule` 字段，无需修改

2. **更新节点（含规则）**
   - 接口：`PUT /model-nodes/{id}`
   - 说明：已支持 `rule` 字段更新，无需修改

#### 2.2 数据处理

后端已完整支持 `rule` 字段的读写，无需修改代码。

### 3. 前端设计

#### 3.1 路由配置

在 `frontend/src/router/index.ts` 中添加新路由：

```typescript
{
  path: '/model-rules/:versionId',
  name: 'ModelRules',
  component: () => import('@/views/ModelRules.vue'),
  meta: { title: '模型规则展示' }
}
```

#### 3.2 组件设计

##### 3.2.1 ModelVersions.vue（修改）

在版本列表的操作列中添加"查看规则"按钮：

```vue
<el-button link type="info" @click="handleViewRules(row)">
  <el-icon><Document /></el-icon>
  查看规则
</el-button>
```

##### 3.2.2 ModelNodes.vue（修改）

在节点编辑对话框中已包含规则输入框，需要确保：
- 规则输入框支持多行文本（textarea）
- 显示字数统计（maxlength + show-word-limit）
- 规则字段为可选项

当前实现已满足要求，无需修改。

##### 3.2.3 ModelRules.vue（新增）

创建独立的规则展示页面，使用 Element Plus 的 Tree 组件：

**组件结构：**
```vue
<template>
  <div class="model-rules-container">
    <el-card>
      <template #header>
        <!-- 页面标题和返回按钮 -->
      </template>
      
      <!-- 树形结构展示 -->
      <el-tree
        :data="treeData"
        :props="treeProps"
        default-expand-all
        node-key="id"
      >
        <template #default="{ node, data }">
          <!-- 节点信息和规则展示 -->
        </template>
      </el-tree>
    </el-card>
  </div>
</template>
```

**数据结构：**
```typescript
interface TreeNode {
  id: number
  label: string        // 节点名称
  code: string         // 节点编码
  node_type: string    // 节点类型
  is_leaf: boolean     // 是否末级
  rule?: string        // 规则说明
  children?: TreeNode[]
}
```

**核心功能：**
1. 从API获取节点数据并转换为树形结构
2. 展示节点基本信息（名称、编码、类型标签）
3. 展示规则说明内容（保持文本格式）
4. 处理空规则的情况（显示"暂无规则说明"）

#### 3.3 API调用

使用现有的 `getModelNodes` API：

```typescript
import { getModelNodes } from '@/api/model'

// 获取节点数据
const fetchData = async () => {
  const res = await getModelNodes({ version_id: versionId.value })
  treeData.value = res.items
}
```

### 4. UI设计

#### 4.1 ModelVersions.vue 修改

在操作列添加"查看规则"按钮，位置在"编辑结构"按钮之后：

```
┌─────────────────────────────────────────────────────────┐
│ 操作                                                     │
├─────────────────────────────────────────────────────────┤
│ [编辑结构] [查看规则] [激活] [复制] [编辑] [删除]        │
└─────────────────────────────────────────────────────────┘
```

#### 4.2 ModelNodes.vue 修改

编辑对话框中的规则输入框（已存在）：

```
┌─────────────────────────────────────────────────────────┐
│ 规则说明                                                 │
├─────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────┐ │
│ │ [多行文本输入框，5行高度]                            │ │
│ │                                                       │ │
│ │                                                       │ │
│ │                                                       │ │
│ └─────────────────────────────────────────────────────┘ │
│                                          0/1000          │
└─────────────────────────────────────────────────────────┘
```

#### 4.3 ModelRules.vue 新页面

规则展示页面布局：

```
┌─────────────────────────────────────────────────────────┐
│ [← 返回版本列表]  模型规则展示 - 版本名称 (版本号)       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ▼ 医生序列 [序列] (DOCTOR)                              │
│   │                                                      │
│   │ 规则说明：                                           │
│   │ 医生序列包含所有与医生工作量相关的维度...            │
│   │                                                      │
│   ├─ ▼ 门诊诊察 [维度] [末级] (OUTPATIENT)              │
│   │   │                                                  │
│   │   │ 规则说明：                                       │
│   │   │ 统计门诊医生的诊察工作量，包括普通门诊、        │
│   │   │ 专家门诊等。计算公式为...                        │
│   │   │                                                  │
│   │                                                      │
│   └─ ▼ 住院手术 [维度] [末级] (SURGERY)                 │
│       │                                                  │
│       │ 规则说明：                                       │
│       │ 暂无规则说明                                     │
│       │                                                  │
│                                                          │
│ ▼ 护理序列 [序列] (NURSE)                               │
│   ...                                                    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**样式设计：**
- 节点名称：16px，加粗
- 节点编码：14px，灰色，括号包裹
- 类型标签：使用 Element Plus Tag 组件
  - 序列：蓝色 (primary)
  - 维度：绿色 (success)
  - 末级：橙色 (warning)
- 规则说明：14px，灰色背景，圆角边框，内边距
- 空规则提示：14px，浅灰色，斜体

### 5. 交互设计

#### 5.1 页面导航

1. **进入规则展示页面**
   - 用户在模型版本列表点击"查看规则"按钮
   - 系统导航到 `/model-rules/:versionId`

2. **返回版本列表**
   - 用户点击"返回版本列表"按钮
   - 系统导航回 `/model-versions`

#### 5.2 树形结构交互

1. **默认展开状态**
   - 页面加载时默认展开所有节点（`default-expand-all`）

2. **展开/收起节点**
   - 用户点击节点前的箭头图标
   - 系统展开/收起该节点的子节点

3. **规则内容显示**
   - 规则内容始终显示在节点下方
   - 保持文本的换行和空格格式（使用 `white-space: pre-wrap`）

#### 5.3 加载状态

1. **加载中**
   - 显示 Loading 动画
   - 禁用所有交互

2. **加载失败**
   - 显示错误提示
   - 提供重试按钮

### 6. 错误处理

#### 6.1 前端错误处理

1. **API调用失败**
   - 捕获异常并显示错误消息
   - 使用 `ElMessage.error()` 显示提示

2. **数据格式错误**
   - 验证API返回的数据结构
   - 提供默认值避免渲染错误

3. **路由参数错误**
   - 验证 `versionId` 参数
   - 无效时重定向到版本列表

#### 6.2 后端错误处理

后端已有完善的错误处理机制，无需修改。

### 7. 性能优化

#### 7.1 数据加载

- 使用现有的递归加载机制（`_load_children`）
- 一次性加载所有节点数据，避免多次请求

#### 7.2 渲染优化

- 使用 Element Plus Tree 组件的虚拟滚动（如果节点数量超过100）
- 规则内容使用 `v-html` 或 `white-space: pre-wrap` 保持格式

### 8. 测试策略

#### 8.1 单元测试

- 测试树形数据转换逻辑
- 测试空规则的处理

#### 8.2 集成测试

- 测试从版本列表到规则展示页面的导航
- 测试规则内容的正确显示

#### 8.3 端到端测试

- 测试完整的用户流程：创建节点 → 添加规则 → 查看规则

## 实现计划

### 阶段1：前端修改（ModelVersions.vue）
- 添加"查看规则"按钮
- 实现导航逻辑

### 阶段2：前端新增（ModelRules.vue）
- 创建规则展示页面组件
- 实现树形结构展示
- 实现规则内容显示

### 阶段3：路由配置
- 添加新路由
- 配置路由元信息

### 阶段4：测试和优化
- 功能测试
- UI调整
- 性能优化

## 附录

### A. 技术栈

- **前端框架**：Vue 3 + TypeScript
- **UI组件库**：Element Plus
- **路由**：Vue Router
- **状态管理**：Pinia（如需要）
- **HTTP客户端**：Axios

### B. 相关文件

**后端文件（无需修改）：**
- `backend/app/models/model_node.py` - 数据模型
- `backend/app/schemas/model_node.py` - Schema定义
- `backend/app/api/model_nodes.py` - API接口

**前端文件（需要修改/新增）：**
- `frontend/src/views/ModelVersions.vue` - 添加按钮
- `frontend/src/views/ModelRules.vue` - 新增页面
- `frontend/src/router/index.ts` - 添加路由
- `frontend/src/api/model.ts` - 无需修改

### C. 设计决策

1. **为什么不在表格中显示规则？**
   - 规则内容通常较长（最多1000字）
   - 在表格中显示会影响可读性
   - 独立页面提供更好的浏览体验

2. **为什么使用树形结构？**
   - 模型节点本身就是树形结构
   - 树形展示更直观地反映节点层级关系
   - Element Plus Tree 组件提供良好的交互体验

3. **为什么默认展开所有节点？**
   - 规则展示页面的目的是快速浏览所有规则
   - 默认展开避免用户逐个点击
   - 如果节点数量过多，可以考虑只展开第一层

4. **为什么不需要修改后端？**
   - 数据库字段已存在
   - API接口已支持 `rule` 字段
   - 后端代码已完整实现相关功能
