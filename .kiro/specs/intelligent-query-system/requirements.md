# 需求文档

## 简介

智能问数系统是一个基于AI的数据查询和分析模块，旨在帮助用户通过自然语言与系统进行交互，实现指标口径查询、数据智能查询和SQL代码生成等功能。该系统由两个核心子模块组成：智能数据问答和指标资产管理。指标资产管理中定义的指标属性和关联关系为智能数据问答提供知识基础，通过不同的提示词和属性组合实现多种对话类型。

## 术语表

- **智能问数系统 (Intelligent_Query_System)**: 包含智能数据问答和指标资产管理两个子模块的完整系统
- **智能数据问答 (Smart_Data_QA)**: 提供基于AI的对话式数据查询功能的模块
- **指标资产管理 (Metric_Asset_Management)**: 管理指标的元数据和层级结构的模块
- **对话 (Conversation)**: 用户与AI之间的一次完整交互会话
- **对话分组 (Conversation_Group)**: 用于组织和管理多个相关对话的容器
- **指标 (Metric)**: 具有业务含义的数据度量单位
- **项目 (Project)**: 指标树的根节点，用于组织指标
- **主题 (Topic)**: 项目下的一级分类，用于归类指标
- **原子指标 (Atomic_Metric)**: 不可再分解的基础指标
- **复合指标 (Composite_Metric)**: 由多个原子指标组合计算得出的指标
- **指标口径 (Metric_Caliber)**: 指标的计算规则和业务定义
- **AI接口配置 (AI_Interface_Config)**: 定义AI服务的连接参数
- **提示词模块 (Prompt_Module)**: 按功能分类的AI提示词配置

## 需求列表

### 需求1：对话管理

**用户故事：** 作为数据分析师，我希望能够创建和管理多个对话会话，以便组织不同主题的数据查询工作。

#### 验收标准

1. 当用户点击新建对话按钮时，智能数据问答模块应创建一个带有默认标题的新对话，并在对话列表中显示
2. 当用户通过关键词搜索对话时，智能数据问答模块应筛选并显示标题或描述包含该关键词的对话
3. 当用户点击对话列表中的某个对话时，智能数据问答模块应加载并在主聊天区域显示该对话的历史记录
4. 当用户编辑对话标题时，智能数据问答模块应更新标题并将更改持久化到数据库
5. 当用户删除对话时，智能数据问答模块应从系统中移除该对话及其所有消息

### 需求2：对话分组管理

**用户故事：** 作为数据分析师，我希望能够将对话组织到不同分组中，以便更好地管理和查找历史对话。

#### 验收标准

1. 当用户创建新的对话分组时，智能数据问答模块应在侧边栏添加该分组并允许命名
2. 当用户将对话拖拽到某个分组时，智能数据问答模块应将该对话移动到该分组并更新显示
3. 当用户收起某个分组时，智能数据问答模块应隐藏该分组的对话，并在分组标题处显示对话数量
4. 当用户展开已收起的分组时，智能数据问答模块应显示该分组内的所有对话
5. 当用户删除分组时，智能数据问答模块应将该分组内的所有对话移至未分组状态

### 需求3：指标口径查询对话

**用户故事：** 作为ETL工程师，我希望能够通过自然语言查询指标的业务口径，以便快速了解指标的定义和计算规则。

#### 验收标准

1. 当用户选择"指标口径查询"对话类型并发送查询时，智能数据问答模块应搜索相关指标并以表格形式返回结果
2. 当系统返回指标口径结果时，智能数据问答模块应在结构化表格中显示指标名称、口径定义、源表和相关维度
3. 当用户请求下载结果时，智能数据问答模块应生成并下载Markdown或PDF格式的结果文件
4. 当未找到匹配的指标时，智能数据问答模块应显示无结果消息并建议替代搜索词

### 需求4：数据智能查询对话

**用户故事：** 作为数据分析师，我希望能够用自然语言查询数据并获得可视化结果，以便快速获取业务洞察。

#### 验收标准

1. 当用户选择"数据智能查询"对话类型并发送自然语言查询时，智能数据问答模块应生成SQL、执行查询并以表格形式返回结果
2. 当系统返回查询结果时，智能数据问答模块应在表格中显示数据并建议最优的图表类型进行可视化
3. 当用户请求特定图表类型时，智能数据问答模块应将数据渲染为所请求的图表（折线图、柱状图、饼图等）
4. 当用户请求下载结果时，智能数据问答模块应生成并下载Excel或CSV格式的数据文件
5. 当生成的SQL存在语法错误时，智能数据问答模块应显示错误消息并建议查询优化方向

### 需求5：SQL代码编写对话

**用户故事：** 作为ETL工程师，我希望能够通过对话生成指标的SQL代码，以便快速实现数据提取逻辑。

#### 验收标准

1. 当用户选择"SQL代码编写"对话类型并请求为现有指标生成SQL时，智能数据问答模块应基于指标定义生成SQL代码
2. 当用户用自然语言定义新指标时，智能数据问答模块应解析定义并生成相应的SQL代码
3. 当系统生成SQL代码时，智能数据问答模块应显示带有语法高亮和复制按钮的代码
4. 当用户请求SQL优化时，智能数据问答模块应分析并建议优化后的SQL代码
5. 当指标定义存在歧义时，智能数据问答模块应在生成SQL前询问澄清问题

### 需求6：消息交互

**用户故事：** 作为用户，我希望能够在对话中发送消息并接收AI回复，以便完成数据查询任务。

#### 验收标准

1. 当用户输入消息并点击发送或按回车键时，智能数据问答模块应将消息发送给AI并在对话中显示
2. 当AI生成响应时，智能数据问答模块应以适当的格式（表格、代码块、图表）显示响应内容
3. 当AI正在处理请求时，智能数据问答模块应显示加载指示器直到响应就绪
4. 当消息发送过程中发生网络错误时，智能数据问答模块应显示错误消息并允许重试
5. 当用户在对话中途切换对话类型时，智能数据问答模块应将新类型应用于后续消息

### 需求7：指标树管理

**用户故事：** 作为数据管理员，我希望能够管理指标的层级结构，以便组织和维护指标资产。

#### 验收标准

1. 当用户查看指标树时，指标资产管理模块应显示多根树结构，项目为根节点，主题为一级子节点，指标为二级子节点
2. 当用户创建新项目时，指标资产管理模块应在树中添加新的根节点
3. 当用户在项目下创建新主题时，指标资产管理模块应将主题添加为所选项目的子节点
4. 当用户对同级节点重新排序时，指标资产管理模块应更新排序顺序并持久化更改
5. 当用户删除项目或主题时，指标资产管理模块应在确认后移除该节点及其所有子节点

### 需求8：指标详情管理

**用户故事：** 作为数据管理员，我希望能够编辑指标的业务属性和技术属性，以便维护完整的指标元数据。

#### 验收标准

1. 当用户点击树中的指标时，指标资产管理模块应在右侧显示指标详情面板
2. 当用户编辑指标业务属性时，指标资产管理模块应允许编辑所属项目、所属主题和业务口径字段
3. 当用户编辑指标技术属性时，指标资产管理模块应允许编辑中文名称、英文名称、类型、层级、口径、源表、维表、维度、关联指标和数据源
4. 当用户保存指标更改时，指标资产管理模块应验证必填字段并持久化更改
5. 当用户创建新指标时，指标资产管理模块应将其添加到所选主题下并设置默认值

### 需求9：指标关联管理

**用户故事：** 作为数据管理员，我希望能够定义指标之间的关联关系，以便支持复合指标的计算和追溯。

#### 验收标准

1. 当用户添加关联指标时，指标资产管理模块应允许从现有指标中选择并保存关联关系
2. 当用户查看复合指标时，指标资产管理模块应显示所有关联的原子指标
3. 当用户移除指标关联时，指标资产管理模块应删除关联关系但不影响指标本身
4. 当用户尝试删除被其他指标关联的指标时，指标资产管理模块应在删除前显示受影响的指标列表并要求用户确认

### 需求10：AI接口配置升级

**用户故事：** 作为系统管理员，我希望能够配置多个AI接口并按模块分配，以便为不同功能使用不同的AI服务。

#### 验收标准

1. 当用户查看AI接口列表时，AI接口配置模块应显示所有已配置的AI接口，包括名称、端点和状态
2. 当用户创建新的AI接口时，AI接口配置模块应允许配置名称、端点、模型、API密钥和参数
3. 当用户编辑AI接口时，AI接口配置模块应更新配置并验证连接性
4. 当用户删除AI接口时，AI接口配置模块应仅在该接口未被任何模块引用时允许删除
5. 当用户测试AI接口时，AI接口配置模块应发送测试请求并显示结果

### 需求11：提示词模块配置

**用户故事：** 作为系统管理员，我希望能够为每个功能模块配置独立的提示词，以便优化不同场景的AI响应质量。

#### 验收标准

1. 当用户查看提示词模块时，提示词模块配置应按功能模块显示配置项（智能分类分级、业务价值报表-当前存在问题、业务价值报表-未来发展计划、智能问数系统-指标口径查询、智能问数系统-查询数据生成、智能问数系统-SQL代码编写）
2. 当用户选择某个模块时，提示词模块配置应显示模块描述、已选AI接口、模型温度设置、支持的占位符、系统提示词和用户提示词
3. 当用户为模块分配AI接口时，提示词模块配置应保存关联并在该模块中使用该接口
4. 当用户编辑模块提示词时，提示词模块配置应验证占位符使用并保存更改
5. 当模块未分配AI接口时，提示词模块配置应显示警告并阻止该模块功能运行
6. 当Maintainer用户使用对应功能模块时，系统应在界面上显示"修改提示词"按钮，点击后以模态框形式直接打开对应模块的提示词配置，方便Maintainer进行调试

### 需求12：数据导出功能

**用户故事：** 作为用户，我希望能够导出查询结果和指标信息，以便在其他工具中使用这些数据。

#### 验收标准

1. 当用户导出指标口径结果时，智能数据问答模块应生成带有格式化表格的Markdown文件
2. 当用户将指标口径结果导出为PDF时，智能数据问答模块应生成格式正确的PDF文档
3. 当用户将查询数据导出为Excel时，智能数据问答模块应生成包含数据和列标题的Excel文件
4. 当用户将查询数据导出为CSV时，智能数据问答模块应生成UTF-8编码的CSV文件
5. 当导出失败时，系统应显示包含失败原因的错误消息

