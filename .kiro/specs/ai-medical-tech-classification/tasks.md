# 医技智能分类分级 - 实现任务

## 任务列表

- [x] 1. 数据库模型和迁移







- [x] 1.1 创建数据库迁移文件







  - 创建AIConfig、ClassificationTask、ClassificationPlan、PlanItem、TaskProgress、APIUsageLog表
  - 添加外键约束和索引
  - 添加唯一约束
  - _需求: 1.1-1.8, 2.1-2.7, 3.1-3.7, 4.1-4.6, 5.1-5.8, 6.1-6.7, 10.1-10.5, 11.1-11.5, 12.1-12.5_
-

- [x] 1.2 定义SQLAlchemy模型























  - 实现AIConfig模型（包含加密字段）
  - 实现ClassificationTask模型（包含状态和进度字段）
  - 实现ClassificationPlan模型
  - 实现PlanItem模型（包含AI建议和用户设置）
  - 实现TaskProgress模型
  - 实现APIUsageLog模型
  - 配置模型关系（relationship和back_populates）
  - _需求: 1.1-1.8, 2.1-2.7, 3.1-3.7, 4.1-4.6, 5.1-5.8, 6.1-6.7, 10.1-10.5, 11.1-11.5, 12.1-12.5_

- [ ]* 1.3 编写属性测试验证模型约束
  - **属性 48: 多租户任务创建隔离**
  - **验证: 需求 10.1**
-

- [x] 2. 加密和安全功能



- [x] 2.1 实现API密钥加密解密功能


  - 实现encrypt_api_key函数（使用Fernet）
  - 实现decrypt_api_key函数
  - 实现mask_api_key函数（掩码显示）
  - 配置ENCRYPTION_KEY环境变量
  - _需求: 1.4, 1.5, 1.6_

- [ ]* 2.2 编写属性测试验证加密功能
  - **属性 2: API密钥加密存储**
  - **验证: 需求 1.4**

- [ ]* 2.3 编写属性测试验证掩码功能
  - **属性 3: API密钥掩码显示**
  - **验证: 需求 1.5**

- [ ]* 2.4 编写属性测试验证密钥更新
  - **属性 4: API密钥更新覆盖**
  - **验证: 需求 1.6**

- [x] 3. Pydantic Schema定义




- [x] 3.1 创建AI配置相关Schema


  - AIConfigCreate（包含明文密钥）
  - AIConfigUpdate
  - AIConfigResponse（密钥掩码）
  - AIConfigTest（测试请求）
  - _需求: 1.1-1.8_

- [x] 3.2 创建分类任务相关Schema


  - ClassificationTaskCreate（包含收费类别、模型版本）
  - ClassificationTaskResponse（包含进度信息）
  - TaskProgressResponse
  - _需求: 2.1-2.7, 3.1-3.7, 4.1-4.6_

- [x] 3.3 创建分类预案相关Schema


  - ClassificationPlanResponse
  - PlanItemResponse（包含AI建议和用户设置）
  - PlanItemUpdate（调整维度）
  - SubmitPreviewResponse（新增/覆盖分析）
  - _需求: 5.1-5.8, 6.1-6.7, 7.1-7.7, 8.1-8.7_

- [ ]* 3.4 编写属性测试验证Schema验证规则
  - **属性 1: URL格式验证**
  - **验证: 需求 1.2**

- [ ]* 3.5 编写属性测试验证必填字段
  - **属性 6: AI配置必填字段验证**
  - **验证: 需求 1.8**

- [ ]* 3.6 编写属性测试验证任务名称长度
  - **属性 9: 任务名称长度验证**
  - **验证: 需求 2.5**

-

- [x] 4. AI接口集成



- [x] 4.1 实现AI接口调用功能

  - 实现call_ai_classification函数
  - 使用OpenAI SDK（兼容DeepSeek）
  - 实现提示词模板渲染（占位符替换）
  - 实现维度列表JSON构建
  - 实现响应解析（提取dimension_id和confidence）
  - 添加错误处理和重试机制
  - _需求: 3.2, 3.3, 9.1-9.5_

- [ ]* 4.2 编写属性测试验证提示词模板
  - **属性 44: 提示词占位符替换**
  - **验证: 需求 9.1, 9.2**

- [ ]* 4.3 编写属性测试验证维度列表构建
  - **属性 45: 维度列表字段完整性**
  - **验证: 需求 9.3**

- [ ]* 4.4 编写属性测试验证AI响应解析
  - **属性 14: AI响应解析正确性**
  - **验证: 需求 3.3**

- [ ]* 4.5 编写属性测试验证非JSON响应处理
  - **属性 47: 非JSON响应错误处理**
  - **验证: 需求 9.5**
-

- [x] 5. AI配置管理服务和API



- [x] 5.1 实现AIConfigService


  - 实现get_config方法（返回掩码密钥）
  - 实现create_or_update_config方法（加密密钥）
  - 实现test_config方法（测试AI接口）
  - 实现get_usage_stats方法（统计API使用）
  - 添加多租户隔离逻辑
  - _需求: 1.1-1.8, 12.5_

- [x] 5.2 实现AI配置API端点


  - GET /api/v1/ai-config（获取配置）
  - POST /api/v1/ai-config（创建/更新配置）
  - POST /api/v1/ai-config/test（测试配置）
  - GET /api/v1/ai-config/usage-stats（使用统计）
  - 添加权限验证（仅管理员）
  - _需求: 1.1-1.8, 12.5_

- [ ]* 5.3 编写属性测试验证配置保存
  - **属性 5: 提示词模板保存一致性**
  - **验证: 需求 1.7**

- [ ]* 5.4 编写属性测试验证多租户配置隔离
  - **属性 52: 多租户AI配置隔离**
  - **验证: 需求 10.5**

- [ ]* 5.5 编写属性测试验证API使用统计
  - **属性 62: API使用统计准确性**
  - **验证: 需求 12.5**

- [x] 6. Celery异步任务实现




- [x] 6.1 实现classify_items_task异步任务


  - 加载任务和AI配置
  - 解密API密钥
  - 查询待处理项目（pending或failed）
  - 加载目标模型版本的末级维度
  - 逐个调用AI接口处理项目
  - 更新处理状态和进度
  - 记录API使用日志
  - 实现调用延迟控制
  - 实现错误处理（记录但继续）
  - 完成后更新任务状态
  - _需求: 3.1-3.7, 4.1-4.6, 11.1-11.5, 12.1_

- [x] 6.2 实现continue_classification_task任务

  - 从上次中断位置继续处理
  - 跳过已完成项目
  - 复用classify_items_task逻辑
  - _需求: 4.3-4.5_

- [ ]* 6.3 编写属性测试验证异步任务启动
  - **属性 10: 任务创建启动异步处理**
  - **验证: 需求 2.6**

- [ ]* 6.4 编写属性测试验证进度更新
  - **属性 15: 进度计数器递增**
  - **验证: 需求 3.4**

- [ ]* 6.5 编写属性测试验证部分失败处理
  - **属性 16: 部分失败继续处理**
  - **验证: 需求 3.5**

- [ ]* 6.6 编写属性测试验证断点保存
  - **属性 18: 断点进度保存**
  - **验证: 需求 3.7**

- [ ]* 6.7 编写属性测试验证调用延迟
  - **属性 58: API调用延迟控制**
  - **验证: 需求 12.1**
-

- [x] 7. 分类任务管理服务和API



- [x] 7.1 实现ClassificationTaskService


  - 实现create_task方法（查询医技项目、创建任务、启动Celery任务）
  - 实现get_tasks方法（列表查询，包含进度）
  - 实现get_task_detail方法（详情查询）
  - 实现delete_task方法
  - 实现continue_task方法（继续处理）
  - 实现get_task_progress方法（实时进度）
  - 实现get_task_logs方法（处理日志）
  - 添加多租户隔离逻辑
  - _需求: 2.1-2.7, 3.1-3.7, 4.1-4.6, 10.1-10.5, 11.1-11.5_

- [x] 7.2 实现分类任务API端点


  - GET /api/v1/classification-tasks（任务列表）
  - POST /api/v1/classification-tasks（创建任务）
  - GET /api/v1/classification-tasks/{id}（任务详情）
  - DELETE /api/v1/classification-tasks/{id}（删除任务）
  - POST /api/v1/classification-tasks/{id}/continue（继续处理）
  - GET /api/v1/classification-tasks/{id}/progress（实时进度）
  - GET /api/v1/classification-tasks/{id}/logs（处理日志）
  - _需求: 2.1-2.7, 3.1-3.7, 4.1-4.6, 10.1-10.5, 11.1-11.5_

- [ ]* 7.3 编写属性测试验证任务元数据
  - **属性 11: 任务元数据完整性**
  - **验证: 需求 2.7**

- [ ]* 7.4 编写属性测试验证收费类别保存
  - **属性 7: 收费类别多选保存**
  - **验证: 需求 2.3**

- [ ]* 7.5 编写属性测试验证末级维度加载
  - **属性 8: 模型版本末级维度加载**
  - **验证: 需求 2.4**

- [ ]* 7.6 编写属性测试验证任务完成状态
  - **属性 17: 任务完成状态更新**
  - **验证: 需求 3.6**

- [ ]* 7.7 编写属性测试验证续传逻辑
  - **属性 22: 续传跳过已完成项目**
  - **验证: 需求 4.4, 4.5**
-

- [x] 8. 分类预案管理服务和API



- [x] 8.1 实现ClassificationPlanService


  - 实现get_plans方法（列表查询）
  - 实现get_plan_detail方法（详情查询，包含所有项目）
  - 实现update_plan方法（更新名称、状态）
  - 实现delete_plan方法
  - 实现get_plan_items方法（项目列表，支持排序和筛选）
  - 实现update_plan_item方法（调整项目维度）
  - 实现generate_submit_preview方法（分析新增/覆盖）
  - 实现submit_plan方法（批量提交到维度目录）
  - 添加多租户隔离逻辑
  - _需求: 5.1-5.8, 6.1-6.7, 7.1-7.7, 8.1-8.7, 10.1-10.5_

- [x] 8.2 实现分类预案API端点


  - GET /api/v1/classification-plans（预案列表）
  - GET /api/v1/classification-plans/{id}（预案详情）
  - PUT /api/v1/classification-plans/{id}（更新预案）
  - DELETE /api/v1/classification-plans/{id}（删除预案）
  - GET /api/v1/classification-plans/{id}/items（项目列表）
  - PUT /api/v1/classification-plans/{id}/items/{item_id}（调整项目）
  - POST /api/v1/classification-plans/{id}/preview（提交预览）
  - POST /api/v1/classification-plans/{id}/submit（提交预案）
  - _需求: 5.1-5.8, 6.1-6.7, 7.1-7.7, 8.1-8.7, 10.1-10.5_

- [ ]* 8.3 编写属性测试验证预案生成
  - **属性 24: 任务完成生成预案**
  - **验证: 需求 5.1**

- [ ]* 8.4 编写属性测试验证预案项目字段
  - **属性 25: 预案项目字段完整性**
  - **验证: 需求 5.3**

- [ ]* 8.5 编写属性测试验证默认维度
  - **属性 26: 未调整项目默认维度**
  - **验证: 需求 5.4**

- [ ]* 8.6 编写属性测试验证维度调整
  - **属性 27: 调整项目维度保存**
  - **验证: 需求 5.6**

- [ ]* 8.7 编写属性测试验证确信度排序
  - **属性 28: 确信度排序正确性**
  - **验证: 需求 5.7**

- [ ]* 8.8 编写属性测试验证确信度筛选
  - **属性 29: 确信度范围筛选**
  - **验证: 需求 5.8**

- [ ]* 8.9 编写属性测试验证预案名称验证
  - **属性 30: 预案名称长度验证**
  - **验证: 需求 6.2**

- [ ]* 8.10 编写属性测试验证预案元数据
  - **属性 32: 预案保留任务元数据**
  - **验证: 需求 6.4**
-

- [x] 9. 提交预览和批量提交功能



- [x] 9.1 实现generate_submit_preview功能

  - 遍历预案项目
  - 确定最终维度（用户设置 ?? AI建议）
  - 查询维度项目表检查是否已存在
  - 分类为新增或覆盖
  - 统计数量
  - _需求: 7.1-7.7_

- [x] 9.2 实现submit_plan功能

  - 验证预案状态（不可重复提交）
  - 使用数据库事务
  - 遍历预案项目
  - 新增项目：创建DimensionItem记录
  - 覆盖项目：更新DimensionItem的node_id
  - 更新预案状态为submitted
  - 失败时回滚
  - _需求: 8.1-8.7_

- [ ]* 9.3 编写属性测试验证预览分析
  - **属性 36: 提交预览分析正确性**
  - **验证: 需求 7.2**

- [ ]* 9.4 编写属性测试验证新增标记
  - **属性 37: 新增项目标记**
  - **验证: 需求 7.3**

- [ ]* 9.5 编写属性测试验证覆盖标记
  - **属性 38: 覆盖项目标记和原维度显示**
  - **验证: 需求 7.4**

- [ ]* 9.6 编写属性测试验证统计准确性
  - **属性 39: 预览统计数字正确性**
  - **验证: 需求 7.5**

- [ ]* 9.7 编写属性测试验证批量插入
  - **属性 40: 批量提交插入正确性**
  - **验证: 需求 8.2, 8.3**

- [ ]* 9.8 编写属性测试验证批量更新
  - **属性 41: 批量提交更新正确性**
  - **验证: 需求 8.2, 8.4**

- [ ]* 9.9 编写属性测试验证提交状态更新
  - **属性 42: 提交完成状态更新**
  - **验证: 需求 8.5**

- [ ]* 9.10 编写属性测试验证事务回滚
  - **属性 43: 提交失败事务回滚**
  - **验证: 需求 8.6**

- [x] 10. 限流和统计功能


- [x] 10.1 实现API调用限流逻辑


  - 在Celery任务中添加延迟控制
  - 实现批次处理逻辑
  - 实现每日限额检查
  - 达到限额时暂停任务并通知
  - _需求: 12.1-12.4_

- [x] 10.2 实现API使用统计功能


  - 查询APIUsageLog表
  - 按日期统计调用次数
  - 计算预估成本（可配置单价）
  - _需求: 12.5_

- [ ]* 10.3 编写属性测试验证延迟配置
  - **属性 59: 调用延迟配置验证**
  - **验证: 需求 12.2**

- [ ]* 10.4 编写属性测试验证批次处理
  - **属性 60: 批次大小处理控制**
  - **验证: 需求 12.3**

- [ ]* 10.5 编写属性测试验证限额控制
  - **属性 61: 每日限额控制**
  - **验证: 需求 12.4**

- [x] 11. 前端 - AI接口配置页面




- [x] 11.1 创建AIConfig.vue页面


  - 实现配置表单（API端点、密钥、提示词）
  - 密钥输入框使用password类型
  - 提示词使用多行文本框
  - 实现保存功能
  - 实现测试功能（调用test接口）
  - 显示API使用统计
  - _需求: 1.1-1.8, 9.6, 12.5_

- [x] 11.2 添加AI接口管理菜单


  - 在系统设置下添加"AI接口管理"二级菜单
  - 配置路由
  - 添加权限控制（仅管理员可见）
  - _需求: 1.1_

- [x] 12. 前端 - 分类任务管理页面





- [x] 12.1 创建Tasks.vue页面


  - 实现任务列表展示（名称、状态、进度、创建时间）
  - 实现创建任务按钮
  - 实现进度实时更新（轮询）
  - 实现继续处理按钮（中断任务）
  - 实现查看预案按钮（完成任务）
  - 实现删除任务功能
  - _需求: 2.1-2.7, 4.1-4.6_

- [x] 12.2 创建CreateTaskDialog.vue组件



  - 实现任务配置表单
  - 收费类别多选（el-checkbox-group）
  - 模型版本选择（el-select）
  - 任务名称输入
  - 实现提交功能
  - _需求: 2.1-2.7_

- [x] 12.3 创建ProgressIndicator.vue组件


  - 实现进度条显示（el-progress）
  - 显示已处理/总数
  - 显示处理状态
  - _需求: 4.1-4.2_

- [x] 13. 前端 - 分类预案管理页面





- [x] 13.1 创建Plans.vue页面


  - 实现预案列表展示（名称、状态、任务信息、创建时间）
  - 实现查看预案按钮
  - 实现删除预案功能
  - _需求: 6.1-6.7_

- [x] 13.2 创建PlanDetail.vue页面


  - 实现预案项目表格展示
  - 显示项目名称、AI建议维度、确信度、用户设置维度
  - 实现确信度排序功能
  - 实现确信度筛选功能
  - 实现调整维度按钮（打开维度选择器）
  - 实现保存预案功能（输入名称）
  - 实现提交预案按钮
  - _需求: 5.1-5.8, 6.1-6.7_

- [x] 13.3 创建PlanItemTable.vue组件


  - 实现项目表格（el-table）
  - 实现排序和筛选
  - 实现调整维度功能
  - 高亮显示已调整项目
  - _需求: 5.1-5.8_

- [x] 13.4 创建SubmitPreviewDialog.vue组件


  - 实现预览对话框
  - 显示新增项目列表
  - 显示覆盖项目列表（高亮）
  - 显示统计数字
  - 实现确认提交按钮
  - _需求: 7.1-7.7, 8.1-8.7_

-

- [x] 14. 前端路由和菜单集成





- [x] 14.1 添加智能分类分级菜单

  - 在主菜单添加"智能分类分级"一级目录
  - 添加"医技分类分级"二级菜单
  - 配置路由
  - _需求: 2.1_

- [x] 14.2 配置前端路由

  - /intelligent-classification/tasks（任务管理）
  - /intelligent-classification/plans（预案管理）
  - /intelligent-classification/plans/:id（预案详情）
  - /system-settings/ai-conf

ig（AI配置）
  - _需求: 1.1, 2.1, 5.2, 6.5_

- [x] 15. 集成测试和端到端测试






- [x] 15.1 编写端到端分类流程测试


  - 配置AI接口
  - 创建分类任务
  - 等待任务完成
  - 查看预案
  - 调整部分项目
  - 保存预案
  - 提交预案
  - 验证维度目录中的数据
  - _需求: 1.1-12.5_

- [x] 15.2 编写断点续传场景测试

  - 创建任务
  - 模拟中断（停止Celery worker）
  - 验证进度保存
  - 继续处理
  - 验证不重复处理
  - _需求: 3.7, 4.3-4.5_

- [x] 15.3 编写AI接口集成测试

  - 使用真实DeepSeek API
  - 测试请求格式


  - 测试响应解析
  - 测试错误处理
  - _需求: 3.2-3.3, 9.1-9.5, 11.1-11.2_

- [x] 16. 文档和部署






- [x] 16.1 编写用户手册


  - AI接口配置指南
  - 分类任务创建指南
  - 预案调整指南
  - 提交流程说明
  - 常见问题解答

- [x] 16.2 编写部署文档


  - 环境变量配置
  - Celery worker启动
  - Redis配置
  - 数据库迁移
  - 监控和告警配置

- [x] 16.3 更新AP



I文档
  - 添加AI配置API文档
  - 添加分类任务API文档
  - 添加分类预案API文档
  - 添加请求/响应示例


-

- [x] 17. 最终检查点




- [x] 17.1 确保所有测试通过

  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试
  - 修复失败的测试

- [x] 17.2 代码审查和优化


  - 检查代码规范
  - 优化性能瓶颈
  - 添加必要的注释
  - 清理调试代码

- [x] 17.3 用户验收测试


  - 演示完整功能
  - 收集用户反馈
  - 修复发现的问题
  - 确认满足所有需求
