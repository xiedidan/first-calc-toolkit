# 医技智能分类分级 - 用户验收测试指南

## 测试概述

本文档提供医技智能分类分级功能的用户验收测试指南，帮助用户验证系统是否满足所有需求。

## 测试环境准备

### 前置条件

1. **系统环境**
   - 后端服务已启动（FastAPI）
   - 前端服务已启动（Vue 3）
   - Redis服务已启动
   - Celery Worker已启动
   - PostgreSQL数据库已配置

2. **测试数据**
   - 至少一个医疗机构已创建
   - 至少一个模型版本已创建并激活
   - 模型版本包含末级维度节点
   - 收费项目表中有医技类项目数据

3. **测试账号**
   - 管理员账号（用于配置AI接口）
   - 普通用户账号（用于测试权限控制）

## 测试场景

### 场景1：AI接口配置管理

**测试目标**：验证管理员可以配置AI接口参数

**测试步骤**：

1. 使用管理员账号登录系统
2. 导航到"系统设置" → "AI接口管理"
3. 填写AI配置表单：
   - API端点：`https://api.deepseek.com/v1`
   - API密钥：输入有效的DeepSeek API密钥
   - 提示词模板：
     ```
     你是一个医技项目分类专家。请根据以下医技项目名称，从给定的维度列表中选择最合适的分类。

     项目名称：{item_name}

     可选维度：
     {dimensions}

     请返回JSON格式：{"dimension_id": <维度ID>, "confidence": <确信度0-1>}
     ```
   - 调用延迟：1.0秒
   - 每日限额：10000次
   - 批次大小：100

4. 点击"保存"按钮

**预期结果**：
- ✓ 配置保存成功
- ✓ API密钥显示为掩码（如：****1234）
- ✓ 提示词模板完整保存
- ✓ 页面显示成功消息

**验证需求**：需求 1.1-1.8

---

### 场景2：测试AI接口连接

**测试目标**：验证AI接口配置是否正确

**测试步骤**：

1. 在AI接口管理页面
2. 点击"测试连接"按钮
3. 输入测试项目名称：`血常规检查`
4. 点击"开始测试"

**预期结果**：
- ✓ 显示测试进度
- ✓ 测试成功，显示AI返回的维度和确信度
- ✓ 显示调用耗时
- ✓ 如果失败，显示详细错误信息

**验证需求**：需求 1.1, 9.6

---

### 场景3：创建分类任务

**测试目标**：验证用户可以创建医技项目分类任务

**测试步骤**：

1. 导航到"智能分类分级" → "医技分类分级"
2. 点击"创建分类任务"按钮
3. 在对话框中配置：
   - 任务名称：`2024年医技项目分类`
   - 收费类别：勾选"检查费"、"放射费"、"化验费"
   - 模型版本：选择已激活的模型版本
4. 点击"确定"

**预期结果**：
- ✓ 任务创建成功
- ✓ 任务列表中显示新任务
- ✓ 任务状态为"处理中"
- ✓ 显示进度条（0/总数）
- ✓ Celery任务已启动

**验证需求**：需求 2.1-2.7

---

### 场景4：监控任务进度

**测试目标**：验证用户可以实时查看任务处理进度

**测试步骤**：

1. 在任务列表中找到刚创建的任务
2. 观察进度条变化
3. 点击"查看详情"按钮
4. 查看任务详细信息

**预期结果**：
- ✓ 进度条实时更新（每处理一个项目更新一次）
- ✓ 显示"已处理/总数"
- ✓ 详情页显示任务元数据（收费类别、模型版本、创建时间）
- ✓ 显示处理日志

**验证需求**：需求 3.1-3.7, 4.1-4.2

---

### 场景5：断点续传测试

**测试目标**：验证任务中断后可以继续处理

**测试步骤**：

1. 创建一个大批量任务（如1000个项目）
2. 等待任务处理到50%左右
3. 停止Celery Worker（模拟中断）
4. 等待几秒钟
5. 重新启动Celery Worker
6. 在任务列表中点击"继续处理"按钮

**预期结果**：
- ✓ 任务状态变为"已暂停"
- ✓ 进度保存在中断位置
- ✓ 点击"继续处理"后，任务从中断位置继续
- ✓ 不重复处理已完成的项目
- ✓ 最终所有项目都被处理

**验证需求**：需求 3.7, 4.3-4.6

---

### 场景6：查看分类预案

**测试目标**：验证用户可以查看AI生成的分类预案

**测试步骤**：

1. 等待任务完成（状态变为"已完成"）
2. 点击"查看预案"按钮
3. 在预案详情页查看项目列表

**预期结果**：
- ✓ 显示所有医技项目
- ✓ 每个项目显示：项目名称、AI建议维度、确信度
- ✓ 确信度以百分比显示（如：95.5%）
- ✓ 支持按确信度排序
- ✓ 支持按确信度筛选（如：仅显示<80%的项目）

**验证需求**：需求 5.1-5.8

---

### 场景7：调整分类预案

**测试目标**：验证用户可以手动调整AI建议的分类

**测试步骤**：

1. 在预案详情页
2. 找到一个确信度较低的项目（如<80%）
3. 点击"调整"按钮
4. 在维度选择器中选择正确的维度
5. 点击"保存"

**预期结果**：
- ✓ 维度选择器显示所有末级维度
- ✓ 保存后，该项目标记为"已调整"
- ✓ 用户设置维度显示在列表中
- ✓ 已调整项目高亮显示

**验证需求**：需求 5.4-5.6

---

### 场景8：保存预案

**测试目标**：验证用户可以为预案命名并保存

**测试步骤**：

1. 在预案详情页
2. 点击"保存预案"按钮
3. 输入预案名称：`2024年医技分类方案v1`
4. 点击"确定"

**预期结果**：
- ✓ 预案保存成功
- ✓ 预案列表中显示该预案
- ✓ 预案状态为"草稿"
- ✓ 可以重新打开预案继续调整

**验证需求**：需求 6.1-6.7

---

### 场景9：提交预览

**测试目标**：验证用户可以预览提交影响

**测试步骤**：

1. 在预案详情页
2. 点击"提交预案"按钮
3. 查看提交预览对话框

**预期结果**：
- ✓ 显示新增项目列表
- ✓ 显示覆盖项目列表（高亮显示）
- ✓ 覆盖项目显示原有维度
- ✓ 显示统计数字（新增数量、覆盖数量）
- ✓ 新增数量 + 覆盖数量 = 总项目数

**验证需求**：需求 7.1-7.7

---

### 场景10：正式提交预案

**测试目标**：验证用户可以将预案提交到维度目录

**测试步骤**：

1. 在提交预览对话框
2. 确认预览信息无误
3. 点击"确认提交"按钮
4. 等待提交完成

**预期结果**：
- ✓ 显示提交进度
- ✓ 提交成功，显示成功消息
- ✓ 预案状态变为"已提交"
- ✓ 已提交预案不可再修改
- ✓ 维度目录中可以查看到新增/更新的项目

**验证需求**：需求 8.1-8.7

---

### 场景11：多租户隔离测试

**测试目标**：验证不同医疗机构的数据隔离

**测试步骤**：

1. 使用医疗机构A的账号登录
2. 创建AI配置和分类任务
3. 切换到医疗机构B
4. 查看任务列表和预案列表

**预期结果**：
- ✓ 医疗机构B看不到医疗机构A的任务
- ✓ 医疗机构B看不到医疗机构A的预案
- ✓ 医疗机构B需要配置自己的AI接口
- ✓ 提交预案只影响当前医疗机构的数据

**验证需求**：需求 10.1-10.5

---

### 场景12：API使用统计

**测试目标**：验证用户可以查看API使用情况

**测试步骤**：

1. 在AI接口管理页面
2. 查看"使用统计"部分

**预期结果**：
- ✓ 显示总调用次数
- ✓ 显示成功次数和失败次数
- ✓ 显示今日调用次数
- ✓ 显示每日限额
- ✓ 显示平均耗时
- ✓ 显示预估成本

**验证需求**：需求 12.5

---

### 场景13：限流控制测试

**测试目标**：验证API调用限流功能

**测试步骤**：

1. 修改AI配置，设置较小的每日限额（如：10次）
2. 创建一个包含20个项目的分类任务
3. 观察任务执行情况

**预期结果**：
- ✓ 任务处理到10个项目后暂停
- ✓ 显示"达到每日限额"提示
- ✓ 任务状态变为"已暂停"
- ✓ 第二天可以继续处理

**验证需求**：需求 12.1-12.4

---

### 场景14：错误处理测试

**测试目标**：验证系统的错误处理能力

**测试步骤**：

1. 配置错误的API端点或密钥
2. 创建分类任务
3. 观察错误处理

**预期结果**：
- ✓ 任务详情显示失败项目列表
- ✓ 每个失败项目显示错误原因
- ✓ 部分失败不影响其他项目处理
- ✓ 可以修复配置后继续处理失败项目

**验证需求**：需求 3.5, 11.1-11.5

---

## 性能测试

### 测试1：大批量处理

**测试数据**：1000个医技项目

**测试步骤**：
1. 创建包含1000个项目的分类任务
2. 监控处理时间和系统资源

**预期结果**：
- ✓ 任务能够完整处理所有项目
- ✓ 平均每个项目处理时间 < 2秒
- ✓ 系统内存使用稳定
- ✓ 数据库连接正常

---

### 测试2：并发任务

**测试数据**：3个并发任务，每个100个项目

**测试步骤**：
1. 同时创建3个分类任务
2. 观察任务执行情况

**预期结果**：
- ✓ 所有任务都能正常处理
- ✓ 任务之间不互相影响
- ✓ 进度更新正确
- ✓ 最终所有任务都完成

---

## 兼容性测试

### 浏览器兼容性

测试以下浏览器：
- ✓ Chrome（最新版本）
- ✓ Firefox（最新版本）
- ✓ Edge（最新版本）
- ✓ Safari（最新版本）

### 屏幕分辨率

测试以下分辨率：
- ✓ 1920x1080（桌面）
- ✓ 1366x768（笔记本）
- ✓ 1280x720（小屏幕）

---

## 验收标准

### 功能完整性

- [ ] 所有14个测试场景通过
- [ ] 所有需求（1.1-12.5）得到验证
- [ ] 无阻塞性缺陷

### 性能要求

- [ ] 单个项目处理时间 < 2秒
- [ ] 1000个项目批量处理 < 40分钟
- [ ] 页面响应时间 < 1秒

### 用户体验

- [ ] 界面友好，操作直观
- [ ] 错误提示清晰明确
- [ ] 进度反馈及时
- [ ] 无明显卡顿

### 数据准确性

- [ ] AI分类结果合理
- [ ] 确信度计算正确
- [ ] 提交预览分析准确
- [ ] 多租户数据隔离完整

---

## 问题反馈

如果在测试过程中发现问题，请记录以下信息：

1. **问题描述**：详细描述问题现象
2. **重现步骤**：列出重现问题的具体步骤
3. **预期结果**：说明期望的正确行为
4. **实际结果**：说明实际发生的情况
5. **截图/日志**：提供相关截图或错误日志
6. **环境信息**：浏览器版本、操作系统等

---

## 验收签字

- **测试人员**：________________  日期：________
- **开发负责人**：________________  日期：________
- **项目经理**：________________  日期：________
- **用户代表**：________________  日期：________

---

## 附录：测试数据准备脚本

```sql
-- 创建测试医疗机构
INSERT INTO hospitals (code, name, is_active) 
VALUES ('TEST001', '测试医院A', true);

-- 创建测试模型版本
INSERT INTO model_versions (hospital_id, version, name, is_active)
VALUES (1, 'v1.0', '测试模型版本', true);

-- 创建测试维度（末级节点）
INSERT INTO model_nodes (version_id, code, name, is_leaf, parent_id)
VALUES 
  (1, 'CHECK', '检查费', true, NULL),
  (1, 'RADIO', '放射费', true, NULL),
  (1, 'LAB', '化验费', true, NULL);

-- 创建测试收费项目
INSERT INTO charge_items (hospital_id, code, name, category)
VALUES 
  (1, 'ITEM001', '血常规检查', '化验费'),
  (1, 'ITEM002', 'X光胸片', '放射费'),
  (1, 'ITEM003', '心电图检查', '检查费');
```
