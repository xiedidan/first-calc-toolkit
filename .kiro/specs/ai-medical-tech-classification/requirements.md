# 医技智能分类分级 - 需求文档

## 简介

医技智能分类分级模块利用AI技术（DeepSeek/OpenAI Compatible API）自动判断医技收费项目应归属的末级维度，提供智能化的分类建议。该模块支持异步处理、断点续传、预案管理和批量提交功能，大幅提升医技项目分类的效率和准确性。

## 术语表

- **系统**：医院科室业务价值评估系统
- **医技项目**：医疗技术类收费项目，通常包括检查费、放射费、化验费、麻醉费等收费类别
- **末级维度**：评估模型树形结构中的叶子节点，代表最细粒度的分类
- **AI分类预案**：AI判断完成后生成的分类建议方案，包含AI建议维度、确信度和用户调整
- **确信度**：AI对分类判断的置信程度，范围0-1
- **断点续传**：记录处理进度，支持从中断位置继续处理
- **管理员**：具有管理员权限的系统用户
- **AI接口配置**：系统设置中的AI服务配置，包括API端点、密钥和提示词

## 需求

### 需求 1：AI接口配置管理

**用户故事**：作为管理员，我想要配置AI接口参数，以便系统能够调用DeepSeek API进行智能分类。

#### 验收标准

1. WHEN 管理员访问系统设置的"AI接口管理"页面 THEN 系统应显示AI接口配置表单
2. WHEN 管理员输入API访问端点 THEN 系统应验证URL格式的有效性
3. WHEN 管理员输入API Key THEN 系统应在前端显示为密码格式（不显示明文）
4. WHEN 管理员保存API Key THEN 系统应在数据库中加密存储该密钥
5. WHEN 管理员查看已保存的API Key THEN 系统应显示掩码（如"****"），不显示明文
6. WHEN 管理员重新设置API Key THEN 系统应允许输入新密钥并覆盖旧密钥
7. WHEN 管理员配置医技智能分类提示词 THEN 系统应支持多行文本输入，并保存为模板
8. WHEN 管理员保存AI接口配置 THEN 系统应验证所有必填字段已填写

### 需求 2：医技项目选择和分类任务创建

**用户故事**：作为管理员，我想要选择需要分类的医技项目并创建分类任务，以便AI能够处理这些项目。

#### 验收标准

1. WHEN 管理员访问医技智能分类页面 THEN 系统应显示"创建分类任务"按钮
2. WHEN 管理员点击创建分类任务 THEN 系统应显示任务配置对话框
3. WHEN 管理员在任务配置中选择收费类别 THEN 系统应支持多选（检查费、放射费、化验费、麻醉费等）
4. WHEN 管理员选择模型版本 THEN 系统应显示该版本下所有末级维度供AI判断使用
5. WHEN 管理员输入任务名称 THEN 系统应验证名称不为空
6. WHEN 管理员提交任务配置 THEN 系统应创建分类任务记录，并开始异步处理
7. WHEN 系统创建任务 THEN 系统应记录任务元数据（收费类别、模型版本ID、创建时间、创建人）

### 需求 3：AI异步分类处理

**用户故事**：作为系统，我想要异步调用AI接口处理医技项目分类，以便不阻塞用户操作并支持大批量处理。

#### 验收标准

1. WHEN 分类任务创建后 THEN 系统应启动Celery异步任务进行AI分类
2. WHEN 异步任务处理项目 THEN 系统应逐个调用AI接口，传递项目名称和可选维度列表
3. WHEN AI接口返回结果 THEN 系统应解析AI建议的维度ID和确信度（0-1范围）
4. WHEN 系统处理每个项目 THEN 系统应记录处理进度（已处理数量/总数量）
5. WHEN 系统处理项目失败 THEN 系统应记录错误信息，但继续处理下一个项目
6. WHEN 系统完成所有项目处理 THEN 系统应更新任务状态为"已完成"
7. WHEN 系统处理过程中发生中断 THEN 系统应保存当前进度，支持后续继续处理

### 需求 4：断点续传和进度管理

**用户故事**：作为管理员，我想要查看分类任务的实时进度，并在任务中断后能够继续处理，以便避免重复的API调用浪费。

#### 验收标准

1. WHEN 管理员查看分类任务列表 THEN 系统应显示每个任务的处理进度（已处理/总数）
2. WHEN 分类任务正在处理 THEN 系统应实时更新进度显示（每处理一个项目更新一次）
3. WHEN 分类任务因错误中断 THEN 系统应记录最后成功处理的项目位置
4. WHEN 管理员点击"继续处理"按钮 THEN 系统应从上次中断位置继续调用AI接口
5. WHEN 系统继续处理任务 THEN 系统应跳过已成功处理的项目，仅处理未完成的项目
6. WHEN 系统记录进度 THEN 系统应为每个项目保存处理状态（待处理、处理中、已完成、失败）

### 需求 5：分类预案查看和调整

**用户故事**：作为管理员，我想要查看AI生成的分类预案并进行调整，以便确保分类结果的准确性。

#### 验收标准

1. WHEN 分类任务完成 THEN 系统应生成分类预案，并显示"查看预案"按钮
2. WHEN 管理员点击查看预案 THEN 系统应显示预案详情页面，列出所有医技项目
3. WHEN 系统显示预案项目 THEN 系统应显示项目名称、AI建议维度、确信度、用户设置维度
4. WHEN 用户未设置维度 THEN 系统应默认采用AI建议维度
5. WHEN 管理员点击调整按钮 THEN 系统应显示维度选择器，允许修改该项目的分类
6. WHEN 管理员修改项目维度 THEN 系统应保存用户设置维度，并标记为"已调整"
7. WHEN 管理员按确信度排序 THEN 系统应支持按确信度升序或降序排列项目
8. WHEN 管理员筛选低确信度项目 THEN 系统应支持按确信度范围筛选（如<0.5）

### 需求 6：分类预案命名和保存

**用户故事**：作为管理员，我想要为分类预案命名并保存，以便未来调取和继续调整。

#### 验收标准

1. WHEN 管理员在预案页面点击保存 THEN 系统应提示输入预案名称
2. WHEN 管理员输入预案名称 THEN 系统应验证名称不为空且长度不超过100字符
3. WHEN 管理员保存预案 THEN 系统应保存预案名称、状态（草稿/已提交）和最后修改时间
4. WHEN 系统保存预案 THEN 系统应保留任务元数据（收费类别、模型版本ID）
5. WHEN 管理员访问预案列表 THEN 系统应显示所有已保存的预案及其元数据
6. WHEN 管理员选择预案 THEN 系统应加载该预案的所有项目和调整记录
7. WHEN 管理员继续调整已保存预案 THEN 系统应允许修改项目维度并更新保存

### 需求 7：分类预案提交前预览

**用户故事**：作为管理员，我想要在提交预案前预览影响范围，以便了解哪些项目是新增、哪些是覆盖现有分类。

#### 验收标准

1. WHEN 管理员点击提交预案 THEN 系统应显示提交预览对话框
2. WHEN 系统生成预览 THEN 系统应分析每个项目在目标模型版本中的存在情况
3. WHEN 项目在目标维度中不存在 THEN 系统应标记为"新增"
4. WHEN 项目在目标维度中已存在 THEN 系统应标记为"覆盖"，并显示原有维度
5. WHEN 系统显示预览 THEN 系统应统计新增数量和覆盖数量
6. WHEN 管理员确认预览 THEN 系统应允许继续提交或取消操作
7. WHEN 预览显示覆盖项目 THEN 系统应高亮显示，提醒管理员注意

### 需求 8：分类预案正式提交

**用户故事**：作为管理员，我想要将调整完成的预案提交到模型版本的维度目录中，以便正式应用这些分类。

#### 验收标准

1. WHEN 管理员确认提交预览 THEN 系统应开始执行批量提交操作
2. WHEN 系统提交项目 THEN 系统应将每个项目添加到对应末级维度的维度项目列表中
3. WHEN 项目为新增 THEN 系统应创建新的维度项目记录
4. WHEN 项目为覆盖 THEN 系统应更新现有维度项目记录的维度归属
5. WHEN 系统完成提交 THEN 系统应更新预案状态为"已提交"
6. WHEN 系统提交失败 THEN 系统应回滚所有更改，并显示错误信息
7. WHEN 系统提交成功 THEN 系统应显示成功消息，并提供查看维度目录的链接

### 需求 9：AI提示词模板和参数

**用户故事**：作为管理员，我想要配置AI提示词模板，以便控制AI的分类逻辑和输出格式。

#### 验收标准

1. WHEN 管理员配置提示词 THEN 系统应支持使用占位符（如{item_name}、{dimensions}）
2. WHEN 系统调用AI接口 THEN 系统应将占位符替换为实际值（项目名称、维度名称列表）
3. WHEN 系统发送AI请求 THEN 系统应要求AI返回JSON格式（包含dimension和confidence）
4. WHEN AI返回JSON格式 THEN 系统应根据返回的维度名称，对照回维度ID/Code
5. WHEN AI返回非JSON格式 THEN 系统应尝试解析或记录错误
6. WHEN 管理员测试提示词 THEN 系统应提供测试功能，使用样例数据调用AI并显示结果

### 需求 10：多租户数据隔离

**用户故事**：作为系统架构师，我想要确保AI分类数据按医疗机构隔离，以便支持多租户部署。

#### 验收标准

1. WHEN 系统创建分类任务 THEN 系统应自动设置当前医疗机构ID
2. WHEN 系统查询分类任务或预案 THEN 系统应仅返回当前医疗机构的数据
3. WHEN 系统提交预案 THEN 系统应仅操作当前医疗机构的模型版本和维度数据
4. WHEN 管理员切换医疗机构 THEN 系统应刷新页面数据，显示新医疗机构的任务和预案
5. WHEN 系统调用AI接口 THEN 系统应使用当前医疗机构的AI接口配置

### 需求 11：错误处理和日志

**用户故事**：作为系统管理员，我想要系统记录详细的错误日志，以便排查AI分类过程中的问题。

#### 验收标准

1. WHEN AI接口调用失败 THEN 系统应记录错误信息（HTTP状态码、错误消息）
2. WHEN AI返回格式错误 THEN 系统应记录原始响应内容和解析错误
3. WHEN 系统处理项目失败 THEN 系统应在任务详情中显示失败项目列表和错误原因
4. WHEN 管理员查看任务详情 THEN 系统应显示处理日志（开始时间、结束时间、成功数、失败数）
5. WHEN 系统记录日志 THEN 系统应包含时间戳、操作类型、用户ID和详细信息

### 需求 12：性能和限流

**用户故事**：作为系统架构师，我想要控制AI接口调用频率，以便避免超出API限额和降低成本。

#### 验收标准

1. WHEN 系统调用AI接口 THEN 系统应在每次调用之间添加延迟（可配置，默认1秒）
2. WHEN 管理员配置调用延迟 THEN 系统应验证延迟值在合理范围内（0.1-10秒）
3. WHEN 系统批量处理项目 THEN 系统应支持配置批次大小（每批处理N个项目后暂停）
4. WHEN 系统达到每日调用限额 THEN 系统应暂停任务并通知管理员
5. WHEN 管理员查看API使用统计 THEN 系统应显示当日调用次数和预估成本
