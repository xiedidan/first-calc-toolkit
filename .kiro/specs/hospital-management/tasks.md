# 医疗机构管理功能 - 实施任务列表

## 1. 数据库设计与迁移

### 1.1 创建医疗机构表
- 创建 `hospitals` 表，包含字段：id, code, name, is_active, created_at, updated_at
- code 字段设置唯一约束
- 添加必要的索引
- _需求: 1.1, 1.2, 1.3_

### 1.2 修改用户表结构
- 在 `users` 表添加 `hospital_id` 字段（可为空，表示超级用户）
- 添加外键约束关联到 `hospitals` 表
- 添加索引提升查询性能
- _需求: 3.1, 3.2, 3.3_

### 1.3 修改业务表结构
- 识别所有需要机构隔离的业务表（model_versions, model_nodes, departments, calculation_tasks, calculation_results等）
- 为每个业务表添加 `hospital_id` 字段（非空）
- 添加外键约束和索引
- _需求: 4.4, 5.1_

### 1.4 创建数据迁移脚本
- 编写 Alembic 迁移脚本创建 hospitals 表
- 插入默认医疗机构"宁波市眼科医院"（编码：nbeye）
- 更新所有现有业务数据的 hospital_id 为默认机构ID
- 更新所有现有用户的 hospital_id 为 NULL（设为超级用户）
- _需求: 4.1, 4.2, 4.3, 4.5, 4.6_

### 1.5 验证数据迁移
- 编写测试脚本验证数据迁移完整性
- 确认所有业务数据都已关联到默认机构
- 确认外键约束和索引已正确创建
- _需求: 4.6, 4.7_

## 2. 后端API开发

### 2.1 创建医疗机构数据模型
- 创建 `Hospital` SQLAlchemy 模型类
- 定义字段验证规则
- 实现模型方法（如 to_dict）
- _需求: 1.1_

### 2.2 创建医疗机构Schema
- 创建 Pydantic Schema 用于请求验证和响应序列化
- 定义 HospitalCreate, HospitalUpdate, HospitalResponse schema
- 添加字段验证规则（编码格式、名称长度等）
- _需求: 1.2, 1.3, 1.4_

### 2.3 实现医疗机构CRUD服务
- 创建 `HospitalService` 类
- 实现 create_hospital 方法（检查编码唯一性）
- 实现 get_hospitals 方法（支持分页和搜索）
- 实现 get_hospital_by_id 方法
- 实现 update_hospital 方法（不允许修改编码）
- 实现 delete_hospital 方法（检查关联数据）
- _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

### 2.4 实现医疗机构API路由
- 创建 `/api/v1/hospitals` 路由
- GET /hospitals - 获取医疗机构列表
- POST /hospitals - 创建医疗机构
- GET /hospitals/{id} - 获取医疗机构详情
- PUT /hospitals/{id} - 更新医疗机构
- DELETE /hospitals/{id} - 删除医疗机构
- 添加权限控制（仅系统管理员可访问）
- _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

### 2.5 实现医疗机构激活API
- POST /hospitals/{id}/activate - 激活医疗机构
- 验证用户是否有权访问该机构
- 将激活的机构ID存储到用户会话中
- 返回激活成功响应
- _需求: 2.3, 2.4, 3.4, 3.5_

### 2.6 实现用户可访问机构列表API
- GET /hospitals/accessible - 获取当前用户可访问的医疗机构列表
- 如果用户是超级用户，返回所有机构
- 如果用户绑定了机构，仅返回该机构
- _需求: 3.6, 3.7_

### 2.7 修改用户管理API
- 在用户创建/更新API中添加 hospital_id 字段
- 在用户响应中包含所属医疗机构信息
- 更新用户Schema定义
- _需求: 3.1, 3.2_

### 2.8 实现会话管理中间件
- 创建中间件从用户会话中获取当前激活的医疗机构ID
- 将医疗机构ID注入到请求上下文中
- 提供便捷方法获取当前激活的医疗机构
- _需求: 5.7_

### 2.9 实现数据隔离过滤器
- 创建 SQLAlchemy 查询过滤器自动添加 hospital_id 条件
- 在所有业务数据查询中应用过滤器
- 确保超级用户未激活机构时不返回数据
- _需求: 5.1, 5.6_

### 2.10 修改现有业务API
- 修改模型管理API添加数据隔离
- 修改科室管理API添加数据隔离
- 修改计算任务API添加数据隔离
- 修改结果查询API添加数据隔离
- 在创建操作中自动关联当前激活的医疗机构
- 在更新/删除操作中验证数据所属机构
- _需求: 5.2, 5.3, 5.4, 5.5_

### 2.11 更新API文档
- 在API设计文档中添加医疗机构管理API章节
- 更新用户管理API文档说明hospital_id字段
- 添加数据隔离说明
- 更新错误码说明（添加权限不足等错误）
- _需求: 所有需求_

## 3. 前端开发

### 3.1 创建医疗机构管理页面
- 创建 HospitalManagement.vue 组件
- 实现医疗机构列表展示（表格）
- 实现搜索和分页功能
- 添加"新建医疗机构"按钮
- _需求: 1.1_

### 3.2 实现医疗机构创建对话框
- 创建 HospitalCreateDialog.vue 组件
- 实现表单（医疗机构编码、医疗机构名称）
- 添加表单验证（必填、编码格式、唯一性）
- 调用创建API并处理响应
- _需求: 1.2, 1.3_

### 3.3 实现医疗机构编辑对话框
- 创建 HospitalEditDialog.vue 组件
- 实现表单（仅允许编辑名称）
- 医疗机构编码字段设为只读
- 调用更新API并处理响应
- _需求: 1.4_

### 3.4 实现医疗机构删除功能
- 添加删除按钮和确认对话框
- 调用删除API
- 处理删除失败情况（有关联数据）
- 显示友好的错误提示
- _需求: 1.5_

### 3.5 添加医疗机构管理菜单项
- 在左侧菜单中添加"医疗机构管理"菜单项
- 位置：数据源管理之后
- 仅系统管理员可见
- 路由配置：/hospitals
- _需求: 需求描述_

### 3.6 实现顶部医疗机构选择器
- 在页面顶部标题栏添加医疗机构选择下拉菜单
- 显示当前激活的医疗机构名称
- 点击显示可访问的医疗机构列表
- 选择机构后调用激活API
- 激活成功后刷新页面数据
- _需求: 2.4, 2.5, 2.7, 7.4, 7.5_

### 3.7 实现页面标题动态更新
- 根据当前激活的医疗机构更新页面标题
- 格式："{医疗机构名称}科室业务价值评估工具"
- 未激活时显示默认标题"医院科室业务价值评估工具"
- _需求: 2.4, 2.5, 7.1, 7.2, 7.3_

### 3.8 实现菜单权限控制
- 创建菜单权限控制逻辑
- 未激活医疗机构时，仅系统设置和数据源管理可用
- 未激活医疗机构时，其他菜单显示为禁用状态
- 激活医疗机构后，启用所有菜单
- _需求: 2.1, 2.2, 2.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

### 3.9 修改用户管理页面
- 在用户创建/编辑表单中添加"所属医疗机构"下拉选择
- 支持选择"无"（超级用户）
- 在用户列表中显示所属医疗机构
- _需求: 3.1, 3.2_

### 3.10 实现医疗机构切换逻辑
- 监听医疗机构切换事件
- 切换后重新加载当前页面数据
- 更新Vuex状态存储当前激活的医疗机构
- 处理切换失败情况
- _需求: 2.7, 7.5_

### 3.11 添加权限验证提示
- 机构绑定用户尝试访问其他机构时显示提示
- 未激活机构时访问业务功能显示提示
- 统一错误提示样式和文案
- _需求: 3.5, 5.5_

### 3.12 实现医疗机构过滤器显示
- 在用户下拉菜单中显示可访问的医疗机构
- 机构绑定用户仅显示所属机构
- 超级用户显示所有机构
- _需求: 7.6, 7.7_

## 4. 状态管理

### 4.1 创建医疗机构Vuex模块
- 创建 hospital store 模块
- 定义 state: currentHospital, accessibleHospitals
- 实现 actions: fetchAccessibleHospitals, activateHospital
- 实现 mutations: setCurrentHospital, setAccessibleHospitals
- 实现 getters: isHospitalActivated, isMenuEnabled
- _需求: 2.4, 2.7, 6.7_

### 4.2 集成到全局状态
- 在根store中注册hospital模块
- 在应用初始化时加载可访问的医疗机构列表
- 从localStorage恢复上次激活的医疗机构
- _需求: 2.7_

## 5. 测试

### 5.1 编写后端基础测试
- 测试医疗机构CRUD操作
- 测试医疗机构激活逻辑
- 测试数据隔离过滤器基本功能
- _需求: 所有需求_

### 5.2* 编写前端单元测试
- 测试医疗机构管理组件
- 测试医疗机构选择器组件
- 测试菜单权限控制逻辑
- _需求: 所有需求_

### 5.3* 编写集成测试
- 测试完整的医疗机构切换流程
- 测试数据隔离场景
- 测试权限控制场景
- _需求: 所有需求_

### 5.4 手动功能测试（由用户执行）
- 测试医疗机构管理功能
- 测试不同用户角色的权限
- 测试数据迁移后的功能完整性
- 测试边界情况和异常处理
- _需求: 所有需求_

## 6. 文档更新

### 6.1 更新需求文档
- 在主需求文档中添加医疗机构管理章节
- 更新用户体系说明
- 添加数据隔离说明
- _需求: 所有需求_

### 6.2 更新系统设计文档
- 添加医疗机构管理服务设计
- 更新数据库设计章节
- 添加数据隔离架构说明
- 更新部署架构（如有影响）
- _需求: 所有需求_

### 6.3 更新API设计文档
- 添加医疗机构管理API章节
- 更新用户管理API说明
- 添加数据隔离说明
- 更新通用响应格式（添加权限错误）
- _需求: 所有需求_

### 6.4 编写用户手册
- 编写医疗机构管理操作指南
- 编写医疗机构切换操作指南
- 说明不同用户角色的权限差异
- _需求: 所有需求_

### 6.5 编写数据迁移指南
- 编写详细的数据迁移步骤
- 说明迁移前的备份要求
- 提供回滚方案
- 列出迁移后的验证检查项
- _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

## 7. 部署与发布

### 7.1 准备数据迁移脚本
- 确认迁移脚本已测试通过
- 准备回滚脚本
- 编写迁移执行文档
- _需求: 4.1-4.7_

### 7.2 执行数据库迁移
- 备份生产数据库
- 在测试环境执行迁移并验证
- 在生产环境执行迁移
- 验证迁移结果
- _需求: 4.6, 4.7_

### 7.3 部署后端代码
- 部署更新后的后端代码
- 重启后端服务
- 验证API功能正常
- _需求: 所有需求_

### 7.4 部署前端代码
- 构建前端生产版本
- 部署到服务器
- 清除浏览器缓存
- 验证前端功能正常
- _需求: 所有需求_

### 7.5 发布后验证
- 验证现有功能未受影响
- 验证医疗机构管理功能正常
- 验证数据隔离功能正常
- 验证权限控制功能正常
- _需求: 所有需求_
