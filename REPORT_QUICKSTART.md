# 报表功能快速启动指南

## 前置条件

1. PostgreSQL 16 已安装并运行
2. Redis 已安装并运行
3. Python 3.12 已安装
4. Node.js 18+ 已安装

## 快速启动步骤

### 1. 数据库迁移

```bash
cd backend
alembic upgrade head
```

### 2. 启动后端服务（终端1）

```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 启动Celery Worker（终端2）

```bash
cd backend
celery -A app.celery_app worker --loglevel=info --pool=solo
```

注意：Windows系统需要使用 `--pool=solo` 参数

### 4. 启动前端服务（终端3）

```bash
cd frontend
npm run dev
```

### 5. 访问系统

打开浏览器访问 `http://localhost:3000`

## 功能测试流程

### 1. 准备测试数据

在使用报表功能前，需要确保系统中已有以下数据：

1. **模型版本**: 至少创建一个模型版本
2. **模型结构**: 为模型版本创建完整的节点结构（序列和维度）
3. **计算流程**: 为模型版本创建计算流程
4. **计算步骤**: 为计算流程添加计算步骤（包含SQL或Python代码）
5. **科室数据**: 至少创建几个科室并标记为"参与评估"
6. **数据源**: 配置至少一个数据源（用于SQL步骤）

### 2. 创建计算任务

1. 登录系统
2. 点击左侧菜单"计算任务管理"
3. 点击"创建计算任务"按钮
4. 填写表单：
   - 选择模型版本
   - 选择计算流程
   - 选择计算周期（如：2025-10）
   - 选择科室范围（可选，不选则计算所有科室）
   - 填写任务描述（可选）
5. 点击"创建"按钮

### 3. 监控任务执行

1. 在任务列表中查看任务状态
2. 状态说明：
   - **排队中**: 任务已提交，等待Celery Worker处理
   - **运行中**: 任务正在执行，可以看到进度条
   - **已完成**: 任务执行成功
   - **失败**: 任务执行失败，可以查看错误信息
   - **已取消**: 任务已被取消

### 4. 查看计算结果

1. 任务状态变为"已完成"后，点击"查看结果"按钮
2. 进入结果页面，可以看到：
   - 全院汇总数据（第一行）
   - 各科室的汇总数据
   - 医生、护理、医技三个序列的价值和占比
3. 点击某个科室的"查看明细"按钮
4. 在弹出的对话框中查看该科室的详细数据：
   - 按序列分类的维度数据
   - 每个维度的工作量、权重、价值和占比

### 5. 导出报表（待完善）

1. 在结果页面点击"导出汇总表"或"导出明细表"按钮
2. 系统会创建导出任务
3. 导出完成后可以下载Excel文件

## 常见问题

### Q1: 创建任务后状态一直是"排队中"

**原因**: Celery Worker未启动或连接失败

**解决方法**:
1. 检查Redis是否正常运行
2. 检查Celery Worker是否正常启动
3. 查看Celery Worker的日志输出

### Q2: 任务状态变为"失败"

**原因**: 计算步骤执行出错

**解决方法**:
1. 点击任务查看错误信息
2. 检查计算步骤的代码是否正确
3. 检查数据源连接是否正常
4. 查看后端日志获取详细错误信息

### Q3: 找不到计算结果

**原因**: 任务未完成或查询条件不正确

**解决方法**:
1. 确认任务状态为"已完成"
2. 检查筛选条件（评估月份、模型版本）是否正确
3. 确认任务ID是否正确

### Q4: 前端页面报错

**原因**: API接口调用失败

**解决方法**:
1. 检查后端服务是否正常运行
2. 打开浏览器开发者工具查看网络请求
3. 检查API响应的错误信息

## 开发调试

### 查看后端日志

后端日志会输出到终端，包括：
- API请求日志
- 数据库查询日志
- 错误堆栈信息

### 查看Celery日志

Celery Worker的日志会输出到终端，包括：
- 任务接收日志
- 任务执行日志
- 任务完成或失败日志

### 查看数据库数据

```sql
-- 查看计算任务
SELECT * FROM calculation_tasks ORDER BY created_at DESC LIMIT 10;

-- 查看计算结果
SELECT * FROM calculation_results WHERE task_id = 'your-task-id';

-- 查看汇总数据
SELECT * FROM calculation_summaries WHERE task_id = 'your-task-id';
```

### 清理测试数据

```sql
-- 删除所有计算任务（会级联删除结果数据）
DELETE FROM calculation_tasks;

-- 重置任务ID序列
ALTER SEQUENCE calculation_tasks_id_seq RESTART WITH 1;
```

## 性能优化建议

1. **并行计算**: 修改Celery Worker配置，增加并发数
2. **结果缓存**: 对频繁查询的结果进行缓存
3. **数据库索引**: 为常用查询字段添加索引
4. **分页查询**: 大数据量时使用分页查询
5. **异步导出**: 使用Celery异步生成Excel文件

## 下一步

完成基本功能测试后，可以：

1. 完善计算引擎核心逻辑
2. 实现Excel报表导出功能
3. 添加更多的数据验证和错误处理
4. 优化用户界面和交互体验
5. 添加单元测试和集成测试
