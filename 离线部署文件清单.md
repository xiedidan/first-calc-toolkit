# 离线部署文件清单

## 📦 已创建的文件

### 1. 文档文件

| 文件 | 说明 | 状态 |
|------|------|------|
| `需求文档.md` | 新增第6章：离线部署需求 | ✅ 已更新 |
| `系统设计文档.md` | 新增第7章：离线部署架构设计 | ✅ 已更新 |
| `离线部署方案.md` | 详细的技术实施方案 | ✅ 已创建 |
| `OFFLINE_DEPLOYMENT_GUIDE.md` | 快速部署指南 | ✅ 已创建 |
| `离线部署文件清单.md` | 本文件 | ✅ 已创建 |

### 2. 构建脚本（Windows）

| 文件 | 说明 | 状态 |
|------|------|------|
| `scripts/build-offline-package.ps1` | Windows PowerShell构建脚本 | ✅ 已创建 |

### 3. 配置文件

| 文件 | 说明 | 状态 |
|------|------|------|
| `docker-compose.offline.yml` | 离线部署Docker Compose配置 | ✅ 已创建 |
| `backend/.env.offline.template` | 环境变量配置模板 | ✅ 已创建 |

### 4. 部署脚本（Linux）

| 文件 | 说明 | 状态 |
|------|------|------|
| `scripts/check-prerequisites.sh` | 前置条件检查脚本 | ✅ 已创建 |
| `scripts/load-images.sh` | Docker镜像导入脚本 | ✅ 已创建 |
| `scripts/init-database.sh` | 数据库初始化脚本 | ✅ 已创建 |
| `scripts/deploy-offline.sh` | 一键部署脚本 | ✅ 已创建 |

---

## 🚀 快速开始

### 在Windows 11上构建部署包

```powershell
# 1. 确保Docker Desktop正在运行
# 2. 在项目根目录执行
.\scripts\build-offline-package.ps1
```

### 在Linux服务器上部署

```bash
# 1. 解压部署包
tar -xzf hospital-value-toolkit-offline-v1.0.tar.gz
cd offline-package

# 2. 一键部署
bash scripts/deploy-offline.sh
```

详细步骤请参考 `OFFLINE_DEPLOYMENT_GUIDE.md`

---

## 📋 部署包结构

构建完成后的部署包结构：

```
hospital-value-toolkit-offline-v1.0.tar.gz
└── offline-package/
    ├── README.md                          # 部署包说明
    ├── images/                            # Docker镜像文件
    │   ├── backend.tar.gz                 # 后端镜像（~400MB）
    │   ├── frontend.tar.gz                # 前端镜像（~30MB）
    │   └── redis.tar.gz                   # Redis镜像（~15MB）
    ├── database/                          # 数据库数据
    │   └── hospital_value.sql.gz         # 数据库导出文件
    ├── config/                            # 配置文件
    │   ├── docker-compose.offline.yml    # Docker Compose配置
    │   └── .env.offline.template         # 环境变量模板
    ├── scripts/                           # 部署脚本
    │   ├── check-prerequisites.sh        # 前置条件检查
    │   ├── load-images.sh                # 镜像导入脚本
    │   ├── init-database.sh              # 数据库初始化
    │   └── deploy-offline.sh             # 一键部署脚本
    └── docs/                              # 文档
        └── 离线部署方案.md                 # 详细部署方案
```

---

## ✅ 核心特性

### 1. 使用现有PostgreSQL
- ✅ 不启动容器内PostgreSQL
- ✅ 通过 `host.docker.internal` 连接宿主机数据库
- ✅ 支持全量数据迁移

### 2. 简化部署流程
- ✅ 一键构建脚本（Windows）
- ✅ 一键部署脚本（Linux）
- ✅ 自动化程度高，最小化手动配置

### 3. 完整的文档
- ✅ 需求文档
- ✅ 设计文档
- ✅ 技术方案
- ✅ 快速指南

---

## 🔧 技术栈

### 容器化
- Docker 20.10+
- Docker Compose 2.0+

### 服务组件
- Frontend: Nginx + Vue.js
- Backend: Python 3.12 + FastAPI
- Celery Worker: 异步任务处理
- Redis: 消息队列和缓存
- PostgreSQL: 数据库（使用现有实例）

---

## 📊 资源要求

### 部署包大小
- 压缩后: ~500MB
- 解压后: ~1.5GB

### 服务器要求
- **最低**: 4核CPU + 8GB内存 + 50GB磁盘
- **推荐**: 8核CPU + 16GB内存 + 100GB SSD

---

## 🎯 部署流程

### 源环境（Windows 11）
```
构建镜像 → 导出镜像 → 导出数据 → 打包
```

### 目标环境（Linux服务器）
```
解压 → 导入镜像 → 配置环境 → 导入数据 → 启动服务
```

---

## 📝 注意事项

### 1. 数据库连接
- 使用 `host.docker.internal` 连接宿主机PostgreSQL
- 或使用实际IP地址

### 2. 密钥生成
- JWT密钥和加密密钥必须重新生成
- 不要使用模板中的默认值

### 3. 端口配置
- 默认端口: 80（前端）、8000（后端）
- 可在 `.env` 文件中修改

### 4. 数据迁移
- 支持全量数据迁移
- 使用 pg_dump/restore
- 会清空现有数据

---

## 🆘 故障排查

### 常见问题

1. **Docker镜像构建失败**
   - 检查Docker Desktop是否运行
   - 检查网络连接
   - 检查磁盘空间

2. **容器无法启动**
   - 检查端口占用
   - 检查配置文件
   - 查看容器日志

3. **数据库连接失败**
   - 检查PostgreSQL是否运行
   - 检查DATABASE_URL配置
   - 检查防火墙规则

详细排查方法请参考 `离线部署方案.md` 第7章。

---

## 📚 相关文档

1. **需求文档.md** - 第6章：离线部署需求
2. **系统设计文档.md** - 第7章：离线部署架构设计
3. **离线部署方案.md** - 详细技术方案
4. **OFFLINE_DEPLOYMENT_GUIDE.md** - 快速部署指南

---

## ✨ 下一步

1. **测试构建脚本**
   ```powershell
   .\scripts\build-offline-package.ps1
   ```

2. **验证部署包**
   - 检查生成的tar.gz文件
   - 验证文件大小和完整性

3. **准备传输**
   - 将部署包传输到目标服务器
   - 准备数据库连接信息

4. **执行部署**
   - 按照快速指南执行部署
   - 验证系统功能

---

**所有文件已准备就绪，可以开始构建和部署！** 🎉
