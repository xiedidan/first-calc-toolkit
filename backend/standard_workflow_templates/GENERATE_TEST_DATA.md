# 智能测试数据生成工具

## 功能说明

这个 Python 脚本可以智能地生成测试数据，用于验证标准计算流程。它会：

1. ✅ 读取系统中实际的科室信息
2. ✅ 读取系统中实际的收费项目
3. ✅ 读取维度-收费项目映射关系
4. ✅ 生成符合业务逻辑的收费明细数据
5. ✅ 生成工作量统计数据（护理床日数、会诊等）
6. ✅ 自动创建外部数据源表（如果不存在）
7. ✅ 插入数据到外部数据源数据库

## 使用方法

### 基本用法

```bash
cd backend/standard_workflow_templates

# 生成测试数据
python generate_test_data.py --hospital-id 1 --period 2025-10
```

### 完整参数

```bash
python generate_test_data.py \
  --hospital-id 1 \
  --period 2025-10 \
  --record-count 100 \
  --patient-count 50 \
  --data-source-id 2 \
  --dry-run
```

### 参数说明

| 参数 | 必需 | 默认值 | 说明 |
|------|------|--------|------|
| `--hospital-id` | ✅ | - | 医疗机构ID |
| `--period` | ✅ | - | 统计周期（格式：YYYY-MM） |
| `--record-count` | ❌ | 100 | 生成的收费记录数量 |
| `--patient-count` | ❌ | 50 | 患者数量 |
| `--data-source-id` | ❌ | 默认数据源 | 外部数据源ID |
| `--dry-run` | ❌ | False | 预览模式，不实际插入数据 |

## 使用示例

### 示例 1：预览模式

先预览将要生成的数据，不实际插入：

```bash
python generate_test_data.py \
  --hospital-id 1 \
  --period 2025-10 \
  --dry-run
```

输出示例：
```
================================================================================
智能测试数据生成脚本
================================================================================
医疗机构ID: 1
统计周期: 2025-10
收费记录数: 100
患者数量: 50
模式: 预览模式 (不实际插入)
================================================================================

🔌 连接系统数据库...

📋 步骤 1/6: 读取科室信息
✅ 找到 15 个活跃科室
   - NK: 内科
   - WK: 外科
   - EK: 儿科
   ... 还有 12 个科室

📋 步骤 2/6: 读取收费项目
✅ 找到 50 个收费项目
   - ITEM001: 血常规 (25.0元)
   - ITEM002: 尿常规 (15.0元)
   ... 还有 45 个收费项目

⚠️  预览模式: 不实际插入数据

将生成:
  - 100 条收费记录
  - 120 条工作量统计
```

### 示例 2：生成少量测试数据

生成少量数据用于快速测试：

```bash
python generate_test_data.py \
  --hospital-id 1 \
  --period 2025-10 \
  --record-count 50 \
  --patient-count 20
```

### 示例 3：生成大量测试数据

生成大量数据用于性能测试：

```bash
python generate_test_data.py \
  --hospital-id 1 \
  --period 2025-10 \
  --record-count 10000 \
  --patient-count 1000
```

### 示例 4：指定数据源

如果有多个数据源，可以指定使用哪个：

```bash
python generate_test_data.py \
  --hospital-id 1 \
  --period 2025-10 \
  --data-source-id 2
```

## 生成的数据

### 1. 收费明细表 (charge_details)

| 字段 | 说明 | 生成逻辑 |
|------|------|---------|
| patient_id | 患者ID | 随机选择（P0001-P9999） |
| prescribing_dept_code | 开单科室代码 | 从系统科室表随机选择 |
| item_code | 收费项目编码 | 从系统收费项目表随机选择 |
| item_name | 收费项目名称 | 对应收费项目的名称 |
| amount | 金额 | 价格 × 数量 |
| quantity | 数量 | 80%为1，20%为2-5 |
| charge_time | 收费时间 | 在指定月份内随机生成 |

**特点**：
- 使用系统中实际的科室代码和收费项目
- 收费时间在工作时间内（8:00-18:00）
- 金额和数量符合实际业务逻辑

### 2. 工作量统计表 (workload_statistics)

| 字段 | 说明 | 生成逻辑 |
|------|------|---------|
| department_code | 科室代码 | 从系统科室表获取 |
| stat_month | 统计月份 | 使用指定的周期 |
| stat_type | 统计类型 | nursing_days（护理床日数）、consultation（会诊） |
| stat_level | 统计级别 | 一级护理、二级护理、三级护理、特级护理、发起、参与 |
| stat_value | 统计值 | 根据类型和级别随机生成合理的数值 |

**特点**：
- 为每个科室生成护理床日数（4个级别）
- 为每个科室生成会诊工作量（发起、参与）
- 数值范围符合实际业务场景

## 数据验证

脚本执行完成后会自动验证数据：

```
🔍 验证数据...

收费明细汇总:
  NK: 35 条记录, 15 个患者, 总金额 12500.00 元
  WK: 28 条记录, 12 个患者, 总金额 18900.00 元
  EK: 37 条记录, 18 个患者, 总金额 8750.00 元

工作量统计汇总:
  NK - nursing_days: 4 条记录, 总值 250.00
  NK - consultation: 2 条记录, 总值 40.00
  WK - nursing_days: 4 条记录, 总值 300.00
  WK - consultation: 2 条记录, 总值 50.00
```

## 注意事项

### 1. 前置条件

运行脚本前，请确保：

- ✅ 系统数据库中已有科室数据（departments 表）
- ✅ 系统数据库中已有收费项目数据（charge_items 表）
- ✅ 已配置外部数据源（在前端"数据源管理"页面）
- ✅ 外部数据源可以正常连接

### 2. 数据覆盖

脚本会**删除指定周期的旧数据**，然后插入新数据。例如：

- 如果指定 `--period 2025-10`
- 会删除 2025-10 月份的所有收费记录和工作量统计
- 然后插入新生成的数据

### 3. 表自动创建

如果外部数据源中不存在 `charge_details` 和 `workload_statistics` 表，脚本会自动创建。

### 4. 维度映射

如果系统中已配置维度-收费项目映射，生成的收费数据会更有针对性。如果没有配置映射，会生成随机的收费数据。

## 故障排除

### 问题 1：找不到科室

```
❌ 错误: 医疗机构 1 没有活跃的科室
```

**解决方法**：
1. 在前端"科室管理"页面导入科室数据
2. 确保科室的 `is_active` 字段为 `True`

### 问题 2：找不到收费项目

```
❌ 错误: 医疗机构 1 没有收费项目
```

**解决方法**：
1. 在前端"收费项目管理"页面导入收费项目
2. 或使用 SQL 直接插入测试数据

### 问题 3：数据源连接失败

```
❌ 错误: 没有找到默认数据源
```

**解决方法**：
1. 在前端"数据源管理"页面配置数据源
2. 设置一个数据源为默认数据源
3. 或使用 `--data-source-id` 参数指定数据源

### 问题 4：权限不足

```
❌ 错误: permission denied for table charge_details
```

**解决方法**：
1. 确保数据源配置的数据库用户有创建表和插入数据的权限
2. 或手动创建表后再运行脚本

## 完整工作流程

### 步骤 1：准备系统数据

```bash
# 1. 导入科室数据（在前端操作）
# 2. 导入收费项目（在前端操作）
# 3. 配置数据源（在前端操作）
```

### 步骤 2：生成测试数据

```bash
# 先预览
python generate_test_data.py --hospital-id 1 --period 2025-10 --dry-run

# 确认无误后执行
python generate_test_data.py --hospital-id 1 --period 2025-10
```

### 步骤 3：导入标准流程

```bash
# 导入标准计算流程
bash import_standard_workflow.sh --version-id 123
```

### 步骤 4：运行计算任务

```bash
# 在前端创建计算任务
# 1. 选择模型版本
# 2. 选择标准计算流程
# 3. 选择周期 2025-10
# 4. 选择科室（或不选择，批量模式）
# 5. 提交任务
```

### 步骤 5：查看结果

```bash
# 在前端查看
# 1. 任务执行状态
# 2. 步骤执行日志
# 3. 计算结果
```

## 高级用法

### 生成多个月份的数据

```bash
# 生成 2025 年 10-12 月的数据
for month in 10 11 12; do
  python generate_test_data.py \
    --hospital-id 1 \
    --period 2025-$month \
    --record-count 100
done
```

### 为多个医疗机构生成数据

```bash
# 为医疗机构 1 和 2 生成数据
for hospital_id in 1 2; do
  python generate_test_data.py \
    --hospital-id $hospital_id \
    --period 2025-10 \
    --record-count 100
done
```

## 相关文档

- [标准计算流程 README](README.md)
- [SQL 参数使用指南](../SQL_PARAMETERS_GUIDE.md)
- [测试修复文档](../test-hospital-id-fix.md)
