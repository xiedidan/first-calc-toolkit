# AI智能数据生成系统实现总结

## 项目概述

基于AI大模型的智能数据生成系统，能够根据医院特点和科室业务特征，自动生成符合实际业务逻辑的报表数据。

## 核心文件

### 1. 主程序文件

| 文件名 | 说明 | 功能 |
|--------|------|------|
| `populate_report_data_ai.py` | AI数据生成主程序 | 调用AI模型，智能生成报表数据 |
| `populate_report_data.py` | 原始数据生成程序 | 使用随机值生成数据（保留） |

### 2. 配置文件

| 文件名 | 说明 | 用途 |
|--------|------|------|
| `report_data_config.example.json` | 眼科医院配置示例 | 专科医院配置模板 |
| `report_data_config_comprehensive.example.json` | 综合医院配置示例 | 综合医院配置模板 |
| `ai_prompts.json` | AI提示词配置 | 定义AI的行为和输出格式 |

### 3. 工具脚本

| 文件名 | 说明 | 功能 |
|--------|------|------|
| `validate_config.py` | 配置文件验证工具 | 验证配置文件格式和完整性 |
| `test_ai_generation.py` | 功能测试脚本 | 测试各个功能模块 |
| `generate_ai_data.bat` | Windows批处理脚本 | 简化Windows用户操作 |

### 4. 文档文件

| 文件名 | 说明 | 内容 |
|--------|------|------|
| `AI_DATA_GENERATION_GUIDE.md` | 完整使用指南 | 详细的使用说明和配置指南 |
| `AI_DATA_GENERATION_QUICKSTART.md` | 快速开始指南 | 5分钟快速上手教程 |
| `AI_DATA_GENERATION_SUMMARY.md` | 实现总结文档 | 本文档 |

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户输入                              │
│  - 医院信息（类型、特色、背景）                              │
│  - 总工作量数据（各项指标总量）                              │
│  - 科室信息（业务特点、约束条件）                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   AI数据生成器                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  步骤1: AI分配科室工作量                             │   │
│  │  - 根据医院特点分配各科室比例                        │   │
│  │  - 确保符合医院业务特点                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                      │                                       │
│                      ▼                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  步骤2: AI分配维度工作量                             │   │
│  │  - 对每个科室分配各维度工作量                        │   │
│  │  - 确保符合科室业务特点                              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据处理层                                 │
│  - 计算价值（工作量 × 权重）                                │
│  - 计算占比（维度价值 / 同级总价值）                        │
│  - 汇总序列价值                                              │
│  - 生成汇总表数据                                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据库存储                                 │
│  - calculation_task（计算任务）                              │
│  - calculation_result（计算结果）                            │
│  - calculation_summary（汇总数据）                           │
└─────────────────────────────────────────────────────────────┘
```

## 核心功能实现

### 1. AI数据生成器 (AIDataGenerator)

```python
class AIDataGenerator:
    def __init__(self, api_key, model, base_url, prompts_file):
        # 初始化AI客户端和加载提示词
        
    def call_ai(self, system_prompt, user_prompt):
        # 调用OpenAI API
        
    def allocate_departments(self, config):
        # AI分配各科室工作量比例
        
    def allocate_dimensions(self, dept_config, dept_allocation, dimensions, total_workload):
        # AI分配科室内各维度工作量
```

### 2. 科室工作量分配

**输入：**
- 医院信息（类型、特色、背景）
- 总工作量数据
- 科室列表

**AI处理：**
- 根据医院特点分析各科室应占比例
- 考虑科室类别和业务特点
- 确保符合医疗业务逻辑

**输出：**
```json
{
  "allocations": [
    {
      "his_code": "01",
      "his_name": "白内障科",
      "workload_based_ratio": 35.0,
      "consultation_ratio": 20.0,
      "mdt_ratio": 15.0,
      "case_ratio": 40.0,
      "nursing_bed_days_ratio": 0.0,
      "surgery_ratio": 0.0,
      "observation_ratio": 0.0,
      "reasoning": "白内障科是眼科主要专科，工作量占比最大"
    }
  ]
}
```

### 3. 维度工作量分配

**输入：**
- 科室信息（业务特点、约束条件）
- 科室总工作量
- 维度树形结构

**AI处理：**
- 根据科室业务特点分配各维度工作量
- 严格遵守业务约束
- 合理分配父子维度比例

**输出：**
```json
{
  "allocations": [
    {
      "dimension_code": "D001",
      "dimension_name": "门诊诊察",
      "parent_code": null,
      "workload": 50000,
      "ratio_in_parent": 50.0,
      "reasoning": "门诊是医生专科主要工作"
    }
  ]
}
```

### 4. 价值和占比计算

```python
# 价值计算
value = workload × weight

# 占比计算
ratio = (dimension_value / parent_total_value) × 100%

# 序列汇总
sequence_value = sum(child_dimension_values)
```

## 业务规则

### 科室类别规则

| 科室类别 | 主要维度 | 禁止维度 |
|---------|---------|---------|
| 医生专科 | 门诊、住院、治疗手术、会诊、MDT、病案 | 护理操作、手术台次、医技项目 |
| 护理病区 | 床日护理、护理操作 | 医生诊疗、手术台次、医技项目 |
| 护理非病区（手术室） | 手术室护理 | 医生诊疗、床日护理、医技项目 |
| 护理非病区（留观室） | 留观护理 | 医生诊疗、床日护理、手术台次、医技项目 |
| 医技科室 | 对应医技项目 | 医生诊疗、护理操作、手术台次 |
| 行政后勤 | 行政管理、后勤保障 | 医生诊疗、护理操作、手术台次、医技项目 |

### 医院类型规则

**专科医院：**
- 专科相关科室工作量占80%以上
- 手术集中在专科手术室
- 护理集中在专科病区

**综合医院：**
- 各科室工作量相对均衡
- 内科、外科、妇产科等主要科室工作量较大
- 医技科室根据检查需求分配

## 配置文件结构

### 医院信息 (hospital_info)

```json
{
  "name": "医院名称",
  "type": "医院类型",
  "specialty": "专科类型",
  "description": "医院描述",
  "characteristics": ["特点1", "特点2"]
}
```

### 总工作量 (total_workload)

```json
{
  "workload_based_total": {
    "value": 1000000,
    "description": "工作量总额",
    "note": "分配备注"
  },
  "consultation_total": {...},
  "mdt_total": {...},
  "case_total": {...},
  "nursing_bed_days_total": {...},
  "surgery_total": {...},
  "observation_total": {...}
}
```

### 科室信息 (departments)

```json
{
  "his_code": "01",
  "his_name": "科室名称",
  "category": "科室类别",
  "business_characteristics": "业务特点",
  "constraints": ["约束1", "约束2"]
}
```

## 提示词设计

### 1. 科室分配提示词

**系统提示词：**
- 定义AI角色：医院业务数据分析专家
- 强调专业性和准确性

**用户提示词：**
- 提供医院信息和特点
- 提供总工作量数据
- 提供科室列表
- 明确分配要求和业务规则
- 指定输出格式（JSON）

### 2. 维度分配提示词

**系统提示词：**
- 定义AI角色：医院业务数据分析专家
- 强调对科室业务的理解

**用户提示词：**
- 提供科室信息和约束
- 提供科室总工作量
- 提供维度树形结构
- 明确分配要求和业务约束
- 指定输出格式（JSON）

### 3. 验证提示词（预留）

用于验证生成数据的合理性和一致性。

## 使用流程

### 1. 准备阶段

```bash
# 安装依赖
pip install openai

# 设置API密钥
set OPENAI_API_KEY=your_key

# 准备配置文件
copy report_data_config.example.json my_config.json
```

### 2. 验证阶段

```bash
# 验证配置文件
python validate_config.py my_config.json
```

### 3. 生成阶段

```bash
# 生成数据
python populate_report_data_ai.py --config my_config.json --period 2025-10

# 或使用批处理脚本
generate_ai_data.bat my_config.json 2025-10
```

### 4. 验证阶段

```bash
# 启动后端服务
cd backend
uvicorn app.main:app --reload

# 访问前端页面查看数据
```

## 测试方案

### 1. 单元测试

```bash
python test_ai_generation.py
```

测试内容：
- 配置文件加载
- 数据库连接
- 工作量计算
- 价值计算
- 提示词模板
- 科室匹配

### 2. 集成测试

使用示例配置文件生成数据，验证：
- AI调用是否成功
- 数据是否符合业务规则
- 计算结果是否正确
- 数据库存储是否正常

### 3. 业务验证

检查生成的数据：
- 科室工作量分配是否合理
- 维度工作量分配是否符合科室特点
- 价值和占比计算是否正确
- 汇总数据是否准确

## 优势与特点

### 1. 智能化

- ✅ AI自动分析医院和科室特点
- ✅ 自动生成符合业务逻辑的数据
- ✅ 减少人工配置工作量

### 2. 灵活性

- ✅ 支持多种医院类型（专科、综合）
- ✅ 支持自定义科室和维度
- ✅ 支持自定义提示词

### 3. 准确性

- ✅ 严格遵守业务规则
- ✅ 考虑科室业务特点
- ✅ 确保数据一致性

### 4. 可扩展性

- ✅ 易于添加新的医院类型
- ✅ 易于添加新的业务规则
- ✅ 易于集成其他AI模型

## 注意事项

### 1. API成本

- GPT-3.5-turbo：约$0.18/20科室
- GPT-4：约$4.80/20科室
- 建议测试用3.5，生产用4

### 2. 数据质量

- 配置文件质量直接影响生成结果
- 建议详细描述医院和科室特点
- 建议明确业务约束条件

### 3. 网络要求

- 需要稳定的网络连接
- 需要能访问OpenAI API
- 可使用代理或自定义端点

### 4. 数据验证

- 生成后务必检查数据合理性
- 建议与历史数据对比
- 必要时手工调整

## 未来改进方向

### 1. 功能增强

- [ ] 添加数据验证功能
- [ ] 支持多轮对话优化
- [ ] 支持历史数据学习
- [ ] 支持批量生成多个周期

### 2. 性能优化

- [ ] 实现结果缓存
- [ ] 支持异步API调用
- [ ] 支持批量处理科室
- [ ] 优化提示词长度

### 3. 用户体验

- [ ] 添加Web界面
- [ ] 提供可视化配置工具
- [ ] 实时显示生成进度
- [ ] 提供数据预览功能

### 4. 模型支持

- [ ] 支持更多AI模型
- [ ] 支持本地模型
- [ ] 支持模型切换
- [ ] 支持模型微调

## 总结

AI智能数据生成系统成功实现了以下目标：

1. ✅ **智能分配**：根据医院和科室特点，AI自动分配工作量
2. ✅ **业务合规**：严格遵守医疗业务规则和约束条件
3. ✅ **灵活配置**：支持多种医院类型和科室配置
4. ✅ **易于使用**：提供完整的文档和工具脚本
5. ✅ **可扩展性**：易于添加新功能和支持新场景

该系统大幅提升了测试数据生成的效率和质量，为系统测试和演示提供了强有力的支持。

## 相关文档

- [完整使用指南](AI_DATA_GENERATION_GUIDE.md)
- [快速开始指南](AI_DATA_GENERATION_QUICKSTART.md)
- [原始数据生成指南](POPULATE_REPORT_DATA_GUIDE.md)

## 技术支持

如有问题或建议，请：
1. 查看文档中的故障排除部分
2. 运行测试脚本诊断问题
3. 检查配置文件格式
4. 联系技术支持团队
