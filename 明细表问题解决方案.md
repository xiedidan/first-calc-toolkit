# 明细表没有数据问题 - 已解决

## 问题原因

明细表查询逻辑：
1. 从 `calculation_results` 表查询序列节点
2. 对每个序列，递归查找子维度（`parent_id == 序列node_id`）
3. 构建树形结构显示

**问题：** Step1/2 只插入了叶子维度节点，没有插入中间层级的维度节点（如"门诊"、"住院"、"病区"等），导致：
- 维度根节点不在 `calculation_results` 表中
- 明细表查询时找不到序列的子维度
- 树形结构无法构建，明细表为空

## 数据结构对比

### 修复前（错误）
```
序列节点（有）
  └─ 维度根节点（缺失！）← parent_id 应该指向序列
      └─ 二级维度（缺失！）
          └─ 叶子维度（有）← Step1/2 只插入了这一层
```

### 修复后（正确）
```
序列节点（有）✅
  └─ 维度根节点（有）✅ parent_id 指向序列
      └─ 二级维度（有）✅
          └─ 叶子维度（有）✅
```

## 解决方案

修改 Step3，让它插入**所有非叶子节点**（包括序列节点和所有中间层级的维度节点）。

### 修改内容

**原来的 Step3（错误）：**
```sql
WHERE ms.node_type = 'sequence'  -- 只插入序列节点
```

**修改后的 Step3（正确）：**
```sql
WHERE agg.score > 0  -- 插入所有有价值的节点
  AND agg.node_id NOT IN (
      -- 排除已经存在的叶子维度节点（Step1/2已插入）
      SELECT node_id 
      FROM calculation_results 
      WHERE task_id = '{task_id}'
  );
```

## 已执行的操作

1. ✅ 修改了 `backend/standard_workflow_templates/step3_value_aggregation.sql`
2. ✅ 更新了数据库中 workflow_id=20 的 Step3
3. ✅ 为任务 `124694a7-3f17-4ff3-831e-5e7efb6febe2` 补充了所有中间层级节点

## 验证结果

### 数据统计
```
node_type | count
------------------------------
dimension | 1143  (原来 846 + 新增 297)
sequence  | 66
```

### 维度根节点验证
```
node_id | node_name | parent_id (序列) | value
------------------------------------------------
6       | 门诊      | 1 (医生)         | 6700.0000
18      | 住院      | 1 (医生)         | 6700.0000
30      | 病区      | 29 (护理)        | 202581.8000
32      | 非病区    | 29 (护理)        | 590621.8000
```

✅ 维度根节点已正确插入，`parent_id` 指向序列节点

## 数据流程（完整）

```
Step1: 维度目录统计
  └─> 插入叶子维度节点到 calculation_results
       (node_type = 'dimension', workload > 0)

Step2: 指标计算
  └─> 插入更多叶子维度节点到 calculation_results
       (node_type = 'dimension', workload > 0)

Step3: 业务价值汇总
  └─> 从 calculation_results 读取叶子维度数据
  └─> 递归汇总到所有祖先节点（中间维度 + 序列）
  └─> 插入所有非叶子节点到 calculation_results
       (node_type = 'dimension' 或 'sequence', workload = 0)

报表查询:
  汇总表:
    └─> 从 calculation_results 读取序列节点
    └─> 递归汇总子维度
    └─> 按科室和序列类型显示
  
  明细表:
    └─> 从 calculation_results 读取序列节点
    └─> 递归查找子维度（parent_id 关联）
    └─> 构建完整的树形结构显示
```

## 后续任务

对于新的计算任务，正常执行 Step1 → Step2 → Step3，报表（汇总表和明细表）都能正常显示数据。

对于已有的旧任务，运行 `补充序列数据.py` 脚本即可补充所有缺失的节点数据。
