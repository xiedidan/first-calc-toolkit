# 医院科室业务价值评估工具 - 系统设计文档 V1.0

> **文档状态**: 草稿
> **创建日期**: 2025-10-20
> **版本**: 1.0

---

## 1. 设计概述

### 1.1. 设计原则
本系统设计遵循以下核心原则：
-   **高内聚，低耦合**：各模块功能明确，模块间通过定义良好的接口进行通信，减少相互依赖。
-   **可扩展性**：系统设计应易于扩展新的计算逻辑、维度类型或报表格式。
-   **可维护性**：代码结构清晰，文档齐全，便于后续维护和升级。
-   **安全性**：严格的数据权限控制，确保数据安全。

### 1.2. 技术栈选型
-   **前端**: Vue.js 3 + Element Plus (提供丰富的表格和表单组件，适合管理后台风格)
-   **后端**: Python 3.12 + FastAPI (高性能、现代化的Web框架，自带API文档)
-   **数据库**: PostgreSQL 16 (强大的关系型数据库，支持复杂查询)
-   **任务队列**: Celery + Redis (处理异步计算和报表生成任务)
-   **缓存**: Redis (缓存热点数据，提高查询性能)

---

## 2. 系统总体架构

系统采用前后端分离的微服务化架构，主要划分为以下几个核心模块：

```mermaid
graph TB
    subgraph "前端层"
        A[Vue.js 应用]
    end

    subgraph "API网关层"
        B[Nginx / API Gateway]
    end

    subgraph "后端服务层"
        C[用户与权限服务]
        D[模型管理服务]
        E[科室管理服务]
        F[计算引擎服务]
        G[结果与报表服务]
    end

    subgraph "数据层"
        H[(PostgreSQL)]
        I[(Redis)]
    end

    subgraph "任务队列"
        J[Celery Worker]
    end

    A --> B
    B --> C
    B --> D
    B --> E
    B --> F
    B --> G
    F --> J
    C --> H
    D --> H
    E --> H
    F --> H
    G --> H
    J --> H
    J --> I
    G --> J
```

### 2.1. 模块职责划分

| 模块 | 职责 | 核心功能 |
|---|---|---|
| **用户与权限服务** | 管理用户、角色及权限 | 用户登录、RBAC权限控制、数据权限隔离 |
| **模型管理服务** | 管理评估模型的所有相关数据 | 模型版本CRUD、树状结构CRUD、维度目录管理、SQL/Python脚本管理、模型规则展示 |
| **收费项目管理服务** | 管理HIS系统的收费项目目录 | 收费项目增删查改、批量导入导出、分类管理 |
| **科室管理服务** | 管理科室信息及评估范围 | 科室增删查改、科室对照关系维护、评估范围启用/禁用 |
| **计算引擎服务** | 执行业务价值计算任务 | 任务调度、任务取消、SQL/Python执行、结果计算与存储 |
| **结果与报表服务** | 提供结果查询、展示和导出 | 结果查询、在线展示、Excel报表生成与下载 |

---

## 3. 详细模块设计

### 3.1. 用户与权限服务 (Auth Service)

#### 3.1.1. 功能设计
-   **登录认证**: 提供用户名/密码登录接口，返回JWT Token。
-   **角色管理**: 支持增删改查角色，并为角色分配菜单权限（按钮级权限控制）。
-   **用户管理**: 支持增删改查用户，并为用户分配角色。
-   **数据权限**: 在用户登录后，根据其角色动态生成数据权限SQL（如 `WHERE kdksid IN ('ks001', 'ks002')`），并在所有数据查询接口中应用。

#### 3.1.2. 接口说明
用户与权限服务的详细API接口设计请参考《API设计文档》第2章。

### 3.2. 模型管理服务 (Model Service)

#### 3.2.1. 功能设计
-   **模型版本管理**: 独立的模型版本CRUD，支持复制、设为活动版本。
-   **模型结构管理**: 提供类似Excel的表格化编辑界面，支持多层级节点的增删改。
-   **维度目录管理**: 提供维度目录的收费项目配置界面，支持搜索、批量导入导出。
-   **维度目录智能导入**: 提供三步式导入流程，将手工制作的维度目录Excel文件智能转换为系统可用的维度-收费项目映射关系。
    -   第一步：字段映射 - 用户指定Excel列与系统字段的对应关系
    -   第二步：维度值映射 - 用户为维度预案和专家意见的唯一值指定对应的系统维度
    -   第三步：预览与确认 - 展示导入结果预览，用户确认后执行批量导入
-   **规则管理**: 为所有节点提供规则字段录入（在节点编辑对话框中），并提供独立的模型规则展示页面，以树形结构展示所有节点的规则说明。
-   **重要变更**: 代码管理功能已迁移到计算流程管理服务，模型节点不再包含代码字段。

#### 3.2.2. 接口说明
模型管理服务的详细API接口设计请参考《API设计文档》第3章。

### 3.2.5. 计算流程管理服务 (Calculation Workflow Service) - 新增

#### 3.2.5.1. 功能设计
-   **计算流程管理**: 支持创建、编辑、删除、复制计算流程，每个流程关联到特定的模型版本。
-   **计算步骤管理**: 支持在流程中创建、编辑、删除计算步骤，支持步骤顺序调整（上移/下移）。
-   **代码编辑器**: 为计算步骤提供SQL/Python代码编辑器，支持语法高亮、占位符替换。
-   **代码测试**: 提供代码测试功能，允许用户指定测试参数并执行代码，查看返回结果。
-   **数据迁移**: 提供数据迁移工具，将现有模型节点中的代码迁移到计算流程中。

#### 3.2.5.2. 核心实体

**计算流程 (CalculationWorkflow)**
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | INTEGER | 主键 |
| version_id | INTEGER | 关联的模型版本ID |
| name | VARCHAR(200) | 流程名称 |
| description | TEXT | 流程描述 |
| is_active | BOOLEAN | 是否启用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

**计算步骤 (CalculationStep)**
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | INTEGER | 主键 |
| workflow_id | INTEGER | 关联的计算流程ID |
| name | VARCHAR(200) | 步骤名称 |
| description | TEXT | 步骤描述 |
| code_type | VARCHAR(20) | 代码类型(python/sql) |
| code_content | TEXT | 代码内容 |
| sort_order | NUMERIC(10,2) | 执行顺序 |
| is_enabled | BOOLEAN | 是否启用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 3.2.5.3. 接口说明
计算流程管理服务的详细API接口设计请参考《API设计文档》第8章。

### 3.3. 收费项目管理服务 (Charge Item Service)

#### 3.3.1. 功能设计
-   **收费项目列表展示**: 以表格形式展示所有收费项目信息。
-   **收费项目增删查改**: 支持收费项目信息的完整增删查改操作。
-   **分类管理**: 支持按分类筛选和管理收费项目。
-   **批量导入**: 支持从Excel批量导入收费项目数据。
    -   **异步导入**: 使用 Celery 处理大数据量导入（> 1000 条），避免请求超时
    -   **实时进度**: 前端轮询任务状态，显示导入进度（已处理/总数）
    -   **格式限制**: 仅支持 `.xlsx` 格式（Excel 2007+）
    -   **字段映射**: 支持灵活的 Excel 列与系统字段映射
    -   **数据验证**: 导入前验证必填字段、唯一性约束等
    -   **失败处理**: 记录失败行及原因，支持部分成功导入
-   **批量导出**: 支持将收费项目数据导出为Excel文件。
-   **搜索功能**: 支持按项目编码、名称、分类进行模糊搜索。
-   **模板下载**: 提供标准导入模板下载，包含示例数据和字段说明。

#### 3.3.2. 异步导入架构

异步导入使用 Celery + Redis 实现，支持大数据量导入和实时进度显示：

**工作流程：**
1. 前端上传 Excel 文件到 API 服务
2. API 服务提交异步任务到 Celery，立即返回 task_id
3. Celery Worker 在后台执行导入，定期更新进度到 Redis
4. 前端每秒轮询任务状态，显示实时进度
5. 导入完成后，返回成功/失败统计和失败记录详情

**技术优势：**
- 避免 HTTP 请求超时（支持导入数万条数据）
- 实时进度反馈，提升用户体验
- 失败不影响已成功的数据
- 支持并发导入多个文件

#### 3.3.3. 接口说明
收费项目管理服务的详细API接口设计请参考《API设计文档》第4章。

### 3.4. 科室管理服务 (Dept Service)

#### 3.4.1. 功能设计
-   **科室列表展示**: 以表格形式展示所有科室的对照信息。
-   **科室增删查改**: 支持科室信息的完整增删查改操作。
-   **对照关系编辑**: 支持在线编辑成本中心、核算单元等信息。
-   **评估范围控制**: 提供开关，控制科室是否参与计算。

#### 3.4.2. 接口说明
科室管理服务的详细API接口设计请参考《API设计文档》第5章。

### 3.4.5. 数据源管理服务 (Data Source Service) - 新增

#### 3.4.5.1. 功能设计
-   **数据源配置管理**: 支持创建、编辑、删除SQL数据源配置。
-   **连接测试**: 提供数据源连接测试功能，验证配置的正确性。
-   **连接池管理**: 为每个启用的数据源维护独立的连接池。
-   **密码加密**: 使用AES-256算法加密存储数据库密码。
-   **默认数据源**: 支持设置默认数据源，用于未指定数据源的SQL执行。
-   **状态监控**: 监控数据源连接状态和连接池使用情况。

#### 3.4.5.2. 核心实体

**数据源配置 (DataSource)**
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | INTEGER | 主键 |
| name | VARCHAR(100) | 数据源名称 |
| db_type | VARCHAR(20) | 数据库类型 |
| host | VARCHAR(255) | 主机地址 |
| port | INTEGER | 端口号 |
| database_name | VARCHAR(100) | 数据库名称 |
| username | VARCHAR(100) | 用户名 |
| password | TEXT | 加密密码 |
| schema_name | VARCHAR(100) | Schema名称 |
| connection_params | JSONB | 连接参数 |
| is_default | BOOLEAN | 是否默认 |
| is_enabled | BOOLEAN | 是否启用 |
| description | TEXT | 描述 |
| pool_size_min | INTEGER | 最小连接数 |
| pool_size_max | INTEGER | 最大连接数 |
| pool_timeout | INTEGER | 连接超时 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 3.4.5.3. 连接池管理

**连接池策略**：
-   系统启动时，为所有启用的数据源创建连接池
-   连接池使用SQLAlchemy的连接池机制
-   支持配置最小连接数、最大连接数、连接超时时间
-   自动回收超时的空闲连接
-   提供连接池状态监控接口

**连接池配置**：
```python
{
    "pool_size": 10,          # 连接池大小
    "max_overflow": 20,       # 最大溢出连接数
    "pool_timeout": 30,       # 获取连接超时时间(秒)
    "pool_recycle": 3600,     # 连接回收时间(秒)
    "pool_pre_ping": True     # 连接前测试
}
```

#### 3.4.5.4. 安全机制

**密码加密**：
-   使用Python的`cryptography`库实现AES-256加密
-   加密密钥存储在环境变量中，不写入代码
-   密码在存储前加密，读取后解密
-   API响应中密码字段脱敏显示

**权限控制**：
-   数据源配置的增删改需要系统管理员权限
-   普通用户只能查看数据源列表（密码脱敏）
-   连接测试功能需要管理员权限

#### 3.4.5.5. 接口说明
数据源管理服务的详细API接口设计请参考《API设计文档》第9章。

### 3.5. 计算引擎服务 (Calculation Service)

#### 3.5.1. 功能设计
-   **任务创建**: 接收前端发起的计算请求，创建计算任务并放入队列。
-   **任务执行**: Celery Worker从队列中获取任务，根据计算流程和科室范围执行计算。
-   **任务取消**: 支持取消正在运行或排队的计算任务，释放资源。
-   **逻辑处理**: 
    -   **重要变更**: 不再从模型节点读取代码，改为执行计算流程中的步骤
    -   按sort_order顺序执行计算流程中的所有启用步骤
    -   对每个步骤，替换代码中的占位符（如{current_year_month}、{department_id}等）
    -   执行代码并记录结果和日志
    -   如果步骤执行失败，停止后续步骤并记录错误
    -   所有步骤执行完成后，根据模型结构和权重计算最终得分
-   **结果存储**: 将计算过程的中间结果、步骤执行日志和最终结果存入数据库。
-   **向后兼容**: 在过渡期间，如果任务未指定计算流程ID，系统尝试使用节点中的代码执行（兼容模式）。

#### 3.5.2. 接口说明
计算引擎服务的详细API接口设计请参考《API设计文档》第6章。

### 3.6. 结果与报表服务 (Result Service)

#### 3.6.1. 功能设计
-   **结果查询**: 提供多维度筛选（时间、模型、科室）的结果查询接口。
-   **在线展示**: 将查询结果格式化为前端需要的结构，用于业务价值结构表和汇总表的展示。
-   **报表生成**: 接收导出请求，生成异步任务，生成Excel文件并提供下载链接。

#### 3.6.2. 接口说明
结果与报表服务的详细API接口设计请参考《API设计文档》第7章。

---

## 4. 数据库设计

### 4.1. 核心表结构设计

#### 4.1.1. 用户与权限
-   `users`: 用户表
-   `roles`: 角色表
-   `user_roles`: 用户角色关联表
-   `permissions`: 权限表
-   `role_permissions`: 角色权限关联表

#### 4.1.2. 模型管理
-   `model_versions`: 模型版本表
-   `model_nodes`: 模型节点表 (存储树状结构，script字段保留但不再使用)
-   `dimension_item_mappings`: 维度-收费项目映射表

#### 4.1.3. 计算流程管理 (新增)
-   `calculation_workflows`: 计算流程表
-   `calculation_steps`: 计算步骤表

#### 4.1.4. 收费项目管理
-   `charge_items`: 收费项目表

#### 4.1.5. 计算与结果
-   `calculation_tasks`: 计算任务表 (新增workflow_id字段)
-   `calculation_step_logs`: 计算步骤执行日志表 (新增)
-   `calculation_results`: 计算结果明细表
-   `calculation_summaries`: 计算结果汇总表

#### 4.1.5. 系统配置
-   `system_settings`: 系统设置表 (如当期年月)
-   `departments`: 科室信息扩展表 (存储是否参与评估等状态)
-   `data_sources`: SQL数据源配置表 (新增)

### 4.2. 关键表字段设计

##### `charge_items` (收费项目表)
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| item_code | VARCHAR(100) | 收费项目编码 (唯一) |
| item_name | VARCHAR(255) | 收费项目名称 |
| item_category | VARCHAR(100) | 收费项目分类 |
| unit_price | VARCHAR(50) | 单价 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

##### `model_nodes` (模型节点表)
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| version_id | INT | 模型版本ID (外键) |
| parent_id | INT | 父节点ID (外键, 自关联) |
| name | VARCHAR(255) | 节点名称 |
| code | VARCHAR(100) | 节点编码 |
| node_type | VARCHAR(50) | 节点类型 (sequence/dimension) |
| calc_type | VARCHAR(50) | 算法类型 (statistical=指标/calculational=目录) |
| weight | NUMERIC(10, 4) | 权重/单价 |
| business_guide | TEXT | 业务导向 |
| script | TEXT | SQL/Python脚本（已废弃，保留用于数据迁移） |
| rule | TEXT | 规则说明（自然语言描述，用于规则展示页面） |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

##### `calculation_workflows` (计算流程表) - 新增
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| version_id | INT | 模型版本ID (外键) |
| name | VARCHAR(200) | 流程名称 |
| description | TEXT | 流程描述 |
| is_active | BOOLEAN | 是否启用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

##### `calculation_steps` (计算步骤表) - 新增
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| workflow_id | INT | 计算流程ID (外键) |
| name | VARCHAR(200) | 步骤名称 |
| description | TEXT | 步骤描述 |
| code_type | VARCHAR(20) | 代码类型 (python/sql) |
| code_content | TEXT | 代码内容 |
| data_source_id | INT | 数据源ID (外键，可选，仅SQL类型需要) |
| sort_order | NUMERIC(10, 2) | 执行顺序 |
| is_enabled | BOOLEAN | 是否启用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

**注意事项**：
- 当 `code_type='sql'` 时，`data_source_id` 指定执行SQL的目标数据源
- 如果 `data_source_id` 为空，使用系统默认数据源
- 当 `code_type='python'` 时，`data_source_id` 可以为空

##### `calculation_step_logs` (计算步骤执行日志表) - 新增
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| task_id | VARCHAR(100) | 计算任务ID |
| step_id | INT | 计算步骤ID (外键) |
| department_id | INT | 科室ID |
| status | VARCHAR(20) | 执行状态 (success/failed) |
| start_time | TIMESTAMP | 开始时间 |
| end_time | TIMESTAMP | 结束时间 |
| duration_ms | INT | 执行耗时(毫秒) |
| result_data | JSONB | 执行结果数据 |
| error_message | TEXT | 错误信息 |
| created_at | TIMESTAMP | 创建时间 |

##### `dimension_item_mappings` (维度-收费项目映射表)
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| dimension_id | INT | 维度节点ID (外键) |
| item_code | VARCHAR(100) | 收费项目编码 |
| created_at | TIMESTAMP | 创建时间 |

##### `data_sources` (SQL数据源配置表) - 新增
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| name | VARCHAR(100) | 数据源名称 (唯一) |
| db_type | VARCHAR(20) | 数据库类型 (postgresql/mysql/sqlserver/oracle) |
| host | VARCHAR(255) | 主机地址 |
| port | INTEGER | 端口号 |
| database_name | VARCHAR(100) | 数据库名称 |
| username | VARCHAR(100) | 用户名 |
| password | TEXT | 密码 (加密存储) |
| schema_name | VARCHAR(100) | Schema名称 (可选) |
| connection_params | JSONB | 额外连接参数 (可选) |
| is_default | BOOLEAN | 是否默认数据源 |
| is_enabled | BOOLEAN | 是否启用 |
| description | TEXT | 描述 |
| pool_size_min | INTEGER | 连接池最小连接数 (默认2) |
| pool_size_max | INTEGER | 连接池最大连接数 (默认10) |
| pool_timeout | INTEGER | 连接超时时间(秒) (默认30) |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

**注意事项**：
- `password` 字段使用AES-256加密存储
- 系统启动时自动为每个启用的数据源创建连接池
- 只能有一个数据源标记为 `is_default=true`
- `db_type` 支持的值：postgresql, mysql, sqlserver, oracle

---

## 5. UI原型设计

### 5.1. 整体布局
采用经典的后台管理布局：
-   **顶部导航栏**: Logo、面包屑导航、用户信息下拉菜单。
-   **左侧菜单栏**: 根据用户权限动态生成的功能菜单。
-   **主内容区**: 展示各功能页面。

### 5.2. 关键页面原型

#### 5.2.1. 登录页
-   居中登录表单。
-   用户名、密码输入框。
-   登录按钮。

#### 5.2.2. 模型管理 - 模型列表页
-   页面标题: "评估模型管理"
-   操作按钮: "新建版本"
-   表格:
    -   列: 版本号、版本名称、创建时间、是否活动、操作
    -   操作列: "设为活动"、"编辑结构"、"复制"、"删除"
-   分页组件。

#### 5.2.3. 模型管理 - 结构编辑页
-   页面标题: "编辑模型结构 - [版本名称]"
-   左侧: 类似Excel的表格，展示模型树状结构。
    -   列: 节点名称、节点编码、节点类型、算法类型、权重/单价、业务导向、操作
    -   支持行内编辑和新增/删除行。
-   右侧 (或下方): 节点详情编辑面板。
    -   当选中“计算型”维度时，显示代码编辑器和“测试运行”按钮。
    -   当选中“统计型”维度时，显示代码编辑器、“测试运行”按钮、“配置收费项目”按钮。

#### 5.2.4. 模型管理 - 维度目录配置页 (弹窗/新页)
-   页面标题: "配置维度目录 - [维度名称]"
-   上方: 搜索框，用于搜索收费项目。
-   中间: 已关联的收费项目列表，支持删除。
-   下方: 搜索结果列表，支持添加。
-   操作按钮: "导入目录"、"导出目录"。

#### 5.2.5. 收费项目管理页
-   页面标题: "收费项目管理"
-   操作按钮: "新建项目"、"批量导入"、"导出"
-   表格:
    -   列: 项目编码、项目名称、项目分类、单价、创建时间、操作
    -   操作列: "编辑"、"删除"
-   支持按项目编码、名称、分类搜索。
-   支持按分类筛选。

#### 5.2.6. 科室管理页
-   页面标题: "科室管理"
-   操作按钮: "新建科室"
-   表格:
    -   列: HIS科室代码、HIS科室名称、成本中心代码、成本中心名称、核算单元代码、核算单元名称、是否参与评估、操作
    -   "是否参与评估"列: 使用Switch开关组件。
    -   操作列: "编辑"、"删除"
-   支持按科室名称搜索。

#### 5.2.7. 计算流程管理页 - 新增
-   页面标题: "计算流程管理"
-   操作按钮: "新建流程"
-   表格:
    -   列: 流程名称、关联模型版本、步骤数量、是否启用、创建时间、操作
    -   操作列: "查看步骤"、"编辑"、"复制"、"删除"
-   分页组件

#### 5.2.8. 计算步骤管理页 - 新增
-   页面标题: "计算步骤管理 - [流程名称]"
-   操作按钮: "新建步骤"、"返回流程列表"
-   表格:
    -   列: 步骤名称、代码类型、执行顺序、是否启用、操作
    -   操作列: "编辑"、"测试"、"上移"、"下移"、"删除"
-   支持拖拽排序

#### 5.2.9. 计算步骤编辑对话框 - 新增
-   对话框标题: "编辑计算步骤"
-   表单字段:
    -   步骤名称（必填）
    -   步骤描述（可选）
    -   代码类型（必填，单选：Python/SQL）
    -   代码编辑器（必填，支持语法高亮）
    -   是否启用（开关）
-   操作按钮: "测试运行"、"保存"、"取消"
-   测试运行区域:
    -   测试参数输入（科室ID、年月等）
    -   执行结果显示
    -   错误信息显示

#### 5.2.10. 计算任务页
-   页面标题: "计算任务"
-   操作区:
    -   下拉选择: "模型版本"
    -   下拉选择: "计算流程"（根据选择的模型版本动态加载）
    -   下拉选择: "科室范围" (全部科室/指定科室)
    -   按钮: "开始计算"
-   表格:
    -   列: 任务ID、模型版本、计算流程、计算周期、状态、创建时间、完成时间、操作
    -   状态列: 使用Tag组件显示 (排队中/运行中/已完成/失败)
    -   操作列: "查看日志"、"查看步骤日志"、"取消"、"重试" (失败时)

#### 5.2.11. 结果查询页 - 汇总视图
-   页面标题: "业务价值汇总"
-   筛选区:
    -   下拉选择: "评估月份"（默认选择当期年月）
    -   下拉选择: "模型版本"（默认选择激活版本）
-   表格:
    -   列: 科室、医生价值、医生占比、护理价值、护理占比、医技价值、医技占比、科室总价值...
    -   第一行: "全院汇总"
-   操作按钮: "导出业务价值汇总Excel"、"导出科室结构Excel"

#### 5.2.12. 结果查询页 - 明细视图
-   点击汇总表的某一行“科室”进入。
-   页面标题: "[科室名称] - 业务价值结构表"
-   Tab页: "医生序列"、"护理序列"、"医技序列"、"业务价值汇总"
-   每个Tab内是一个可折叠的表格（默认全部展开），结构与Excel模板一致。
-   操作按钮: "导出Excel"

---

## 6. 部署架构

### 6.1. 部署方案
采用docker-compose单机部署方案，一键拉起所有服务和应用，简化部署流程，提高系统可维护性。

### 6.2. Docker Compose架构
系统包含以下容器：
-   **nginx**: 前端静态文件服务和API反向代理
-   **frontend**: Vue.js前端应用容器
-   **backend**: Python FastAPI后端服务容器
-   **celery-worker**: Celery异步任务处理容器
-   **postgres**: PostgreSQL数据库容器
-   **redis**: Redis缓存和消息队列容器

### 6.3. 部署流程
1.  准备部署环境，安装Docker和Docker Compose
2.  克隆项目代码，配置环境变量
3.  执行 `docker-compose up -d` 一键启动所有服务
4.  通过 `docker-compose logs -f` 查看服务日志
5.  通过 `docker-compose down` 停止所有服务

### 6.4. Docker Compose配置示例
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: hospital_value
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    
  backend:
    build: ./backend
    environment:
      DATABASE_URL: postgresql://admin:password@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - postgres
      - redis
    ports:
      - "8000:8000"
    
  celery-worker:
    build: ./backend
    command: celery -A app.celery worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://admin:password@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - postgres
      - redis
    
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

---

## 7. 附录

### 7.1. 待定事项
-   Excel报表生成的具体技术选型 (如 `openpyxl` 或 `xlsxwriter`)。
-   大数据量下的计算性能优化策略 (如分科室并行计算)。

### 7.2. 风险与应对
-   **风险**: 复杂SQL或Python脚本执行可能存在性能瓶颈或安全风险。
-   **应对**: 对脚本执行进行超时限制和资源隔离；对SQL进行语法分析，禁止危险操作。


---

## 7. 重要架构变更说明 (V1.1)

### 7.1. 变更概述
本版本对系统进行了重大架构调整，主要目的是将代码逻辑从模型结构中分离，提高系统的灵活性和可维护性。

### 7.2. 核心变更

#### 7.2.1. 新增计算流程管理服务
-   新增 `calculation_workflows` 和 `calculation_steps` 两个核心表
-   提供独立的计算流程和步骤管理功能
-   支持代码编辑、测试、版本管理

#### 7.2.2. 模型结构简化
-   `model_nodes` 表的 `script` 字段标记为已废弃
-   模型节点不再包含代码逻辑，专注于业务价值的组织结构
-   前端界面移除模型节点的代码编辑功能

#### 7.2.3. 计算引擎调整
-   计算任务执行时，从计算流程中读取步骤并执行
-   新增步骤执行日志表 `calculation_step_logs`
-   支持步骤级别的错误追踪和性能分析

### 7.3. 数据迁移策略

#### 7.3.1. 迁移工具
系统提供数据迁移工具，将现有模型节点中的代码迁移到计算流程中：
1. 为每个模型版本创建默认计算流程
2. 遍历所有包含代码的节点，创建对应的计算步骤
3. 保持步骤的执行顺序与节点的层级顺序一致
4. 生成迁移报告，记录成功和失败的记录

#### 7.3.2. 迁移时机
-   建议在系统升级时立即执行数据迁移
-   迁移前应备份数据库
-   迁移后应在测试环境验证计算结果的一致性

### 7.4. 向后兼容性

#### 7.4.1. 兼容模式
-   过渡期间，系统支持兼容模式
-   如果计算任务未指定计算流程ID，系统尝试使用节点中的代码执行
-   兼容模式可通过系统配置启用/禁用

#### 7.4.2. API兼容性
-   模型节点相关API继续支持读取 `script` 字段（标记为已弃用）
-   新增计算流程管理相关API
-   计算任务创建API新增 `workflow_id` 参数（可选）

### 7.5. 性能优化

#### 7.5.1. 步骤级别的并行执行（未来优化）
-   当前版本按顺序执行步骤
-   未来可以支持标记独立步骤，实现并行执行
-   提高大规模计算的性能

#### 7.5.2. 步骤结果缓存（未来优化）
-   对于相同参数的步骤，可以缓存执行结果
-   减少重复计算，提高响应速度

### 7.6. 安全性增强

#### 7.6.1. 代码执行隔离
-   计算步骤的代码在隔离环境中执行
-   限制代码的资源访问权限
-   设置执行超时和资源限制

#### 7.6.2. 代码审计
-   记录所有代码的修改历史
-   支持代码审计和回滚
-   提供代码安全检查工具（未来功能）

### 7.7. 升级路径

#### 7.7.1. 升级步骤
1. 备份数据库
2. 部署新版本代码
3. 执行数据库迁移脚本（添加新表）
4. 执行数据迁移工具（迁移节点代码到计算流程）
5. 在测试环境验证计算结果
6. 在生产环境执行升级
7. 监控系统运行状态
8. 完成迁移后，禁用兼容模式

#### 7.7.2. 回滚方案
-   如果升级失败，可以回滚到旧版本
-   数据迁移工具支持回滚操作
-   回滚后，系统继续使用节点中的代码执行计算

### 7.8. 未来规划

#### 7.8.1. 可视化流程编排
-   提供拖拽式的流程编排界面
-   支持条件分支和循环
-   支持步骤间的数据传递

#### 7.8.2. 代码模板库
-   提供常用代码模板
-   支持代码片段的复用
-   支持团队内的代码共享

#### 7.8.3. AI辅助编码
-   提供AI代码补全
-   提供代码优化建议
-   提供代码错误检测
