# 医院科室业务价值评估工具 - 系统设计文档 V1.0

> **文档状态**: 草稿
> **创建日期**: 2025-10-20
> **版本**: 1.0

---

## 1. 设计概述

### 1.1. 设计原则
本系统设计遵循以下核心原则：
-   **高内聚，低耦合**：各模块功能明确，模块间通过定义良好的接口进行通信，减少相互依赖。
-   **可扩展性**：系统设计应易于扩展新的计算逻辑、维度类型或报表格式。
-   **可维护性**：代码结构清晰，文档齐全，便于后续维护和升级。
-   **安全性**：严格的数据权限控制，确保数据安全。

### 1.2. 技术栈选型
-   **前端**: Vue.js 3 + Element Plus (提供丰富的表格和表单组件，适合管理后台风格)
-   **后端**: Python 3.12 + FastAPI (高性能、现代化的Web框架，自带API文档)
-   **数据库**: PostgreSQL 16 (强大的关系型数据库，支持复杂查询)
-   **任务队列**: Celery + Redis (处理异步计算和报表生成任务)
-   **缓存**: Redis (缓存热点数据，提高查询性能)

---

## 2. 系统总体架构

系统采用前后端分离的微服务化架构，主要划分为以下几个核心模块：

```mermaid
graph TB
    subgraph "前端层"
        A[Vue.js 应用]
    end

    subgraph "API网关层"
        B[Nginx / API Gateway]
    end

    subgraph "后端服务层"
        C[用户与权限服务]
        D[模型管理服务]
        E[科室管理服务]
        F[计算引擎服务]
        G[结果与报表服务]
    end

    subgraph "数据层"
        H[(PostgreSQL)]
        I[(Redis)]
    end

    subgraph "任务队列"
        J[Celery Worker]
    end

    A --> B
    B --> C
    B --> D
    B --> E
    B --> F
    B --> G
    F --> J
    C --> H
    D --> H
    E --> H
    F --> H
    G --> H
    J --> H
    J --> I
    G --> J
```

### 2.1. 模块职责划分

| 模块 | 职责 | 核心功能 |
|---|---|---|
| **用户与权限服务** | 管理用户、角色及权限 | 用户登录、RBAC权限控制、数据权限隔离 |
| **模型管理服务** | 管理评估模型的所有相关数据 | 模型版本CRUD、树状结构CRUD、维度目录管理、SQL/Python脚本管理 |
| **科室管理服务** | 管理科室信息及评估范围 | 科室增删查改、科室对照关系维护、评估范围启用/禁用 |
| **计算引擎服务** | 执行业务价值计算任务 | 任务调度、任务取消、SQL/Python执行、结果计算与存储 |
| **结果与报表服务** | 提供结果查询、展示和导出 | 结果查询、在线展示、Excel报表生成与下载 |

---

## 3. 详细模块设计

### 3.1. 用户与权限服务 (Auth Service)

#### 3.1.1. 功能设计
-   **登录认证**: 提供用户名/密码登录接口，返回JWT Token。
-   **角色管理**: 支持增删改查角色，并为角色分配菜单权限（按钮级权限控制）。
-   **用户管理**: 支持增删改查用户，并为用户分配角色。
-   **数据权限**: 在用户登录后，根据其角色动态生成数据权限SQL（如 `WHERE kdksid IN ('ks001', 'ks002')`），并在所有数据查询接口中应用。

#### 3.1.2. 接口说明
用户与权限服务的详细API接口设计请参考《API设计文档》第2章。

### 3.2. 模型管理服务 (Model Service)

#### 3.2.1. 功能设计
-   **模型版本管理**: 独立的模型版本CRUD，支持复制、设为活动版本。
-   **模型结构管理**: 提供类似Excel的表格化编辑界面，支持多层级节点的增删改。
-   **维度目录管理**: 提供维度目录的收费项目配置界面，支持搜索、批量导入导出。
-   **代码管理**: 为末级维度（即维度叶子节点）提供SQL/Python代码编辑器和测试运行功能。

#### 3.2.2. 接口说明
模型管理服务的详细API接口设计请参考《API设计文档》第3章。

### 3.3. 科室管理服务 (Dept Service)

#### 3.3.1. 功能设计
-   **科室列表展示**: 以表格形式展示所有科室的对照信息。
-   **科室增删查改**: 支持科室信息的完整增删查改操作。
-   **对照关系编辑**: 支持在线编辑成本中心、核算单元等信息。
-   **评估范围控制**: 提供开关，控制科室是否参与计算。

#### 3.3.2. 接口说明
科室管理服务的详细API接口设计请参考《API设计文档》第4章。

### 3.4. 计算引擎服务 (Calculation Service)

#### 3.4.1. 功能设计
-   **任务创建**: 接收前端发起的计算请求，创建计算任务并放入队列。
-   **任务执行**: Celery Worker从队列中获取任务，根据模型版本和科室范围执行计算。
-   **任务取消**: 支持取消正在运行或排队的计算任务，释放资源。
-   **逻辑处理**: 按模型定义计算各维度工作量，并根据权重加权，根据模型层次结构进行累计，计算各子维度比例等。
-   **结果存储**: 将计算过程的中间结果和最终结果存入数据库。

#### 3.4.2. 接口说明
计算引擎服务的详细API接口设计请参考《API设计文档》第5章。

### 3.5. 结果与报表服务 (Result Service)

#### 3.5.1. 功能设计
-   **结果查询**: 提供多维度筛选（时间、模型、科室）的结果查询接口。
-   **在线展示**: 将查询结果格式化为前端需要的结构，用于业务价值结构表和汇总表的展示。
-   **报表生成**: 接收导出请求，生成异步任务，生成Excel文件并提供下载链接。

#### 3.5.2. 接口说明
结果与报表服务的详细API接口设计请参考《API设计文档》第6章。

---

## 4. 数据库设计

### 4.1. 核心表结构设计

#### 4.1.1. 用户与权限
-   `users`: 用户表
-   `roles`: 角色表
-   `user_roles`: 用户角色关联表
-   `permissions`: 权限表
-   `role_permissions`: 角色权限关联表

#### 4.1.2. 模型管理
-   `model_versions`: 模型版本表
-   `model_nodes`: 模型节点表 (存储树状结构)
-   `dimension_item_mapping`: 维度-收费项目映射表

#### 4.1.3. 计算与结果
-   `calculation_tasks`: 计算任务表
-   `calculation_results`: 计算结果明细表
-   `calculation_summaries`: 计算结果汇总表

#### 4.1.4. 系统配置
-   `system_settings`: 系统设置表 (如当期年月)
-   `departments`: 科室信息扩展表 (存储是否参与评估等状态)

### 4.2. 关键表字段设计

##### `model_nodes` (模型节点表)
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| version_id | INT | 模型版本ID (外键) |
| parent_id | INT | 父节点ID (外键, 自关联) |
| name | VARCHAR(255) | 节点名称 |
| code | VARCHAR(100) | 节点编码 |
| node_type | VARCHAR(50) | 节点类型 (sequence/dimension) |
| calc_type | VARCHAR(50) | 计算类型 (statistical/calculational) |
| weight | NUMERIC(10, 4) | 权重/单价 |
| business_guide | TEXT | 业务导向 |
| script | TEXT | SQL/Python脚本 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

##### `dimension_item_mapping` (维度-收费项目映射表)
| 字段名 | 类型 | 描述 |
|---|---|---|
| id | SERIAL | 主键 |
| dimension_id | INT | 维度节点ID (外键) |
| item_code | VARCHAR(100) | 收费项目编码 |
| created_at | TIMESTAMP | 创建时间 |

---

## 5. UI原型设计

### 5.1. 整体布局
采用经典的后台管理布局：
-   **顶部导航栏**: Logo、面包屑导航、用户信息下拉菜单。
-   **左侧菜单栏**: 根据用户权限动态生成的功能菜单。
-   **主内容区**: 展示各功能页面。

### 5.2. 关键页面原型

#### 5.2.1. 登录页
-   居中登录表单。
-   用户名、密码输入框。
-   登录按钮。

#### 5.2.2. 模型管理 - 模型列表页
-   页面标题: "评估模型管理"
-   操作按钮: "新建版本"
-   表格:
    -   列: 版本号、版本名称、创建时间、是否活动、操作
    -   操作列: "设为活动"、"编辑结构"、"复制"、"删除"
-   分页组件。

#### 5.2.3. 模型管理 - 结构编辑页
-   页面标题: "编辑模型结构 - [版本名称]"
-   左侧: 类似Excel的表格，展示模型树状结构。
    -   列: 节点名称、节点编码、节点类型、计算类型、权重/单价、业务导向、操作
    -   支持行内编辑和新增/删除行。
-   右侧 (或下方): 节点详情编辑面板。
    -   当选中“计算型”维度时，显示代码编辑器和“测试运行”按钮。
    -   当选中“统计型”维度时，显示代码编辑器、“测试运行”按钮、“配置收费项目”按钮。

#### 5.2.4. 模型管理 - 维度目录配置页 (弹窗/新页)
-   页面标题: "配置维度目录 - [维度名称]"
-   上方: 搜索框，用于搜索收费项目。
-   中间: 已关联的收费项目列表，支持删除。
-   下方: 搜索结果列表，支持添加。
-   操作按钮: "导入目录"、"导出目录"。

#### 5.2.5. 科室管理页
-   页面标题: "科室管理"
-   操作按钮: "新建科室"
-   表格:
    -   列: HIS科室代码、HIS科室名称、成本中心代码、成本中心名称、核算单元代码、核算单元名称、是否参与评估、操作
    -   "是否参与评估"列: 使用Switch开关组件。
    -   操作列: "编辑"、"删除"
-   支持按科室名称搜索。

#### 5.2.6. 计算任务页
-   页面标题: "计算任务"
-   操作区:
    -   下拉选择: "模型版本"
    -   下拉选择: "科室范围" (全部科室/指定科室)
    -   按钮: "开始计算"
-   表格:
    -   列: 任务ID、模型版本、计算周期、状态、创建时间、完成时间、操作
    -   状态列: 使用Tag组件显示 (排队中/运行中/已完成/失败)
    -   操作列: "查看日志"、"取消"、"重试" (失败时)

#### 5.2.7. 结果查询页 - 汇总视图
-   页面标题: "业务价值汇总"
-   筛选区:
    -   下拉选择: "评估月份"（默认选择当期年月）
    -   下拉选择: "模型版本"（默认选择激活版本）
-   表格:
    -   列: 科室、医生价值、医生占比、护理价值、护理占比、医技价值、医技占比、科室总价值...
    -   第一行: "全院汇总"
-   操作按钮: "导出业务价值汇总Excel"、"导出科室结构Excel"

#### 5.2.8. 结果查询页 - 明细视图
-   点击汇总表的某一行“科室”进入。
-   页面标题: "[科室名称] - 业务价值结构表"
-   Tab页: "医生序列"、"护理序列"、"医技序列"、"业务价值汇总"
-   每个Tab内是一个可折叠的表格（默认全部展开），结构与Excel模板一致。
-   操作按钮: "导出Excel"

---

## 6. 部署架构

### 6.1. 部署方案
采用docker-compose单机部署方案，一键拉起所有服务和应用，简化部署流程，提高系统可维护性。

### 6.2. Docker Compose架构
系统包含以下容器：
-   **nginx**: 前端静态文件服务和API反向代理
-   **frontend**: Vue.js前端应用容器
-   **backend**: Python FastAPI后端服务容器
-   **celery-worker**: Celery异步任务处理容器
-   **postgres**: PostgreSQL数据库容器
-   **redis**: Redis缓存和消息队列容器

### 6.3. 部署流程
1.  准备部署环境，安装Docker和Docker Compose
2.  克隆项目代码，配置环境变量
3.  执行 `docker-compose up -d` 一键启动所有服务
4.  通过 `docker-compose logs -f` 查看服务日志
5.  通过 `docker-compose down` 停止所有服务

### 6.4. Docker Compose配置示例
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: hospital_value
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    
  backend:
    build: ./backend
    environment:
      DATABASE_URL: postgresql://admin:password@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - postgres
      - redis
    ports:
      - "8000:8000"
    
  celery-worker:
    build: ./backend
    command: celery -A app.celery worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://admin:password@postgres:5432/hospital_value
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - postgres
      - redis
    
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

---

## 7. 附录

### 7.1. 待定事项
-   Excel报表生成的具体技术选型 (如 `openpyxl` 或 `xlsxwriter`)。
-   大数据量下的计算性能优化策略 (如分科室并行计算)。

### 7.2. 风险与应对
-   **风险**: 复杂SQL或Python脚本执行可能存在性能瓶颈或安全风险。
-   **应对**: 对脚本执行进行超时限制和资源隔离；对SQL进行语法分析，禁止危险操作。