# 维度Code迁移 - 执行检查清单

## 📋 迁移前准备

### 1. 备份数据库 ⚠️ 重要！
- [ ] 备份 PostgreSQL 数据库
  ```bash
  pg_dump -U postgres -d performance_system > backup_before_migration.sql
  ```
- [ ] 确认备份文件完整性
- [ ] 记录备份时间和位置

### 2. 确认环境
- [ ] 后端服务正常运行
- [ ] 前端服务正常运行
- [ ] 数据库连接正常
- [ ] Conda环境已激活

### 3. 代码检查
- [ ] 所有代码已提交到Git
- [ ] 当前分支是正确的开发分支
- [ ] 没有未保存的更改

## 🚀 执行迁移

### 步骤1：停止服务
- [ ] 停止后端服务（Ctrl+C）
- [ ] 停止前端服务（Ctrl+C）
- [ ] 停止Celery服务（如果在运行）

### 步骤2：执行数据库迁移
- [ ] 运行迁移脚本
  ```bash
  execute-dimension-migration.bat
  ```
  或手动执行：
  ```bash
  cd backend
  conda activate performance_system
  alembic upgrade head
  ```

### 步骤3：验证迁移
- [ ] 运行测试脚本
  ```bash
  cd backend
  python test_dimension_code_migration.py
  ```
- [ ] 检查测试结果，确保所有测试通过

### 步骤4：重启服务
- [ ] 启动后端服务
  ```bash
  cd backend
  conda activate performance_system
  python -m uvicorn app.main:app --reload
  ```
- [ ] 启动前端服务
  ```bash
  cd frontend
  npm run dev
  ```
- [ ] 检查服务启动日志，确保没有错误

## 🧪 功能测试

### 基础功能测试
- [ ] 登录系统
- [ ] 访问维度目录页面
- [ ] 选择一个维度，查看其收费项目
- [ ] 搜索收费项目
- [ ] 添加收费项目到维度
- [ ] 更新收费项目的维度
- [ ] 删除维度关联
- [ ] 查看孤儿记录
- [ ] 清除孤儿记录

### 智能导入测试
- [ ] 打开智能导入对话框
- [ ] 上传测试Excel文件
- [ ] 配置字段映射
- [ ] 提取唯一值
- [ ] 配置维度值映射
- [ ] 生成预览
- [ ] 执行导入
- [ ] 验证导入结果

### 多维度测试
- [ ] 选择多个维度查询
- [ ] 验证查询结果正确
- [ ] 测试维度切换

### 边界情况测试
- [ ] 测试空维度（没有收费项目）
- [ ] 测试大量数据（如果有）
- [ ] 测试特殊字符的维度编码

## ✅ 验证标准

### 数据完整性
- [ ] 所有原有的映射关系都存在
- [ ] dimension_code 字段都有值
- [ ] 所有 dimension_code 都能找到对应的 ModelNode
- [ ] 没有孤儿的 dimension_code

### 功能正确性
- [ ] 所有查询功能正常
- [ ] 所有创建功能正常
- [ ] 所有更新功能正常
- [ ] 所有删除功能正常
- [ ] 智能导入功能正常

### 性能检查
- [ ] 查询速度正常（与迁移前相当）
- [ ] 没有明显的性能下降
- [ ] 索引正常工作

## 🔄 回滚方案（如果需要）

### 何时需要回滚
- 数据迁移失败
- 功能测试发现严重问题
- 性能严重下降
- 数据完整性问题

### 回滚步骤
1. [ ] 停止所有服务
2. [ ] 运行回滚脚本
   ```bash
   rollback-dimension-migration.bat
   ```
3. [ ] 验证回滚结果
4. [ ] 重启服务
5. [ ] 测试基本功能
6. [ ] 如果回滚失败，从备份恢复数据库

## 📊 迁移报告

### 迁移信息
- 迁移开始时间: _______________
- 迁移结束时间: _______________
- 迁移耗时: _______________
- 执行人: _______________

### 数据统计
- 迁移前记录数: _______________
- 迁移后记录数: _______________
- 失败记录数: _______________

### 测试结果
- 基础功能测试: [ ] 通过 [ ] 失败
- 智能导入测试: [ ] 通过 [ ] 失败
- 性能测试: [ ] 通过 [ ] 失败

### 问题记录
```
记录迁移过程中遇到的问题和解决方案：

1. 

2. 

3. 

```

### 最终状态
- [ ] ✅ 迁移成功，系统正常运行
- [ ] ⚠️  迁移成功，但有小问题需要修复
- [ ] ❌ 迁移失败，已回滚
- [ ] ❌ 迁移失败，从备份恢复

## 📝 注意事项

1. **备份是最重要的**：确保在迁移前有完整的数据库备份
2. **测试要充分**：不要跳过任何测试步骤
3. **记录问题**：遇到问题及时记录，便于后续分析
4. **保持冷静**：如果出现问题，不要慌张，按照回滚方案操作
5. **通知团队**：迁移前后及时通知相关人员

## 🎯 成功标准

迁移被认为成功，当且仅当：
1. ✅ 所有测试通过
2. ✅ 数据完整性验证通过
3. ✅ 功能正常工作
4. ✅ 性能没有明显下降
5. ✅ 没有数据丢失

---

**检查清单版本**: 1.0
**最后更新**: 2025-10-27
