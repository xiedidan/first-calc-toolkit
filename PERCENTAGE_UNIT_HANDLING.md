# 百分比单位处理说明

## 📌 需求
当单位是 `%` 时，前端展示时需要将值乘以100，其他单位保持原值。后端始终按原始值存储。

## ✅ 实现方案

### 数据存储规则（后端）
- **百分比单位**: 存储小数值（如 0.655 表示 65.5%）
- **其他单位**: 存储实际值（如 5000 表示 5000元/例）

### 前端显示规则
- **百分比单位**: 显示值 = 存储值 × 100（如 0.655 → 65.50%）
- **其他单位**: 显示值 = 存储值（如 5000 → 5000.00元/例）

### 前端编辑规则
- **百分比单位**: 用户输入百分比数值（如输入 65.5 表示 65.5%），保存时除以100
- **其他单位**: 用户输入实际值（如输入 5000），保存时不变

## 🔄 数据转换流程

### 场景1: 创建百分比单位的节点
```
用户输入: 65.5 (单位: %)
↓
前端保存: 65.5 ÷ 100 = 0.655
↓
后端存储: 0.655
↓
前端显示: 0.655 × 100 = 65.50%
```

### 场景2: 创建其他单位的节点
```
用户输入: 5000 (单位: 元/例)
↓
前端保存: 5000 (不变)
↓
后端存储: 5000
↓
前端显示: 5000.00 元/例
```

### 场景3: 编辑百分比单位的节点
```
后端返回: 0.655 (单位: %)
↓
前端编辑: 0.655 × 100 = 65.5 (显示在输入框)
↓
用户修改: 70.0
↓
前端保存: 70.0 ÷ 100 = 0.7
↓
后端存储: 0.7
↓
前端显示: 0.7 × 100 = 70.00%
```

## 💻 代码实现

### 1. 格式化显示函数
```typescript
// 格式化权重显示（百分比单位乘以100）
const formatWeight = (weight: number | undefined, unit: string | undefined): string => {
  if (weight === undefined || weight === null) return '-'
  const unitValue = unit || '%'
  // 如果单位是百分比，将值乘以100显示
  const displayValue = unitValue === '%' ? weight * 100 : weight
  return Number(displayValue).toFixed(2)
}
```

### 2. 编辑时转换函数
```typescript
// 转换权重值用于编辑（百分比单位乘以100）
const convertWeightForEdit = (weight: number | undefined, unit: string | undefined): number | undefined => {
  if (weight === undefined || weight === null) return undefined
  const unitValue = unit || '%'
  // 如果单位是百分比，将显示值乘以100
  return unitValue === '%' ? weight * 100 : weight
}
```

### 3. 保存时转换函数
```typescript
// 转换权重值用于保存（百分比单位除以100）
const convertWeightForSave = (weight: number | undefined, unit: string | undefined): number | undefined => {
  if (weight === undefined || weight === null) return undefined
  const unitValue = unit || '%'
  // 如果单位是百分比，将输入值除以100保存
  return unitValue === '%' ? weight / 100 : weight
}
```

### 4. 列表显示
```vue
<el-table-column label="权重/单价" width="130" align="center">
  <template #default="{ row }">
    <span v-if="row.is_leaf && row.weight">
      {{ formatWeight(row.weight, row.unit) }} {{ row.unit || '%' }}
    </span>
    <span v-else>-</span>
  </template>
</el-table-column>
```

### 5. 表单编辑
```vue
<el-form-item label="权重/单价" prop="weight">
  <el-input-number 
    v-model="form.weight" 
    :precision="4"
    :step="0.01"
    :min="0"
    style="width: 100%"
    :placeholder="form.unit === '%' ? '如: 65.5 (表示65.5%)' : '如: 5000'"
  />
  <el-text v-if="form.unit === '%'" type="info" size="small" style="margin-top: 4px">
    百分比单位请直接输入数值，如输入 65.5 表示 65.5%
  </el-text>
</el-form-item>
```

## 📊 示例对照表

| 场景 | 用户输入 | 单位 | 后端存储 | 前端显示 |
|-----|---------|------|---------|---------|
| 门诊人次占比 | 65.5 | % | 0.655 | 65.50 % |
| 手术成功率 | 98.5 | % | 0.985 | 98.50 % |
| 平均住院费用 | 5000 | 元/例 | 5000 | 5000.00 元/例 |
| 人均药品费用 | 150.5 | 元/人天 | 150.5 | 150.50 元/人天 |
| 平均住院天数 | 7.5 | 天 | 7.5 | 7.50 天 |
| 门诊人次 | 1000 | 次 | 1000 | 1000.00 次 |

## 🎯 用户体验

### 百分比单位
- **输入提示**: "如: 65.5 (表示65.5%)"
- **帮助文本**: "百分比单位请直接输入数值，如输入 65.5 表示 65.5%"
- **显示格式**: "65.50 %"

### 其他单位
- **输入提示**: "如: 5000"
- **显示格式**: "5000.00 元/例"

## ⚠️ 注意事项

1. **数据一致性**
   - 后端始终存储原始值（百分比为小数）
   - 前端负责显示转换
   - 确保编辑时正确转换

2. **精度处理**
   - 显示时保留2位小数
   - 输入时支持4位小数
   - 避免浮点数精度问题

3. **单位判断**
   - 严格判断单位是否为 `%`
   - 默认单位为 `%`
   - 单位变更时需要注意数据转换

4. **向后兼容**
   - 已存在的数据需要检查是否符合新规则
   - 如果之前按百分比存储（如65.5），需要迁移数据

## 🔍 测试场景

### 测试1: 创建百分比节点
1. 创建节点，单位选择 `%`
2. 输入权重 `65.5`
3. 保存后查看列表显示 `65.50 %`
4. 编辑该节点，输入框显示 `65.5`

### 测试2: 创建其他单位节点
1. 创建节点，单位输入 `元/例`
2. 输入权重 `5000`
3. 保存后查看列表显示 `5000.00 元/例`
4. 编辑该节点，输入框显示 `5000`

### 测试3: 修改单位
1. 编辑一个百分比节点（如 65.5%）
2. 将单位改为 `元/例`
3. 注意：权重值需要重新输入（因为含义变了）

### 测试4: 边界值
- 输入 `0` → 显示 `0.00 %`
- 输入 `100` → 显示 `100.00 %`
- 输入 `0.01` → 显示 `0.01 %`
- 输入 `99.99` → 显示 `99.99 %`

## 📝 更新日志

**2025-10-23**
- ✅ 实现百分比单位的特殊处理
- ✅ 添加格式化显示函数
- ✅ 添加编辑和保存转换函数
- ✅ 更新表单提示文本
- ✅ 编写处理说明文档
