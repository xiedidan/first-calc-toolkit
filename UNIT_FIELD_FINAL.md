# 单位字段功能 - 最终说明

## ✅ 已完成

为模型节点添加了单位字段，支持自定义单位，并对百分比单位做了特殊处理。

## 🎯 核心功能

### 1. 单位字段
- **默认值**: `%`
- **可自定义**: 用户可输入任何单位（如 `元/例`、`元/人天`、`次`、`天` 等）
- **最大长度**: 20个字符
- **适用范围**: 仅末级维度节点

### 2. 百分比单位特殊处理 ⭐

#### 数据存储（后端）
- 百分比以**小数形式**存储
- 例如：65.5% 存储为 0.655

#### 前端显示
- 自动**乘以100**显示
- 例如：0.655 显示为 65.50%

#### 前端编辑
- 用户输入百分比数值（如 65.5）
- 保存时自动**除以100**
- 提示文本："百分比单位请直接输入数值，如输入 65.5 表示 65.5%"

#### 其他单位
- 不做任何转换
- 直接存储和显示原值

## 📊 使用示例

### 示例1: 百分比指标
```
用户操作: 创建节点 "门诊人次占比"
输入权重: 65.5
选择单位: %

后端存储: 0.655
列表显示: 65.50 %
编辑时显示: 65.5
```

### 示例2: 金额指标
```
用户操作: 创建节点 "平均住院费用"
输入权重: 5000
选择单位: 元/例

后端存储: 5000
列表显示: 5000.00 元/例
编辑时显示: 5000
```

### 示例3: 时间指标
```
用户操作: 创建节点 "平均住院天数"
输入权重: 7.5
选择单位: 天

后端存储: 7.5
列表显示: 7.50 天
编辑时显示: 7.5
```

## 📋 数据对照表

| 指标名称 | 用户输入 | 单位 | 后端存储 | 前端显示 |
|---------|---------|------|---------|---------|
| 门诊人次占比 | 65.5 | % | 0.655 | 65.50 % |
| 手术成功率 | 98.5 | % | 0.985 | 98.50 % |
| 平均住院费用 | 5000 | 元/例 | 5000 | 5000.00 元/例 |
| 人均药品费用 | 150.5 | 元/人天 | 150.5 | 150.50 元/人天 |
| 平均住院天数 | 7.5 | 天 | 7.5 | 7.50 天 |
| 门诊人次 | 1000 | 次 | 1000 | 1000.00 次 |

## 🚀 快速开始

### 1. 执行数据库迁移（首次使用）
```bash
.\migrate-simple.bat
```

### 2. 在界面中使用

#### 创建百分比指标
1. 进入"模型管理" -> 选择版本 -> 节点管理
2. 创建末级维度节点
3. 输入权重：`65.5`
4. 单位保持默认：`%`
5. 保存后显示：`65.50 %`

#### 创建其他单位指标
1. 创建末级维度节点
2. 输入权重：`5000`
3. 修改单位：`元/例`
4. 保存后显示：`5000.00 元/例`

## 🔍 测试验证

### 自动化测试
```bash
cd backend

# 测试单位字段基本功能
python test_unit_field.py

# 测试百分比单位处理
python test_percentage_unit.py
```

### 手动测试
1. 创建一个百分比单位的节点（输入 65.5）
2. 保存后查看列表显示是否为 65.50%
3. 编辑该节点，输入框是否显示 65.5
4. 修改为 70，保存后是否显示 70.00%

## 💡 注意事项

### 1. 百分比单位
- ✅ 用户输入百分比数值（如 65.5 表示 65.5%）
- ✅ 后端自动存储为小数（0.655）
- ✅ 前端自动显示为百分比（65.50%）
- ⚠️ 不要输入小数值（如 0.655），应该输入 65.5

### 2. 其他单位
- ✅ 直接输入实际值
- ✅ 后端和前端使用相同的值
- ✅ 显示时保留2位小数

### 3. 单位变更
- ⚠️ 如果修改节点的单位类型（如从 % 改为 元/例）
- ⚠️ 需要重新输入权重值（因为含义完全不同）

### 4. 数据精度
- 显示时：保留2位小数
- 输入时：支持4位小数
- 存储时：使用 Numeric(10, 4)

## 📚 相关文档

- **完整功能说明**: `MODEL_UNIT_FIELD.md`
- **百分比处理详解**: `PERCENTAGE_UNIT_HANDLING.md`
- **功能总结**: `UNIT_FIELD_SUMMARY.md`
- **验证清单**: `UNIT_FIELD_CHECKLIST.md`
- **快速开始**: `UNIT_FIELD_QUICKSTART.md`

## 📁 涉及的文件

### 后端
- `backend/app/models/model_node.py` - 数据模型
- `backend/app/schemas/model_node.py` - Schema定义
- `backend/alembic/versions/i3j4k5l6m7n8_add_unit_to_model_nodes.py` - 数据库迁移

### 前端
- `frontend/src/views/ModelNodes.vue` - 界面和逻辑
- `frontend/src/api/model.ts` - API类型定义

### 测试
- `backend/test_unit_field.py` - 单位字段测试
- `backend/test_percentage_unit.py` - 百分比处理测试

## ✨ 总结

✅ **功能完整**: 单位字段已完全实现，包括百分比的特殊处理
✅ **用户友好**: 百分比输入直观，其他单位简单明了
✅ **数据准确**: 后端存储规范，前端显示正确
✅ **文档齐全**: 提供完整的使用说明和测试脚本

**可以直接使用，无需额外开发！** 🎉
